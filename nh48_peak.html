<!doctype html> 
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NH48 Peak Details (Enhanced with Metadata)</title>
    <!--
      Standalone details view for a single NH48 peak with robust error handling.
      This version mirrors the styling of the original peak page but adds
      diagnostic output, multiple API fallbacks and a dynamic metadata panel
      beneath the photo carousel.  Each photo’s EXIF-derived metadata from
      `nh48.json` is displayed in a dark panel with dotted separators when
      the corresponding slide is active.  A circular countdown timer
      indicates time remaining until the next automatic slide change.  The
      carousel duration has been doubled for a more relaxed viewing pace.
    -->
    <style>
      :root{
        --bg:#0a0a0a;
        --panel:#12121a;
        --card:#171a22;
        --ink:#ffffff;
        --muted:#a5b4c3;
        --stroke:#ffffff33;
        --accent:#22c55e;
      }
      body{
        margin:0;
        background:var(--bg);
        color:var(--ink);
        font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        -webkit-font-smoothing:antialiased;
        text-rendering:optimizeLegibility;
      }
      .wrap{
        max-width:900px;
        margin:0 auto;
        padding:16px;
      }
      @media(max-width:640px){
        .wrap{ padding:12px; }
      }
      a.back{
        color:var(--accent);
        text-decoration:none;
        display:inline-block;
        margin-bottom:12px;
        font-size:0.95rem;
      }
      h1{
        margin:0 0 16px;
        font-size:clamp(22px,4vw,30px);
        line-height:1.2;
      }
      @media(max-width:640px){
        h1{ margin:0 0 12px; font-size:clamp(18px,5vw,24px); }
      }
      .media{
        background:var(--card);
        border:1px solid var(--stroke);
        border-radius:12px;
        overflow:hidden;
        margin-bottom:16px;
        position:relative;
        aspect-ratio:5/3;
      }
      .carousel{
        position:relative;
        width:100%;
        height:100%;
        overflow:hidden;
      }
      .slide{
        position:absolute;
        inset:0;
        opacity:0;
        transition:opacity .35s ease;
      }
      .slide.active{ opacity:1; }
      .slide img{
        width:100%;
        height:100%;
        object-fit:cover;
        display:block;
      }
      .dots{
        position:absolute;
        bottom:8px;
        left:50%;
        transform:translateX(-50%);
        display:flex;
        gap:6px;
        z-index:2;
      }
      .dot{
        width:8px;
        height:8px;
        border-radius:50%;
        border:1px solid #ffffff;
        background:#ffffff22;
        cursor:pointer;
      }
      .dot.active{
        background:#ffffff;
      }
      .ctrls{
        position:absolute;
        inset:0;
        display:flex;
        justify-content:space-between;
        align-items:center;
        pointer-events:none;
      }
      .ctrls button{
        background:#00000055;
        border:1px solid #ffffff;
        color:#ffffff;
        border-radius:8px;
        padding:6px 10px;
        margin:0 8px;
        cursor:pointer;
        pointer-events:auto;
      }
      /* Countdown timer styles */
      .timer{
        position:absolute;
        top:8px;
        right:8px;
        width:50px;
        height:50px;
        display:flex;
        align-items:center;
        justify-content:center;
        z-index:3;
      }
      .timer svg{
        width:100%;
        height:100%;
        transform:rotate(-90deg);
      }
      .timer-ring{
        fill:none;
        stroke:var(--accent);
        stroke-width:4;
        stroke-linecap:round;
        transition:stroke-dashoffset 0.1s linear;
      }
      .timer-text{
        position:absolute;
        color:var(--accent);
        font-size:0.75rem;
        font-weight:600;
        pointer-events:none;
      }
      .facts{
        display:grid;
        gap:10px;
        grid-template-columns:1fr 1fr;
        margin-bottom:16px;
      }
      @media(max-width:560px){
        .facts{ grid-template-columns:1fr; gap:8px; margin-bottom:12px; }
      }
      .facts div{
        background:var(--panel);
        border:1px solid var(--stroke);
        border-radius:10px;
        padding:8px 12px;
        font-size:0.9rem;
      }
      @media(max-width:640px){
        .facts div{ padding:10px; font-size:0.85rem; }
      }
      .facts span.value{
        float:right;
        color:var(--ink);
      }
      .section-title{
        margin:20px 0 12px 0;
        font-size:0.95rem;
        font-weight:600;
        color:var(--accent);
        text-transform:uppercase;
        letter-spacing:0.5px;
      }
      @media(max-width:640px){
        .section-title{ margin:16px 0 10px 0; font-size:0.85rem; }
      }
      .info-grid{
        display:grid;
        gap:10px;
        grid-template-columns:1fr;
        margin-bottom:16px;
      }
      .info-panel{
        background:var(--panel);
        border:1px solid var(--stroke);
        border-radius:10px;
        padding:12px;
        font-size:0.9rem;
      }
      @media(max-width:640px){
        .info-panel{ padding:10px; font-size:0.85rem; }
      }
      .info-label{
        font-weight:600;
        color:var(--accent);
        font-size:0.85rem;
        margin-bottom:6px;
        text-transform:uppercase;
        letter-spacing:0.5px;
      }
      @media(max-width:640px){
        .info-label{ font-size:0.8rem; margin-bottom:4px; }
      }
      .info-value{
        color:var(--ink);
        font-size:0.9rem;
        word-wrap:break-word;
        white-space:normal;
      }
      .placeholder{
        color:var(--muted);
        font-style:italic;
      }
      /* Metadata panel styles */
      .metadata-panel{
        background:var(--panel);
        border:1px solid var(--stroke);
        border-radius:10px;
        padding:12px;
        margin-bottom:16px;
        font-size:0.9rem;
      }
      .metadata-row{
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap:12px;
        padding:6px 0;
        border-bottom:1px dotted var(--stroke);
      }
      .metadata-row:last-child{
        border-bottom:none;
      }
      .metadata-label{
        font-weight:600;
        color:var(--muted);
        font-size:0.8rem;
        text-transform:uppercase;
        letter-spacing:0.3px;
      }
      .metadata-value{
        color:var(--ink);
        font-size:0.9rem;
        text-align:right;
        flex:1 1 auto;
        word-break:break-word;
      }
      /* Debug panel styles */
      .debug{
        margin-top:20px;
        padding:12px;
        background:#1f2937;
        border:1px solid #374151;
        border-radius:8px;
        color:#9ca3af;
        font-family:monospace;
        font-size:0.85rem;
        white-space:pre-wrap;
        overflow:auto;
        max-height:300px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <a href="nh48_catalog.html" class="back">← Back to catalog</a>
      <h1 id="peakTitle">Loading…</h1>
      <div class="media" id="media" hidden>
        <div class="carousel" id="carousel"></div>
        <div class="dots" id="dots"></div>
        <div class="ctrls">
          <button id="prevBtn" aria-label="Previous image">‹</button>
          <button id="nextBtn" aria-label="Next image">›</button>
        </div>
        <!-- Countdown timer overlay -->
        <div class="timer" id="carouselTimer" hidden>
          <svg width="50" height="50" viewBox="0 0 40 40">
            <circle id="timerRing" class="timer-ring" cx="20" cy="20" r="18"></circle>
          </svg>
          <span id="timerText" class="timer-text"></span>
        </div>
      </div>
      <div id="photoMetadataPanel" class="metadata-panel" hidden></div>
      <div class="facts" id="facts" hidden>
        <div>Elevation <span class="value" id="factElev">—</span></div>
        <div>Prominence <span class="value" id="factProm">—</span></div>
        <div>Range <span class="value" id="factRange">—</span></div>
        <div>Trail Type <span class="value" id="factTrail">—</span></div>
        <div>Difficulty <span class="value" id="factDifficulty">—</span></div>
        <div>Exposure <span class="value" id="factExposure">—</span></div>
      </div>
      <div class="section-title">Hiking Routes</div>
      <div class="info-grid" id="routesGrid" hidden></div>
      <div class="section-title">Trail & Terrain</div>
      <div class="info-grid" id="terrainGrid" hidden></div>
      <div class="section-title">Conditions & Access</div>
      <div class="info-grid" id="conditionsGrid" hidden></div>
      <div id="debug" class="debug" hidden></div>
    </div>
    <script>
      /* API endpoints list remains unchanged */
      const API_URLS = [
        'https://cdn.jsdelivr.net/gh/natesobol/nh48-api@main/data/nh48.json',
        'https://raw.githubusercontent.com/natesobol/nh48-api/main/data/nh48.json'
      ];
      const PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#172032"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="22">no image</text></svg>`
      );
      function showDebug(msg){
        const dbg = document.getElementById('debug');
        const time = new Date().toLocaleTimeString();
        dbg.hidden = false;
        dbg.textContent += (dbg.textContent ? '\n\n' : '') + '[' + time + '] ' + msg;
      }
      function cleanJSON(raw){
        let cleaned = raw.replace(/:contentReference\[.*?\]\{index=\d+\}/g, '');
        cleaned = cleaned.replace(/\/\*\s*Lines?\s+\d+[\d\-,\s]*omitted\s*\*\//g, '');
        return cleaned;
      }
      async function fetchPeaks(){
        for(let i=0; i<API_URLS.length; i++){
          const url = API_URLS[i];
          try{
            showDebug(`Attempt ${i+1}/${API_URLS.length}: fetching ${url}`);
            const res = await fetch(url, { mode:'cors' });
            if(!res.ok){
              showDebug(`  Status ${res.status} ${res.statusText}`);
              continue;
            }
            const text = await res.text();
            showDebug(`  Received ${text.length} characters`);
            const cleaned = cleanJSON(text);
            let data;
            try{
              data = JSON.parse(cleaned);
            }catch(parseErr){
              showDebug(`  JSON parse error: ${parseErr.message}`);
              continue;
            }
            showDebug('  Parsed JSON successfully');
            return data;
          }catch(err){
            showDebug(`  Fetch error: ${err.message || err}`);
          }
        }
        throw new Error('All API endpoints failed');
      }
      function getSlug(){
        const params = new URLSearchParams(window.location.search);
        return params.get('slug');
      }
      // Carousel state
      let carouselImgs = [];
      let carouselIdx = 0;
      let carouselTimer = null;
      let timerInterval = null;
      let photoMetaData = [];
      let currentDelay = 8000;
      const BASE_DELAY = 8000;
      // Update metadata panel for current slide
      function updateMetadata(i){
        const panel = document.getElementById('photoMetadataPanel');
        if(!photoMetaData || !photoMetaData[i]){
          panel.innerHTML = '';
          panel.hidden = true;
          return;
        }
        const meta = photoMetaData[i];
        panel.innerHTML = '';
        let entries = Object.entries(meta).filter(([k,v]) => v !== null && v !== '' && !['photoId','filename','url','isPrimary','tags'].includes(k));
        if(entries.length === 0){
          panel.innerHTML = '<div class="metadata-row"><div class="metadata-label">No metadata</div><div class="metadata-value"></div></div>';
          panel.hidden = false;
          return;
        }
        entries.forEach(([key, value], idx) => {
          const row = document.createElement('div');
          row.className = 'metadata-row';
          const label = document.createElement('div');
          label.className = 'metadata-label';
          // Convert camelCase / pascalCase keys into spaced labels
          label.textContent = key.replace(/([A-Z])/g, ' $1').replace(/^./, s=>s.toUpperCase());
          const val = document.createElement('div');
          val.className = 'metadata-value';
          val.textContent = value;
          row.appendChild(label);
          row.appendChild(val);
          panel.appendChild(row);
        });
        panel.hidden = false;
      }
      function buildCarousel(images, meta, altBase){
        const carouselEl = document.getElementById('carousel');
        const dotsEl = document.getElementById('dots');
        carouselEl.innerHTML = '';
        dotsEl.innerHTML = '';
        carouselImgs = [];
        carouselIdx = 0;
        photoMetaData = meta || [];
        if(!images || images.length === 0){ images = [PLACEHOLDER]; }
        images.forEach((src, i) => {
          const slide = document.createElement('div');
          slide.className = 'slide' + (i === 0 ? ' active' : '');
          const img = document.createElement('img');
          img.alt = `${altBase} image ${i+1} of ${images.length}`;
          if(i === 0){
            img.src = src;
          } else {
            img.loading = 'lazy';
            img.decoding = 'async';
            img.setAttribute('data-src', src);
            img.src = PLACEHOLDER;
          }
          img.onerror = () => { img.onerror = null; img.src = PLACEHOLDER; };
          slide.appendChild(img);
          carouselEl.appendChild(slide);
          carouselImgs.push(img);
          const dot = document.createElement('div');
          dot.className = 'dot' + (i === 0 ? ' active' : '');
          dot.addEventListener('click', () => goTo(i, true));
          dotsEl.appendChild(dot);
        });
        document.getElementById('media').hidden = false;
        document.getElementById('carouselTimer').hidden = false;
        // Controls
        document.getElementById('prevBtn').onclick = () => prev(true);
        document.getElementById('nextBtn').onclick = () => next(true);
        // Start
        startCarousel();
        setupCarouselLazyLoading();
        updateMetadata(0);
      }
      function updateSlides(){
        const slides = Array.from(document.querySelectorAll('.slide'));
        const dots = Array.from(document.querySelectorAll('.dot'));
        slides.forEach((s,i) => s.classList.toggle('active', i === carouselIdx));
        dots.forEach((d,i) => d.classList.toggle('active', i === carouselIdx));
        updateMetadata(carouselIdx);
      }
      function ensureImgLoaded(i){
        const img = carouselImgs[i]; if(!img) return;
        const real = img.getAttribute('data-src');
        if(real){ img.src = real; img.removeAttribute('data-src'); }
      }
      function next(manual=false){
        carouselIdx = (carouselIdx + 1) % carouselImgs.length;
        ensureImgLoaded(carouselIdx);
        updateSlides();
        if(manual){ startCarousel(); }
      }
      function prev(manual=false){
        carouselIdx = (carouselIdx - 1 + carouselImgs.length) % carouselImgs.length;
        ensureImgLoaded(carouselIdx);
        updateSlides();
        if(manual){ startCarousel(); }
      }
      function goTo(i, manual=false){
        carouselIdx = i % carouselImgs.length;
        ensureImgLoaded(carouselIdx);
        updateSlides();
        if(manual){ startCarousel(); }
      }
      function startCarousel(){
        stopCarousel();
        // Randomise interval slightly for variety
        currentDelay = BASE_DELAY + Math.floor(Math.random()*2000);
        carouselTimer = setInterval(() => next(false), currentDelay);
        startTimer(currentDelay);
      }
      function stopCarousel(){
        if(carouselTimer){ clearInterval(carouselTimer); carouselTimer = null; }
        if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
      }
      function setupCarouselLazyLoading(){
        if (!('IntersectionObserver' in window)) {
          carouselImgs.forEach(img => {
            const src = img.getAttribute('data-src');
            if(src){ img.src = src; img.removeAttribute('data-src'); }
          });
          return;
        }
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if(entry.isIntersecting){
              const img = entry.target;
              const src = img.getAttribute('data-src');
              if(src){ img.src = src; img.removeAttribute('data-src'); }
              observer.unobserve(img);
            }
          });
        }, { rootMargin:'100px' });
        carouselImgs.forEach(img => {
          if(img.getAttribute('data-src')){ observer.observe(img); }
        });
      }
      function scheduleResize(){
        setTimeout(() => {
          const h = document.documentElement.scrollHeight;
          if(window.parent){ window.parent.postMessage({ type:'resize', height:h }, '*'); }
        }, 150);
      }
      // Countdown timer logic: animate ring and update text
      function startTimer(duration){
        const ring = document.getElementById('timerRing');
        const textEl = document.getElementById('timerText');
        const radius = 18;
        const circumference = 2 * Math.PI * radius;
        ring.style.strokeDasharray = circumference;
        ring.style.strokeDashoffset = 0;
        let start = Date.now();
        let end = start + duration;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          const now = Date.now();
          const remaining = Math.max(end - now, 0);
          const percent = remaining / duration;
          const offset = circumference * (1 - percent);
          ring.style.strokeDashoffset = offset;
          const secs = Math.ceil(remaining / 1000);
          textEl.textContent = secs;
          if(remaining <= 0){ clearInterval(timerInterval); }
        }, 100);
        // Set initial text and offset
        textEl.textContent = Math.ceil(duration / 1000);
      }
      async function init(){
        const slug = getSlug();
        if(!slug){
          document.getElementById('peakTitle').textContent = 'Peak not specified';
          scheduleResize();
          return;
        }
        try{
          const data = await fetchPeaks();
          const p = data && data[slug];
          if(!p){
            document.getElementById('peakTitle').textContent = 'Peak not found';
            scheduleResize();
            return;
          }
          const name = p.peakName || p['Peak Name'] || slug;
          document.getElementById('peakTitle').textContent = name;
          const elev = p['Elevation (ft)'];
          const prom = p['Prominence (ft)'];
          document.getElementById('factElev').textContent = (elev ? elev + "'" : '—');
          document.getElementById('factProm').textContent = (prom ? prom + "'" : '—');
          document.getElementById('factRange').textContent = p['Range / Subrange'] || '—';
          document.getElementById('factTrail').textContent = p['Trail Type'] || '—';
          document.getElementById('factDifficulty').textContent = p['Difficulty'] || '—';
          document.getElementById('factExposure').textContent = p['Exposure Level'] || '—';
          document.getElementById('facts').hidden = false;
          const routes = p['Standard Routes'] || [];
          if(routes.length > 0){
            const routesGrid = document.getElementById('routesGrid');
            routes.forEach(r => {
              const div = document.createElement('div');
              div.className = 'info-panel';
              const dist  = r['Distance (mi)'] || '—';
              const gain  = r['Elevation Gain (ft)'] || '—';
              const diff  = r['Difficulty'] || '—';
              div.innerHTML = `<div class="info-label">${r['Route Name']}</div><div class="info-value"><strong>Distance:</strong> ${dist} mi  •  <strong>Gain:</strong> ${gain}'  •  <strong>Difficulty:</strong> ${diff}</div>`;
              routesGrid.appendChild(div);
            });
            routesGrid.hidden = false;
          }
          const terrainItems = [
            { label:'Terrain', value:p['Terrain Character'] },
            { label:'Scramble', value:p['Scramble Sections'] },
            { label:'View', value:p['View Type'] }
          ].filter(item => item.value);
          const conditionItems = [
            { label:'Best Seasons', value:p['Best Seasons to Hike'] },
            { label:'Water Availability', value:p['Water Availability'] },
            { label:'Cell Reception', value:p['Cell Reception Quality'] },
            { label:'Weather Exposure', value:p['Weather Exposure Rating'] },
            { label:'Emergency Bailout', value:p['Emergency Bailout Options'] },
            { label:'Dog Friendly', value:p['Dog Friendly'] },
            { label:'Nearby Features', value:p['Nearby Notable Features'] }
          ].filter(item => item.value);
          if(terrainItems.length > 0){
            const terrainGrid = document.getElementById('terrainGrid');
            terrainItems.forEach(item => {
              const div = document.createElement('div');
              div.className = 'info-panel';
              div.innerHTML = `<div class="info-label">${item.label}</div><div class="info-value">${item.value}</div>`;
              terrainGrid.appendChild(div);
            });
            terrainGrid.hidden = false;
          }
          if(conditionItems.length > 0){
            const conditionsGrid = document.getElementById('conditionsGrid');
            conditionItems.forEach(item => {
              const div = document.createElement('div');
              div.className = 'info-panel';
              div.innerHTML = `<div class="info-label">${item.label}</div><div class="info-value">${item.value}</div>`;
              conditionsGrid.appendChild(div);
            });
            conditionsGrid.hidden = false;
          }
          // Images and metadata arrays
          let imgs = [];
          let photoMeta = [];
          if(Array.isArray(p.photos) && p.photos.length > 0){
            p.photos.forEach(item => {
              if(typeof item === 'string'){ imgs.push(item); photoMeta.push({}); }
              else if(item && item.url){ imgs.push(item.url); photoMeta.push(item); }
            });
          }
          if(imgs.length === 0){ imgs = [PLACEHOLDER]; photoMeta = [{}]; }
          buildCarousel(imgs, photoMeta, name);
        }catch(err){
          console.error(err);
          showDebug('Error: ' + (err && err.message ? err.message : err));
          document.getElementById('peakTitle').textContent = 'Error loading peak';
        }
        scheduleResize();
      }
      window.addEventListener('load', () => {
        init();
        window.addEventListener('resize', scheduleResize);
      });
    </script>
  </body>
</html>
