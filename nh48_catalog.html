<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NH48 Peak Catalog (Debug/Resilient)</title>
    <!--
      This page lists New Hampshire's forty‑eight 4000‑footer peaks in a search‑able
      grid. It includes extensive debugging and fallback logic to help diagnose
      issues when the JSON fails to load.  Unlike the simple catalog, this
      version tries multiple API endpoints and reports detailed status and
      errors to a debug panel.  If the data can't be loaded, you will see
      diagnostic messages explaining what went wrong.  Use this file in Wix
      embeds or directly via GitHub Pages to troubleshoot loading problems.
    -->
    <style>
      :root{
        --bg:#0a0a0a;
        --panel:#12121a;
        --card:#171a22;
        --ink:#ffffff;
        --muted:#a5b4c3;
        --stroke:#ffffff33;
        --accent:#22c55e;
        --gap:10px;
      }
      body{
        margin:0;
        background:var(--bg);
        color:var(--ink);
        font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        -webkit-font-smoothing:antialiased;
        text-rendering:optimizeLegibility;
      }
      .wrap{
        max-width:1000px;
        margin:0 auto;
        padding:16px;
      }
      header h1{
        margin:0;
        font-size:clamp(24px,4vw,32px);
        line-height:1.2;
      }
      header p{
        margin:4px 0 20px;
        color:var(--muted);
      }
      .search{
        margin-bottom:14px;
      }
      .search input{
        width:100%;
        height:42px;
        padding:0 14px;
        font-size:16px;
        border:1px solid var(--stroke);
        border-radius:12px;
        background:var(--card);
        color:var(--ink);
        outline:none;
      }
      .grid{
        display:grid;
        gap:12px;
        grid-template-columns:repeat(auto-fill, minmax(250px, 1fr));
      }
      .card{
        background:var(--card);
        border:1px solid var(--stroke);
        border-radius:12px;
        overflow:hidden;
        cursor:pointer;
        display:flex;
        flex-direction:column;
        transition:transform .12s ease, box-shadow .12s ease;
      }
      .card:hover{
        transform:translateY(-2px);
        box-shadow:0 8px 20px #0005;
      }
      .thumb{
        aspect-ratio:5/3;
        background:var(--panel);
        position:relative;
        overflow:hidden;
      }
      .thumb img{
        width:100%;
        height:100%;
        object-fit:cover;
        display:block;
      }
      .body{
        padding:12px;
        flex:1 1 auto;
      }
      .body h3{
        margin:0 0 4px;
        font-size:1.1rem;
      }
      .body p{
        margin:2px 0;
        font-size:0.9rem;
        color:var(--muted);
      }
      .empty{
        padding:40px;
        text-align:center;
        color:var(--muted);
        font-size:1rem;
      }
      /* Debug panel styles */
      .debug{
        margin-top:20px;
        padding:12px;
        background:#1f2937;
        border:1px solid #374151;
        border-radius:8px;
        color:#9ca3af;
        font-family:monospace;
        font-size:0.85rem;
        white-space:pre-wrap;
        overflow:auto;
        max-height:300px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>NH48 Peak Catalog</h1>
        <p>Browse New Hampshire's forty‑eight 4000‑footers. Click a peak to view more details. If errors occur, details will appear below.</p>
      </header>
      <div class="search">
        <input type="text" id="searchInput" placeholder="Search peaks by name…" />
      </div>
      <div id="grid" class="grid"></div>
      <div id="emptyMessage" class="empty" hidden>No peaks found.</div>
      <div id="debug" class="debug" hidden></div>
    </div>
    <script>
      /*
        We attempt to load the NH48 API from multiple locations in order to
        maximise the chance of success and provide clear diagnostics when
        failures occur.  These URLs are tried in order until a successful
        response is parsed.  You can add your own mirror endpoints here.
      */
      const API_URLS = [
        // jsDelivr (GH CDN) - typically CORS-friendly
        'https://cdn.jsdelivr.net/gh/natesobol/nh48-api@main/data/nh48.json',
        // Raw GitHub - some browsers restrict this due to missing CORS
        'https://raw.githubusercontent.com/natesobol/nh48-api/main/data/nh48.json'
      ];
      // Placeholder image used when no photos are available.  This is an
      // inline SVG encoded as a data URL so it requires no network fetch.
      const PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#172032"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="22">no image</text></svg>`
      );

      let peaks = [];

      // Debug helper: append messages to the debug panel.  Each call
      // displays the panel (if hidden) and appends the message.  The
      // message can include newlines.  We prefix messages with a time
      // stamp for easier reading.
      function showDebug(message){
        const dbg = document.getElementById('debug');
        const now = new Date().toLocaleTimeString();
        dbg.hidden = false;
        dbg.textContent += (dbg.textContent ? '\n\n' : '') + '[' + now + '] ' + message;
      }

      /*
        Clean the raw JSON by removing embedded citation markers and
        repairing missing commas or trailing commas.  Without this, the
        presence of citation markers in the API will break JSON.parse().
      */
      function cleanJSON(raw){
        let cleaned = raw.replace(/:contentReference\[.*?\]\{index=\d+\}/g, '');
        cleaned = cleaned.replace(/\]\s*\n\s*"/g, '],\n  "');
        // Remove trailing commas before closing braces or brackets
        cleaned = cleaned.replace(/,\s*}/g, '}');
        cleaned = cleaned.replace(/,\s*]/g, ']');
        return cleaned;
      }

      /*
        Try to fetch the API JSON from each URL in API_URLS until one
        succeeds.  For each attempt, we log detailed diagnostic info
        including HTTP status, content length and JSON parse errors.  If
        all attempts fail, we throw an error to be handled by init().
      */
      async function fetchPeaks(){
        for(let i=0; i<API_URLS.length; i++){
          const url = API_URLS[i];
          try{
            showDebug(`Attempt ${i+1}/${API_URLS.length}: fetching ${url}`);
            const res = await fetch(url, { mode:'cors' });
            if(!res.ok){
              showDebug(`  Status ${res.status} ${res.statusText}`);
              continue;
            }
            const text = await res.text();
            showDebug(`  Received ${text.length} characters`);
            const cleaned = cleanJSON(text);
            let obj;
            try{
              obj = JSON.parse(cleaned);
            }catch(parseErr){
              showDebug(`  JSON parse error: ${parseErr.message}`);
              continue;
            }
            // Convert dictionary keyed by slug into array of objects with slug
            const arr = Object.keys(obj).map(slug => {
              const p = obj[slug] || {};
              p.slug = slug;
              p.peakName = p.peakName || p['Peak Name'] || slug;
              return p;
            });
            showDebug(`  Parsed ${arr.length} peaks successfully`);
            return arr;
          }catch(fetchErr){
            showDebug(`  Fetch error: ${fetchErr.message || fetchErr}`);
            // continue to next URL
          }
        }
        throw new Error('All API endpoints failed');
      }

      function createCard(p){
        const card = document.createElement('article');
        card.className = 'card';
        // Determine thumbnail source: use first photo if available, else placeholder.
        const thumbSrc = (Array.isArray(p.photos) && p.photos.length > 0) ? p.photos[0] : PLACEHOLDER;
        card.innerHTML = `
          <div class="thumb">
            <img src="${PLACEHOLDER}" data-src="${thumbSrc}" alt="${p.peakName} thumbnail" loading="lazy" decoding="async">
          </div>
          <div class="body">
            <h3>${p.peakName}</h3>
            <p>Elevation: ${p['Elevation (ft)'] || '—'} ft</p>
            <p>Range: ${p['Range / Subrange'] || '—'}</p>
          </div>`;
        card.addEventListener('click', () => {
          // Build a URL to the details page relative to this file.  We use
          // nh48_peak.html specifically (mirroring our GitHub file name)
          // and preserve query parameters for the slug.  Opening in the
          // _top frame ensures full page navigation in Wix if embedded.
          const base = window.location.href.replace(/[^\/]*$/, '');
          const url = new URL('nh48_peak.html', base);
          url.searchParams.set('slug', p.slug);
          window.open(url.toString(), '_top');
        });
        return card;
      }

      function renderGrid(list){
        const grid = document.getElementById('grid');
        const empty = document.getElementById('emptyMessage');
        grid.innerHTML = '';
        if (!list || list.length === 0){
          empty.hidden = false;
          scheduleResize();
          return;
        }
        empty.hidden = true;
        list.forEach(p => grid.appendChild(createCard(p)));
        setupLazyLoading();
        scheduleResize();
      }

      function setupLazyLoading(){
        if (!('IntersectionObserver' in window)) return;
        const observer = new IntersectionObserver((entries, obs) => {
          entries.forEach(entry => {
            if(entry.isIntersecting){
              const img = entry.target;
              const real = img.getAttribute('data-src');
              if(real){ img.src = real; img.removeAttribute('data-src'); }
              obs.unobserve(img);
            }
          });
        }, { rootMargin: '200px' });
        document.querySelectorAll('img[data-src]').forEach(img => observer.observe(img));
      }

      function scheduleResize(){
        // Post the height to the parent frame (Wix) after a slight delay to
        // ensure images have loaded and layout has settled.
        setTimeout(() => {
          const h = document.documentElement.scrollHeight;
          if(window.parent){
            window.parent.postMessage({ type:'resize', height:h }, '*');
          }
        }, 100);
      }

      async function init(){
        try{
          peaks = await fetchPeaks();
          showDebug('Loaded ' + peaks.length + ' peaks');
          renderGrid(peaks);
        }catch(err){
          console.error(err);
          document.getElementById('emptyMessage').textContent = 'Error loading peaks';
          document.getElementById('emptyMessage').hidden = false;
        }
        const search = document.getElementById('searchInput');
        search.addEventListener('input', (e) => {
          const q = e.target.value.trim().toLowerCase();
          const filtered = peaks.filter(p => p.peakName && p.peakName.toLowerCase().includes(q));
          renderGrid(filtered);
        });
      }
      window.addEventListener('load', () => {
        init();
        // Also adjust height on resize events from the browser.
        window.addEventListener('resize', scheduleResize);
      });
    </script>
  </body>
</html>
