<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NH48 Peak Catalog (Enhanced)</title>
    <!--
      Enhanced catalog page for the NH48 peak list.  This version builds on
      the resilient catalog by adding autocomplete search, sorting and
      filtering controls while retaining robust error handling and debug
      logging.  Autocomplete suggestions strip common words (Mount,
      Mountain, Peak) to improve relevance.  A controls panel provides
      sorting by name or elevation and filtering by range/difficulty.  The
      UI remains self-contained for easy embedding in Wix or GitHub Pages.
    -->
    <style>
      :root{
        --bg:#0a0a0a;
        --panel:#12121a;
        --card:#171a22;
        --ink:#ffffff;
        --muted:#a5b4c3;
        --stroke:#ffffff33;
        --accent:#22c55e;
        --gap:10px;
      }
      body{
        margin:0;
        background:var(--bg);
        color:var(--ink);
        font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        -webkit-font-smoothing:antialiased;
        text-rendering:optimizeLegibility;
      }
      .wrap{
        max-width:1100px;
        margin:0 auto;
        padding:16px;
      }
      @media(max-width:640px){
        .wrap{ padding:12px; }
      }
      header h1{
        margin:0;
        font-size:clamp(24px,4vw,32px);
        line-height:1.2;
      }
      header p{
        margin:4px 0 16px;
        color:var(--muted);
      }
      @media(max-width:640px){
        header h1{ font-size:clamp(20px,5vw,24px); }
        header p{ font-size:0.9rem; margin:4px 0 12px; }
      }
      .search{
        margin-bottom:12px;
      }
      .search input{
        width:100%;
        height:40px;
        padding:0 14px;
        font-size:16px;
        border:1px solid var(--stroke);
        border-radius:10px;
        background:var(--card);
        color:var(--ink);
        outline:none;
        box-sizing:border-box;
      }
      @media(max-width:640px){
        .search{ margin-bottom:10px; }
        .search input{ height:36px; font-size:14px; padding:0 10px; }
      }
      .controls{
        display:flex;
        flex-wrap:wrap;
        gap:12px;
        margin-bottom:14px;
        align-items:center;
      }
      .controls label{
        font-size:0.85rem;
        color:var(--muted);
        margin-right:4px;
      }
      .controls select{
        background:var(--card);
        color:var(--ink);
        border:1px solid var(--stroke);
        border-radius:10px;
        padding:6px 10px;
        font-size:0.9rem;
      }
      @media(max-width:640px){
        .controls{ gap:8px; margin-bottom:10px; }
        .controls label{ font-size:0.75rem; margin-right:2px; }
        .controls select{ padding:4px 8px; font-size:0.8rem; }
      }
      .grid{
        display:grid;
        gap:12px;
        grid-template-columns:repeat(auto-fill, minmax(250px, 1fr));
      }
      .card{
        background:var(--card);
        border:1px solid var(--stroke);
        border-radius:12px;
        overflow:hidden;
        cursor:pointer;
        display:flex;
        flex-direction:column;
        transition:transform .12s ease, box-shadow .12s ease;
      }
      .card:hover{
        transform:translateY(-2px);
        box-shadow:0 8px 20px #0005;
      }
      .thumb{
        aspect-ratio:5/3;
        background:var(--panel);
        position:relative;
        overflow:hidden;
      }
      .thumb img{
        width:100%;
        height:100%;
        object-fit:cover;
        display:block;
      }
      .body{
        padding:12px;
        flex:1 1 auto;
      }
      .body h3{
        margin:0 0 4px;
        font-size:1.1rem;
      }
      .body p{
        margin:2px 0;
        font-size:0.85rem;
        color:var(--muted);
      }
      @media(max-width:640px){
        .body{ padding:10px; }
        .body h3{ font-size:0.95rem; }
        .body p{ font-size:0.8rem; }
      }
      .empty{
        padding:40px;
        text-align:center;
        color:var(--muted);
        font-size:1rem;
      }
      /* Debug panel styles */
      .debug{
        margin-top:20px;
        padding:12px;
        background:#1f2937;
        border:1px solid #374151;
        border-radius:8px;
        color:#9ca3af;
        font-family:monospace;
        font-size:0.85rem;
        white-space:pre-wrap;
        overflow:auto;
        max-height:300px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>NH48 Peak Catalog</h1>
        <p>Browse New Hampshire's forty‑eight 4000‑footers. Click a peak to view more details. If errors occur, details will appear below.</p>
      </header>
      <!-- search with datalist for suggestions -->
      <div class="search">
        <input type="text" id="searchInput" list="nameSuggestions" placeholder="Search peaks by name…" />
        <datalist id="nameSuggestions"></datalist>
      </div>
      <!-- controls for sorting and filtering -->
      <div class="controls">
        <div class="control">
          <label for="sortSelect">Sort by:</label>
          <select id="sortSelect">
            <option value="name">Name (A–Z)</option>
            <option value="elev-asc">Elevation ↑</option>
            <option value="elev-desc">Elevation ↓</option>
            <option value="prom-asc">Prominence ↑</option>
            <option value="prom-desc">Prominence ↓</option>
          </select>
        </div>
        <div class="control" id="rangeFilterContainer">
          <label for="rangeFilter">Range:</label>
          <select id="rangeFilter">
            <option value="">All</option>
          </select>
        </div>
        <div class="control" id="difficultyFilterContainer">
          <label for="difficultyFilter">Difficulty:</label>
          <select id="difficultyFilter">
            <option value="">All</option>
          </select>
        </div>
      </div>
      <div id="grid" class="grid"></div>
      <div id="emptyMessage" class="empty" hidden>No peaks found.</div>
      <div id="debug" class="debug" hidden></div>
    </div>
    <script>
      // API endpoints to attempt in order.  We start with jsDelivr for CORS
      // compatibility then fall back to raw GitHub.  Extend this array as
      // needed to include mirrors.
      const API_URLS = [
        'https://cdn.jsdelivr.net/gh/natesobol/nh48-api@main/data/nh48.json',
        'https://raw.githubusercontent.com/natesobol/nh48-api/main/data/nh48.json'
      ];
      // Placeholder image when no photo is available
      const PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#172032"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="22">no image</text></svg>`
      );

      let peaks = [];
      let activeSort = 'name';
      const filters = {
        range: '',
        difficulty: ''
      };

      function showDebug(msg){
        const dbg = document.getElementById('debug');
        const time = new Date().toLocaleTimeString();
        dbg.hidden = false;
        dbg.textContent += (dbg.textContent ? '\n\n' : '') + '[' + time + '] ' + msg;
      }

      function cleanJSON(raw){
        // Remove contentReference annotations
        let cleaned = raw.replace(/:contentReference\[.*?\]\{index=\d+\}/g, '');
        // Remove comments that look like: /* ... omitted */
        cleaned = cleaned.replace(/\/\*\s*Lines?\s+\d+[\d\-,\s]*omitted\s*\*\//g, '');
        return cleaned;
      }

      async function fetchPeaks(){
        for(let i=0;i<API_URLS.length;i++){
          const url = API_URLS[i];
          try{
            showDebug(`Attempt ${i+1}/${API_URLS.length}: fetching ${url}`);
            const res = await fetch(url, { mode:'cors' });
            if(!res.ok){
              showDebug(`  Status ${res.status} ${res.statusText}`);
              continue;
            }
            const text = await res.text();
            showDebug(`  Received ${text.length} characters`);
            const cleaned = cleanJSON(text);
            let obj;
            try{
              obj = JSON.parse(cleaned);
            }catch(err){
              showDebug(`  JSON parse error: ${err.message}`);
              continue;
            }
            const arr = Object.keys(obj).map(slug => {
              const p = obj[slug] || {};
              p.slug = slug;
              p.peakName = p.peakName || p['Peak Name'] || slug;
              return p;
            });
            showDebug(`  Parsed ${arr.length} peaks successfully`);
            return arr;
          }catch(err){
            showDebug(`  Fetch error: ${err.message || err}`);
          }
        }
        throw new Error('All API endpoints failed');
      }

      function createCard(p){
        const card = document.createElement('article');
        card.className = 'card';
        // Determine thumbnail: use the first photo's URL if available.  The
        // API stores each photo as either a string or an object with a
        // `url` property.  Fallback to a placeholder when no photos exist.
        let thumbSrc = PLACEHOLDER;
        if (Array.isArray(p.photos) && p.photos.length > 0) {
          const first = p.photos[0];
          if (typeof first === 'string') {
            thumbSrc = first;
          } else if (first && first.url) {
            thumbSrc = first.url;
          }
        }
        // We assign src directly to ensure images load even if the
        // IntersectionObserver fails.  `loading="lazy"` still hints to
        // the browser to defer off‑screen images.
        card.innerHTML = `
          <div class="thumb">
            <img src="${thumbSrc}" alt="${p.peakName} thumbnail" loading="lazy" decoding="async">
          </div>
          <div class="body">
            <h3>${p.peakName}</h3>
            <p>Elevation: ${p['Elevation (ft)'] || '—'} ft</p>
            <p>Range: ${p['Range / Subrange'] || '—'}</p>
          </div>`;
        card.addEventListener('click', () => {
          const base = window.location.href.replace(/[^\/]*$/, '');
          const url = new URL('nh48_peak.html', base);
          url.searchParams.set('slug', p.slug);
          window.open(url.toString(), '_top');
        });
        return card;
      }

      function setupLazyLoading(){
        if (!('IntersectionObserver' in window)) return;
        const observer = new IntersectionObserver((entries, obs) => {
          entries.forEach(entry => {
            if(entry.isIntersecting){
              const img = entry.target;
              const real = img.getAttribute('data-src');
              if(real){ img.src = real; img.removeAttribute('data-src'); }
              obs.unobserve(img);
            }
          });
        }, { rootMargin: '200px' });
        document.querySelectorAll('img[data-src]').forEach(img => observer.observe(img));
      }

      function scheduleResize(){
        setTimeout(() => {
          const h = document.documentElement.scrollHeight;
          if(window.parent){ window.parent.postMessage({ type:'resize', height:h }, '*'); }
        }, 100);
      }

      function renderGrid(list){
        const grid = document.getElementById('grid');
        const empty = document.getElementById('emptyMessage');
        grid.innerHTML = '';
        if(!list || list.length === 0){
          empty.hidden = false;
          scheduleResize();
          return;
        }
        empty.hidden = true;
        list.forEach(p => grid.appendChild(createCard(p)));
        setupLazyLoading();
        scheduleResize();
      }

      // Build suggestions list, stripping common words
      function updateSuggestions(){
        const list = peaks.map(p => p.peakName.replace(/\b(Mount|Mountain|Peak)\b/gi, '').trim()).filter(Boolean);
        const seen = new Set();
        const unique = [];
        list.forEach(name => { const key = name.toLowerCase(); if(!seen.has(key)){ seen.add(key); unique.push(name); } });
        const dl = document.getElementById('nameSuggestions');
        dl.innerHTML = unique.sort().map(name => `<option value="${name}"></option>`).join('');
      }

      // Populate filter selects with unique values from dataset
      function populateFilters(){
        const rangeSel = document.getElementById('rangeFilter');
        const difficultySel = document.getElementById('difficultyFilter');
        const ranges = new Set();
        const diffs = new Set();
        peaks.forEach(p => {
          const r = p['Range / Subrange'];
          if(r) ranges.add(r);
          const d = p['Difficulty'] || p.Difficulty;
          if(d) diffs.add(d);
        });
        [...ranges].sort().forEach(r => {
          const opt = document.createElement('option');
          opt.value = r;
          opt.textContent = r;
          rangeSel.appendChild(opt);
        });
        [...diffs].sort().forEach(d => {
          const opt = document.createElement('option');
          opt.value = d;
          opt.textContent = d;
          difficultySel.appendChild(opt);
        });
      }

      function applyFilters(list){
        let filtered = list;
        if(filters.range){ filtered = filtered.filter(p => p['Range / Subrange'] === filters.range); }
        if(filters.difficulty){ filtered = filtered.filter(p => (p['Difficulty'] || p.Difficulty) === filters.difficulty); }
        return filtered;
      }

      function sortPeaks(list){
        const arr = list.slice();
        arr.sort((a, b) => {
          switch(activeSort){
            case 'name':
              return (a.peakName || '').localeCompare(b.peakName || '');
            case 'elev-asc':
              return (a['Elevation (ft)'] || 0) - (b['Elevation (ft)'] || 0);
            case 'elev-desc':
              return (b['Elevation (ft)'] || 0) - (a['Elevation (ft)'] || 0);
            case 'prom-asc':
              return (a['Prominence (ft)'] || 0) - (b['Prominence (ft)'] || 0);
            case 'prom-desc':
              return (b['Prominence (ft)'] || 0) - (a['Prominence (ft)'] || 0);
          }
          return 0;
        });
        return arr;
      }

      function updateDisplay(){
        let list = peaks;
        // Apply search filter from input
        const searchVal = document.getElementById('searchInput').value.trim().toLowerCase();
        if(searchVal){
          list = list.filter(p => p.peakName && p.peakName.toLowerCase().includes(searchVal));
        }
        list = applyFilters(list);
        list = sortPeaks(list);
        renderGrid(list);
      }

      async function init(){
        try{
          peaks = await fetchPeaks();
          showDebug('Loaded ' + peaks.length + ' peaks');
          populateFilters();
          updateSuggestions();
          updateDisplay();
        }catch(err){
          console.error(err);
          document.getElementById('emptyMessage').textContent = 'Error loading peaks';
          document.getElementById('emptyMessage').hidden = false;
        }
        // Event listeners
        document.getElementById('searchInput').addEventListener('input', updateDisplay);
        document.getElementById('sortSelect').addEventListener('change', (e) => {
          activeSort = e.target.value;
          updateDisplay();
        });
        document.getElementById('rangeFilter').addEventListener('change', (e) => {
          filters.range = e.target.value;
          updateDisplay();
        });
        document.getElementById('difficultyFilter').addEventListener('change', (e) => {
          filters.difficulty = e.target.value;
          updateDisplay();
        });
      }
      window.addEventListener('load', () => {
        init();
        window.addEventListener('resize', scheduleResize);
      });
    </script>
  </body>
</html>
