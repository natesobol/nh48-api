      --top-height: 65vh;
      height: calc(100vh + 1500px);
      max-width: 1200px;
      flex: 2.5;
      position: relative;
      min-height: clamp(520px, 65vh, 820px);
      height: clamp(500px, 62vh, 780px);
      min-height: 500px;
      aspect-ratio: 1 / 1;
    .map-loading {
      position: absolute;
      inset: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      background: linear-gradient(135deg, rgba(38, 157, 95, 0.1), rgba(38, 157, 95, 0.05));
      border: 1px solid rgba(81, 207, 102, 0.35);
      border-radius: 8px;
      color: var(--text-primary);
      font-weight: 600;
      z-index: 10;
      pointer-events: none;
      transition: opacity 0.25s ease, visibility 0.25s ease;
    }

    .map-loading.is-hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loading-spinner {
      width: 28px;
      height: 28px;
      border: 3px solid rgba(81, 207, 102, 0.25);
      border-top-color: var(--button-green);
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .map-control-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      border: 1px solid var(--border-color);
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      cursor: pointer;
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
      border-radius: 6px;
      font-size: 0.95rem;
    }

    .map-control-button:hover,
    .map-control-button:focus-visible {
      background-color: var(--hover-bg);
      color: var(--accent-blue);
      border-color: var(--accent-blue);
      outline: none;
    }

    .leaflet-control-layers-expanded {
      background-color: var(--bg-secondary);
      border-color: var(--border-color);
      color: var(--text-primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
    }

        min-height: clamp(420px, 70vh, 700px);
      }

      #map {
        height: clamp(400px, 70vh, 660px);
        min-height: 400px;
        <div id="mapLoading" class="map-loading" role="status" aria-live="polite">
          <div class="loading-spinner" aria-hidden="true"></div>
          <span>Warming up the mapâ€¦</span>
        </div>
      const mapLoading = document.getElementById('mapLoading');
      const hideMapLoading = () => mapLoading && mapLoading.classList.add('is-hidden');
      const showMapLoading = () => mapLoading && mapLoading.classList.remove('is-hidden');
      showMapLoading();

        minZoom: 7,
        maxZoom: 19,
        zoomControl: false
      const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: t('trails.map.attribution'),
        maxZoom: 19,
        maxNativeZoom: 17,
        crossOrigin: true
      });

      const streetsLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19,
        maxNativeZoom: 19,
        crossOrigin: true
      });

      const esriTopoLayer = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
        {
          attribution: 'Tiles &copy; Esri & contributors',
          maxZoom: 19,
          crossOrigin: true
        }
      );

      const baseLayers = {
        'Topo (OpenTopoMap)': topoLayer,
        'OSM streets': streetsLayer,
        'Esri topo': esriTopoLayer
      };

      topoLayer.addTo(map);

      let hasAddedFallbackLayer = false;
      topoLayer.on('tileerror', () => {
        if (hasAddedFallbackLayer) return;
        hasAddedFallbackLayer = true;
        if (!map.hasLayer(streetsLayer)) {
          map.addLayer(streetsLayer);
        }
      });
      const peakLayerGroup = L.layerGroup();
      const overlayLayers = { 'Peaks overlay': peakLayerGroup };
      const layersControl = L.control.layers(baseLayers, overlayLayers, { collapsed: false }).addTo(map);
      peakLayerGroup.addTo(map);
      L.control.scale({ position: 'bottomleft', imperial: true, metric: true }).addTo(map);

      const HomeControl = L.Control.extend({
        options: { position: 'topleft' },
        onAdd: function() {
          const container = L.DomUtil.create('div', 'leaflet-bar');
          const button = L.DomUtil.create('button', 'map-control-button', container);
          button.type = 'button';
          button.title = 'Reset view';
          button.setAttribute('aria-label', 'Reset map view');
          button.innerHTML = '&#10227;';
          L.DomEvent.on(button, 'click', event => {
            L.DomEvent.stopPropagation(event);
            L.DomEvent.preventDefault(event);
            map.flyTo(defaultCenter, defaultZoom);
          });
          return container;
        }
      });
      map.addControl(new HomeControl());

      L.control.zoom({ position: 'topleft' }).addTo(map);
        // Access tags are implied by the path type; suppress the individual yes/no rows.
        const allowedUseKeys = ['foot', 'bicycle', 'horse', 'ski', 'snowmobile', 'atv', 'motor_vehicle', 'motorcar'];
        allowedUseKeys.forEach(key => displayedKeys.add(key));

        hideMapLoading();
      } else {
        hideMapLoading();
            topoLayer.setAttribution(t('trails.map.attribution'));
