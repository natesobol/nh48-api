# Cloudflare Deployment Instructions

## Summary of Changes

The Cloudflare Worker has been completely rewritten to eliminate rendering inconsistencies. The new worker acts as a **thin proxy** that fetches all HTML templates directly from your GitHub repository, ensuring a single source of truth for all page content.

## Key Changes Made

### 1. Worker.js Updates
- **Added GitHub fetching**: All templates are now loaded from `https://raw.githubusercontent.com/natesobol/nh48-api/main/`
- **Removed legacy logic**: Eliminated all KV-based template storage and mixed rendering methods
- **Simplified routing**: Clean URL handlers for home, catalog, trails, long-trails, and peak pages
- **Prerendered peak pages**: Peak pages are served from the `dist/` directory generated by your prerender script
- **Caching**: GitHub files are cached for 30 minutes (1800 seconds) using Cloudflare's edge cache

### 2. Wrangler.toml Updates
- **Simplified routes**: Single catch-all route `nh48.info/*` handles all traffic
- **Removed duplicate routes**: No longer need separate `/` and `/*` patterns
- **Kept R2 binding**: NH48_DATA bucket binding preserved for optional fallback

## Cloudflare Dashboard Actions Required

### A. Verify DNS Records (Already Configured)
Based on your screenshots, you have:
- **Type A**: `nh48.info` → Multiple IPs (185.199.x.x) - ✅ Correct
- **Type R2**: `photos.nh48.info` → `nh48-photos` bucket - ✅ Correct  
- **Type R2**: `plants.nh48.info` → `howker-plants` bucket - ✅ Correct
- **Type CNAME**: `www` → `nh48.info` - ✅ Correct

**No DNS changes needed.**

### B. Update Worker Routes
1. Navigate to **Workers & Pages** > **nh48-ssr** > **Settings** > **Domains & Routes**
2. Verify the route configuration matches:
   - **Route**: `nh48.info/*`
   - **Zone**: `nh48.info`
3. Remove any conflicting routes if present

### C. Deploy the Updated Worker
Run from your workspace:
```bash
cd /workspaces/nh48-api
wrangler deploy
```

This will:
- Upload the new `worker.js` with GitHub template fetching
- Apply the simplified route configuration
- Maintain your R2 bucket bindings

### D. Verify Worker Bindings
In the Cloudflare dashboard:
1. Go to **Workers & Pages** > **nh48-ssr** > **Settings** > **Variables**
2. Confirm the R2 bucket binding exists:
   - **Variable name**: `NH48_DATA`
   - **Bucket name**: `nh48-data`

### E. Test the Deployment
After deploying, test these URLs:
- **Home**: https://nh48.info/
- **French Home**: https://nh48.info/fr/
- **Catalog**: https://nh48.info/catalog
- **Trails**: https://nh48.info/trails
- **Peak Example**: https://nh48.info/peak/washington
- **French Peak**: https://nh48.info/fr/peak/washington

All pages should load correctly with consistent rendering from GitHub templates.

## How the New System Works

### Template Fetching Flow
1. **Request arrives** → Worker receives request for `/catalog`
2. **Route matching** → Worker identifies this as a catalog page
3. **Fetch from GitHub** → Worker fetches `catalog/index.html` from GitHub
4. **Inject nav/footer** → Worker fetches `pages/nav.html` and `pages/footer.html`
5. **Add metadata** → Worker injects SEO meta tags and structured data
6. **Return response** → Complete HTML sent to browser
7. **Edge caching** → Cloudflare caches the GitHub files for 30 minutes

### Peak Page Rendering
Peak pages use **prerendered static HTML**:
1. Your GitHub Actions runs `scripts/prerender-peaks.js` on each commit
2. Script generates `dist/en/{slug}/index.html` and `dist/fr/{slug}/index.html`
3. Worker fetches these prerendered pages directly from GitHub
4. No dynamic rendering needed - all metadata is already in the HTML

### Benefits of This Approach
- ✅ **Single source of truth**: All pages come from GitHub repository
- ✅ **No conflicts**: Eliminates mixing of rendering methods
- ✅ **Easy updates**: Edit templates in GitHub, changes reflected in ~30 min
- ✅ **Consistent behavior**: Same logic for all page types
- ✅ **Fast performance**: Cloudflare edge caching + GitHub CDN
- ✅ **Simple debugging**: Clear flow from request → GitHub fetch → response

## Recommendations

### 1. Pin to a Specific Commit (Optional but Recommended)
For production stability, consider using a commit SHA instead of `main` branch:

In `worker.js`, change:
```javascript
const BRANCH = 'main';
```
To:
```javascript
const BRANCH = '17bb004d843e47ed96c40d417fcef9e1e941c9e3'; // or latest stable commit
```

This prevents breaking changes from affecting production until you explicitly update the commit hash.

### 2. Set Up GitHub Actions for Prerendering
Ensure your `.github/workflows/` includes a job that:
```yaml
- name: Prerender peak pages
  run: node scripts/prerender-peaks.js
- name: Commit prerendered pages
  run: |
    git add dist/
    git commit -m "Prerender peak pages"
    git push
```

This keeps the `dist/` directory up to date with the latest peak data.

### 3. Monitor Cache Behavior
The worker caches GitHub files for 30 minutes. If you need immediate updates:
- Clear Cloudflare cache: Dashboard → Caching → Purge Everything
- Or wait 30 minutes for automatic refresh

### 4. Consider Cache-Control Headers
The worker currently sets:
- `Cache-Control: public, max-age=0, s-maxage=1800`

This means:
- Browsers always revalidate (max-age=0)
- Cloudflare edge caches for 30 minutes (s-maxage=1800)

Adjust these values based on your update frequency needs.

## Troubleshooting

### Pages Not Loading
- Check browser console for errors
- Verify GitHub repository is public
- Confirm `pages/` directory contains all expected templates

### Stale Content
- Purge Cloudflare cache
- Check that `BRANCH` in worker.js points to correct branch/commit
- Verify GitHub Actions successfully ran prerender script

### 404 Errors on Peak Pages
- Confirm `dist/{lang}/{slug}/index.html` exists in GitHub
- Run prerender script: `node scripts/prerender-peaks.js`
- Check worker logs in Cloudflare dashboard

### Performance Issues
- Enable Cloudflare's "Under Attack Mode" temporarily if needed
- Review Cloudflare Analytics for request patterns
- Consider increasing cache TTL if content updates are infrequent

## Next Steps

1. **Deploy the worker**: `wrangler deploy`
2. **Test all routes**: Use the test URLs above
3. **Monitor for issues**: Check Cloudflare analytics and logs
4. **Update documentation**: Document any custom configurations

## Support

If you encounter issues:
- Check Cloudflare Worker logs: Dashboard → Workers & Pages → nh48-ssr → Logs
- Review GitHub Actions runs: Repository → Actions
- Test with `wrangler tail` for real-time log streaming
