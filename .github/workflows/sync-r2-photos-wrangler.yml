name: Sync R2 photos with Wrangler

on:
  push:
    branches:
      - main
    paths:
      - 'photos/**'
      - '.github/workflows/sync-r2-photos-wrangler.yml'
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: sync-r2-photos-${{ github.ref }}
  cancel-in-progress: true

jobs:
  upload-to-r2:
    runs-on: ubuntu-latest

    steps:
      # Checkout your repository so the workflow has access to the photos directory
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install AWS CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3-pip unzip
          python3 -m pip install --upgrade pip
          pip install awscli==1.* --upgrade

      - name: Sync photos to R2 (S3 API)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          set -euo pipefail

          if [ -z "${R2_ENDPOINT}" ]; then
            ENDPOINT="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"
          else
            ENDPOINT="${R2_ENDPOINT}"
          fi

          echo "Syncing ./photos to bucket ${R2_BUCKET_NAME} at ${ENDPOINT}"
          aws s3 sync "./photos" "s3://${R2_BUCKET_NAME}" \
            --endpoint-url "${ENDPOINT}" \
            --exclude ".*" \
            --exclude "*/.*"

  update-manifest-and-pages:
    needs: upload-to-r2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install manifest generator dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pillow
          python -m pip install awscli==1.* --upgrade
          sudo apt-get update -y
          sudo apt-get install -y libimage-exiftool-perl

      - name: Generate photo manifest
        run: |
          python scripts/manifest_generator.py \
            --api data/nh48.json \
            --photos photos \
            --base-url https://photos.nh48.info \
            --write-photo-metadata \
            --output data/nh48.json

      - name: Re-sync photos with embedded metadata
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          set -euo pipefail
          ENDPOINT="${R2_ENDPOINT:-https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com}"
          aws s3 sync "./photos" "s3://${R2_BUCKET_NAME}" \
            --endpoint-url "$ENDPOINT" \
            --exclude ".*" \
            --exclude "*/.*"

      - name: Prerender peak pages
        run: node scripts/prerender-peaks.js

      - name: Commit updated data and pages
        run: |
          git config user.name "NH48 Automation Bot"
          git config user.email "bot@example.com"
          git add data/nh48.json peaks fr/peaks
          git commit -m "Auto-update manifest and prerendered pages after photo upload" || echo "No changes to commit"
          git push
