name: Sync R2 photos with Wrangler

# This workflow runs whenever files in the photos directory change on the default branch
on:
  push:
    paths:
      - 'photos/**'

jobs:
  upload-to-r2:
    runs-on: ubuntu-latest

    steps:
      # Checkout your repository so the workflow has access to the photos directory
      - name: Checkout code
        uses: actions/checkout@v4

      # Install Wrangler globally
      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Install AWS CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y awscli

      - name: Sync photos to R2 (S3 API)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          set -euo pipefail

          if [ -z "${R2_ENDPOINT}" ]; then
            ENDPOINT="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"
          else
            ENDPOINT="${R2_ENDPOINT}"
          fi

          echo "Syncing ./photos to bucket ${R2_BUCKET_NAME} at ${ENDPOINT}"
          aws s3 sync "./photos" "s3://${R2_BUCKET_NAME}" \
            --endpoint-url "${ENDPOINT}" \
            --exclude ".*" \
            --exclude "*/.*"
