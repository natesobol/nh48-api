name: Sync R2 photos with Wrangler

on:
  push:
    branches:
      - main
    paths:
      - 'photos/**'
      - '.github/workflows/sync-r2-photos-wrangler.yml'
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: sync-r2-photos-${{ github.ref }}
  cancel-in-progress: true

jobs:
  upload-to-r2:
    runs-on: ubuntu-latest

    steps:
      # Checkout your repository so the workflow has access to the photos directory
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install AWS CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3-pip unzip
          python3 -m pip install --upgrade pip
          pip install awscli==1.* --upgrade

      - name: Sync photos to R2 (S3 API)
        env:
          WIKI_R2_ACCESS_KEY_ID: ${{ secrets.WIKI_R2_ACCESS_KEY_ID }}
          WIKI_R2_SECRET_ACCESS_KEY: ${{ secrets.WIKI_R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
          AWS_REGION: auto
          AWS_EC2_METADATA_DISABLED: true
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          WIKI_R2_ACCOUNT_ID: ${{ secrets.WIKI_R2_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          WIKI_R2_BUCKET_NAME: ${{ secrets.WIKI_R2_BUCKET_NAME }}
        run: |
          set -euo pipefail

          ACCOUNT_ID="${R2_ACCOUNT_ID:-${WIKI_R2_ACCOUNT_ID:-}}"
          BUCKET="${R2_BUCKET_NAME:-${R2_BUCKET:-}}"

          if [ -z "${WIKI_R2_ACCESS_KEY_ID:-}" ] || [ -z "${WIKI_R2_SECRET_ACCESS_KEY:-}" ]; then
            echo "Missing required wiki auth secrets: WIKI_R2_ACCESS_KEY_ID and WIKI_R2_SECRET_ACCESS_KEY."
            exit 1
          fi
          AWS_ACCESS_KEY_ID="${WIKI_R2_ACCESS_KEY_ID}"
          AWS_SECRET_ACCESS_KEY="${WIKI_R2_SECRET_ACCESS_KEY}"
          export AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY

          echo "Using credential source: WIKI_R2_* (forced for photos S3 auth)"

          if [ -z "${ACCOUNT_ID}" ]; then
            echo "Missing account id. Set R2_ACCOUNT_ID (or WIKI_R2_ACCOUNT_ID fallback)."
            exit 1
          fi
          if [ -z "${BUCKET}" ]; then
            echo "Missing bucket name. Set R2_BUCKET_NAME or R2_BUCKET."
            exit 1
          fi

          if [ -n "${WIKI_R2_BUCKET_NAME:-}" ] && [ "${BUCKET}" = "${WIKI_R2_BUCKET_NAME}" ]; then
            echo "Photo sync resolved to WIKI_R2_BUCKET_NAME. Set R2_BUCKET_NAME/R2_BUCKET to the photos bucket."
            exit 1
          fi

          if [ -n "${R2_ENDPOINT:-}" ] && [[ "${R2_ENDPOINT}" =~ ^https://([a-z0-9-]+)\.r2\.cloudflarestorage\.com/?$ ]]; then
            ENDPOINT_ACCOUNT_ID="${BASH_REMATCH[1]}"
            if [ "${ENDPOINT_ACCOUNT_ID}" = "${ACCOUNT_ID}" ]; then
              ENDPOINT="${R2_ENDPOINT}"
            else
              echo "Ignoring R2_ENDPOINT account mismatch (${ENDPOINT_ACCOUNT_ID} != ${ACCOUNT_ID}); using account endpoint fallback."
              ENDPOINT="https://${ACCOUNT_ID}.r2.cloudflarestorage.com"
            fi
          else
            if [ -n "${R2_ENDPOINT:-}" ]; then
              echo "Ignoring invalid R2_ENDPOINT for S3 signing; using account endpoint fallback."
            fi
            ENDPOINT="https://${ACCOUNT_ID}.r2.cloudflarestorage.com"
          fi
          ENDPOINT="${ENDPOINT%/}"

          aws --version
          aws s3api list-objects-v2 \
            --bucket "${BUCKET}" \
            --max-keys 1 \
            --endpoint-url "${ENDPOINT}" >/dev/null

          echo "Syncing ./photos to bucket ${BUCKET} at ${ENDPOINT}"
          aws s3 sync "./photos" "s3://${BUCKET}" \
            --endpoint-url "${ENDPOINT}" \
            --exclude ".*" \
            --exclude "*/.*"

  update-manifest-and-pages:
    needs: upload-to-r2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install manifest generator dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pillow
          python -m pip install awscli==1.* --upgrade
          sudo apt-get update -y
          sudo apt-get install -y libimage-exiftool-perl

      - name: Generate photo manifest
        run: |
          python scripts/manifest_generator.py \
            --api data/nh48.json \
            --photos photos \
            --base-url https://photos.nh48.info \
            --write-photo-metadata \
            --output data/nh48.json

      - name: Re-sync photos with embedded metadata
        env:
          WIKI_R2_ACCESS_KEY_ID: ${{ secrets.WIKI_R2_ACCESS_KEY_ID }}
          WIKI_R2_SECRET_ACCESS_KEY: ${{ secrets.WIKI_R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
          AWS_REGION: auto
          AWS_EC2_METADATA_DISABLED: true
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          WIKI_R2_ACCOUNT_ID: ${{ secrets.WIKI_R2_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          WIKI_R2_BUCKET_NAME: ${{ secrets.WIKI_R2_BUCKET_NAME }}
        run: |
          set -euo pipefail

          ACCOUNT_ID="${R2_ACCOUNT_ID:-${WIKI_R2_ACCOUNT_ID:-}}"
          BUCKET="${R2_BUCKET_NAME:-${R2_BUCKET:-}}"

          if [ -z "${WIKI_R2_ACCESS_KEY_ID:-}" ] || [ -z "${WIKI_R2_SECRET_ACCESS_KEY:-}" ]; then
            echo "Missing required wiki auth secrets: WIKI_R2_ACCESS_KEY_ID and WIKI_R2_SECRET_ACCESS_KEY."
            exit 1
          fi
          AWS_ACCESS_KEY_ID="${WIKI_R2_ACCESS_KEY_ID}"
          AWS_SECRET_ACCESS_KEY="${WIKI_R2_SECRET_ACCESS_KEY}"
          export AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY

          echo "Using credential source: WIKI_R2_* (forced for photos S3 auth)"

          if [ -z "${ACCOUNT_ID}" ]; then
            echo "Missing account id. Set R2_ACCOUNT_ID (or WIKI_R2_ACCOUNT_ID fallback)."
            exit 1
          fi
          if [ -z "${BUCKET}" ]; then
            echo "Missing bucket name. Set R2_BUCKET_NAME or R2_BUCKET."
            exit 1
          fi

          if [ -n "${WIKI_R2_BUCKET_NAME:-}" ] && [ "${BUCKET}" = "${WIKI_R2_BUCKET_NAME}" ]; then
            echo "Photo sync resolved to WIKI_R2_BUCKET_NAME. Set R2_BUCKET_NAME/R2_BUCKET to the photos bucket."
            exit 1
          fi

          if [ -n "${R2_ENDPOINT:-}" ] && [[ "${R2_ENDPOINT}" =~ ^https://([a-z0-9-]+)\.r2\.cloudflarestorage\.com/?$ ]]; then
            ENDPOINT_ACCOUNT_ID="${BASH_REMATCH[1]}"
            if [ "${ENDPOINT_ACCOUNT_ID}" = "${ACCOUNT_ID}" ]; then
              ENDPOINT="${R2_ENDPOINT}"
            else
              echo "Ignoring R2_ENDPOINT account mismatch (${ENDPOINT_ACCOUNT_ID} != ${ACCOUNT_ID}); using account endpoint fallback."
              ENDPOINT="https://${ACCOUNT_ID}.r2.cloudflarestorage.com"
            fi
          else
            if [ -n "${R2_ENDPOINT:-}" ]; then
              echo "Ignoring invalid R2_ENDPOINT for S3 signing; using account endpoint fallback."
            fi
            ENDPOINT="https://${ACCOUNT_ID}.r2.cloudflarestorage.com"
          fi
          ENDPOINT="${ENDPOINT%/}"

          aws --version
          aws s3api list-objects-v2 \
            --bucket "${BUCKET}" \
            --max-keys 1 \
            --endpoint-url "${ENDPOINT}" >/dev/null

          aws s3 sync "./photos" "s3://${BUCKET}" \
            --endpoint-url "${ENDPOINT}" \
            --exclude ".*" \
            --exclude "*/.*"

      - name: Prerender peak pages
        run: node scripts/prerender-peaks.js

      - name: Commit updated data and pages
        run: |
          git config user.name "NH48 Automation Bot"
          git config user.email "bot@example.com"
          git add data/nh48.json peaks fr/peaks
          git commit -m "Auto-update manifest and prerendered pages after photo upload" || echo "No changes to commit"
          git push
