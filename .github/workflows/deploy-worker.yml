name: Deploy Cloudflare Worker

on:
  push:
    branches: [main]
    paths:
      - 'worker.js'
      - 'wrangler.toml'
      - 'data/entity-links.json'
      - 'data/person.json'
      - 'data/organization.json'
      - 'data/website.json'
      - 'data/peak-sameas.json'
      - 'data/peak-sameas.overrides.json'
      - 'data/parking-data.json'
      - 'data/monthly-weather.json'
      - 'data/peak-difficulty.json'
      - 'data/peak-difficulty-overrides.json'
      - 'data/current-conditions.json'
      - 'data/nh48_enriched_overlay.json'
      - 'data/wiki/mountain-sets.json'
      - 'data/wiki/wiki-nh48-mountains.json'
      - 'data/wiki/wiki-nh52wav-mountains.json'
      - 'data/wiki/plants.json'
      - 'data/wiki/animals.json'
      - 'scripts/audit-site-schema.js'
      - 'scripts/audit-homepage-worker-seo.js'
      - 'scripts/audit-worker-breadcrumbs.js'
      - 'scripts/audit-wiki-routes.js'
      - 'scripts/audit-live-peak-seo-parity.js'
      - 'scripts/audit-peak-guide-authority.js'
      - 'scripts/audit-peak-page-ui.js'
      - 'scripts/audit-peak-data-coverage.js'
      - 'scripts/audit-peak-image-metadata.js'
      - 'scripts/audit-peak-schema-parity.js'
      - 'scripts/audit-sameas.js'
      - 'scripts/audit-entity-links.js'
      - 'scripts/build-peak-sameas.py'
      - 'scripts/build-peak-difficulty.js'
      - 'scripts/build-peak-experience-scaffold.js'
      - 'scripts/prerender-peaks.js'
      - 'scripts/generate-sitemaps.js'
      - 'pages/nh48_peak.html'
      - 'pages/nav.html'
      - 'pages/wiki/index.html'
      - 'pages/wiki/mountain.html'
      - 'pages/wiki/plant.html'
      - 'pages/wiki/animal.html'
      - 'css/peak-detail.css'
      - 'css/wiki.css'
      - 'js/wiki-landing.js'
      - 'js/wiki-mountain.js'
      - 'js/wiki-species.js'
      - 'tests/peak-page-visual.spec.js'
      - 'playwright.peak-visual.config.js'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/deploy-worker.yml'
      - 'Documentation/README.md'
      - 'Documentation/TESTING_GUIDE.md'
      - 'Documentation/CHANGES_SUMMARY.md'
      - 'Documentation/SEO_SYSTEM_RUNBOOK.md'
      - 'Documentation/PEAK_PAGE_VISUAL_CHECKLIST.md'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read

concurrency:
  group: deploy-worker-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Worker
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Detect worker file changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            worker:
              - 'worker.js'
              - 'wrangler.toml'
            peak_visual:
              - 'worker.js'
              - 'pages/nh48_peak.html'
              - 'css/peak-detail.css'
              - 'scripts/audit-peak-page-ui.js'
              - 'scripts/audit-peak-guide-authority.js'
              - 'scripts/audit-peak-data-coverage.js'
              - 'scripts/audit-peak-image-metadata.js'
              - 'scripts/audit-peak-schema-parity.js'
              - 'tests/peak-page-visual.spec.js'
              - 'playwright.peak-visual.config.js'

      - name: Decide deployment mode
        id: deploy_mode
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" || "${{ steps.changes.outputs.worker }}" == "true" ]]; then
            echo "should_deploy=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_deploy=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run schema audit (pre-deploy gate)
        id: schema_audit
        run: node scripts/audit-site-schema.js

      - name: Run peak guide authority audit (pre-deploy gate)
        id: peak_authority_audit
        run: node scripts/audit-peak-guide-authority.js

      - name: Run peak page UI audit (pre-deploy gate)
        id: peak_ui_audit
        run: node scripts/audit-peak-page-ui.js

      - name: Run peak data coverage audit (pre-deploy gate)
        id: peak_data_coverage_audit
        run: node scripts/audit-peak-data-coverage.js

      - name: Run peak image metadata audit (pre-deploy gate)
        id: peak_image_metadata_audit
        run: node scripts/audit-peak-image-metadata.js

      - name: Run wiki routes audit (pre-deploy gate)
        id: wiki_routes_audit
        run: node scripts/audit-wiki-routes.js

      - name: Run sameAs authority audit (pre-deploy gate)
        id: sameas_audit
        run: node scripts/audit-sameas.js

      - name: Run entity links audit (pre-deploy gate)
        id: entity_links_audit
        run: node scripts/audit-entity-links.js

      - name: Install npm dependencies for peak visual tests
        if: steps.changes.outputs.peak_visual == 'true' || github.event_name == 'workflow_dispatch'
        run: npm ci

      - name: Install Playwright Chromium
        if: steps.changes.outputs.peak_visual == 'true' || github.event_name == 'workflow_dispatch'
        run: npx playwright install --with-deps chromium

      - name: Run peak visual snapshots
        id: peak_visual_test
        if: steps.changes.outputs.peak_visual == 'true' || github.event_name == 'workflow_dispatch'
        run: npm run test:peak-visual

      - name: Upload peak visual artifacts on failure
        if: failure() && (steps.changes.outputs.peak_visual == 'true' || github.event_name == 'workflow_dispatch')
        uses: actions/upload-artifact@v4
        with:
          name: peak-visual-artifacts
          path: |
            test-results/
            playwright-report-peak-visual/
          if-no-files-found: ignore

      - name: Install Wrangler
        if: steps.deploy_mode.outputs.should_deploy == 'true'
        run: npm install -g wrangler

      - name: Deploy to Cloudflare Workers
        id: deploy_worker
        if: steps.deploy_mode.outputs.should_deploy == 'true'
        run: wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Run production SEO audits with retry
        id: production_audits
        run: |
          set -euo pipefail
          LOG_FILE="${RUNNER_TEMP}/production-audits.log"
          node scripts/audit-live-peak-seo-parity.js \
            --url "https://nh48.info" \
            --retries 6 \
            --delay-seconds 20 \
            --log-file "${LOG_FILE}"

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Worker Deploy + SEO Audit Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Target URL:** https://nh48.info" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Deploy requested:** \`${{ steps.deploy_mode.outputs.should_deploy }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Schema audit:** \`${{ steps.schema_audit.outcome }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Peak authority audit:** \`${{ steps.peak_authority_audit.outcome }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Peak UI audit:** \`${{ steps.peak_ui_audit.outcome }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Peak data coverage audit:** \`${{ steps.peak_data_coverage_audit.outcome }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Peak image metadata audit:** \`${{ steps.peak_image_metadata_audit.outcome }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Wiki routes audit:** \`${{ steps.wiki_routes_audit.outcome }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **sameAs audit:** \`${{ steps.sameas_audit.outcome }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Entity links audit:** \`${{ steps.entity_links_audit.outcome }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Peak visual snapshots:** \`${{ steps.peak_visual_test.outcome }}\`" >> "$GITHUB_STEP_SUMMARY"
          if [[ "${{ steps.deploy_mode.outputs.should_deploy }}" == "true" ]]; then
            echo "- **Deploy step outcome:** \`${{ steps.deploy_worker.outcome }}\`" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- **Deploy step outcome:** \`skipped\`" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "- **Production SEO audits:** \`${{ steps.production_audits.outcome }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Scripts executed" >> "$GITHUB_STEP_SUMMARY"
          echo "- \`node scripts/audit-site-schema.js\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- \`node scripts/audit-peak-guide-authority.js\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- \`node scripts/audit-peak-page-ui.js\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- \`node scripts/audit-peak-data-coverage.js\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- \`node scripts/audit-peak-image-metadata.js\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- \`node scripts/audit-wiki-routes.js\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- \`node scripts/audit-sameas.js\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- \`node scripts/audit-entity-links.js\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- \`npm run test:peak-visual\` (conditional)" >> "$GITHUB_STEP_SUMMARY"
          echo "- \`node scripts/audit-homepage-worker-seo.js --url https://nh48.info\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- \`node scripts/audit-worker-breadcrumbs.js --url https://nh48.info\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- \`node scripts/audit-wiki-routes.js --url https://nh48.info\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- \`node scripts/audit-peak-page-ui.js --url https://nh48.info\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- \`node scripts/audit-peak-schema-parity.js --url https://nh48.info\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- \`node scripts/audit-peak-image-metadata.js --url https://nh48.info\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- \`node scripts/audit-live-peak-seo-parity.js --url https://nh48.info --retries 6 --delay-seconds 20\`" >> "$GITHUB_STEP_SUMMARY"
          if [[ -f "${RUNNER_TEMP}/production-audits.log" ]]; then
            FAIL_LINES="$(grep -E '^- (https://nh48.info/|[a-z0-9-]+:)' "${RUNNER_TEMP}/production-audits.log" | head -n 40 || true)"
            if [[ -n "${FAIL_LINES}" ]]; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "### Production Audit Failures (Last Attempt)" >> "$GITHUB_STEP_SUMMARY"
              echo '```text' >> "$GITHUB_STEP_SUMMARY"
              echo "${FAIL_LINES}" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
            fi
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Time (UTC):** $(date -u)" >> "$GITHUB_STEP_SUMMARY"
