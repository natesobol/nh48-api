name: Pre-render NH48 pages

on:
  push:
    branches: [main]
    paths:
      - 'data/**'
      - 'pages/**'
      - 'scripts/prerender-peaks.js'
      - 'scripts/prerender-long-trails.js'
      - 'scripts/generate-sitemaps.js'
      - 'scripts/generate-og-cards.py'
      - 'scripts/build-howker-facets.js'
      - 'data/og-card-overrides.json'
      - 'data/howker-plants'
      - 'nh48-planner.html'
      - 'peakid-game.html'
      - 'timed-peakid-game.html'
      - 'pages/puzzle-game.html'
      - '.github/workflows/prerender.yml'
      - '!peaks/**'
      - '!fr/peaks/**'
      - '!long-trails/**'
      - '!photos/og/**'
      - '!sitemap.xml'
      - '!page-sitemap.xml'
      - '!image-sitemap.xml'
      - '!data/og-cards.json'
      - '!data/howker-plants-index.json'
      - '!build-meta.json'
  pull_request:

concurrency:
  group: prerender-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  prerender:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pillow

      - name: Generate static pages and sitemaps
        run: |
          set -euo pipefail
          scripts=(
            scripts/prerender-peaks.js
            scripts/prerender-long-trails.js
            scripts/generate-sitemaps.js
            scripts/build-howker-facets.js
          )
          for script in "${scripts[@]}"; do
            echo "=== Running ${script} ==="
            if [[ "${script}" == *.js ]]; then
              node_cmd=(node "${script}")
            else
              node_cmd=("${script}")
            fi
            if ! "${node_cmd[@]}"; then
              echo "Script failed: ${script}"
              exit 1
            fi
          done
          echo "=== Running scripts/generate-og-cards.py ==="
          python scripts/generate-og-cards.py

      - name: Write build metadata
        run: |
          set -euo pipefail
          build_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          printf '{\"buildDate\":\"%s\"}\\n' "$build_date" > build-meta.json

      - name: Show generated file diffs (debug)
        if: github.event_name == 'pull_request'
        run: |
          echo "=== git status (porcelain) ==="
          git status --porcelain
          echo "=== git diff --name-only ==="
          git --no-pager diff --name-only || true
          echo "=== git diff (full) ==="
          git --no-pager diff || true

      - name: Commit updated renders
        if: github.event_name == 'push'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update prerendered pages"
          file_pattern: |
            peaks/**
            fr/peaks/**
            long-trails/**
            photos/og/**
            build-meta.json
            sitemap.xml
            page-sitemap.xml
            image-sitemap.xml
            data/og-cards.json
            data/howker-plants-index.json
            nh48-planner.html
            peakid-game.html
            timed-peakid-game.html
            pages/puzzle-game.html

  auto-commit-pr:
    runs-on: ubuntu-latest
    needs: prerender
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          fetch-depth: 0

      - name: Auto-commit renders for PRs from this repo
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update prerendered pages"
          file_pattern: |
            peaks/**
            fr/peaks/**
            long-trails/**
            photos/og/**
            build-meta.json
            sitemap.xml
            page-sitemap.xml
            image-sitemap.xml
            data/og-cards.json
            data/howker-plants-index.json
            nh48-planner.html
            peakid-game.html
            timed-peakid-game.html
            pages/puzzle-game.html

      - name: Verify no uncommitted changes
        if: github.event_name == 'pull_request'
        run: git diff --quiet --exit-code || (echo "Please run prerender scripts and commit the generated files." && exit 1)
