<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- Favicons - ICO format preferred for Google compatibility -->
<link rel="icon" href="/favicons/favicon.ico" sizes="48x48" />
<link rel="icon" type="image/x-icon" href="/favicons/favicon.ico" />
<link rel="shortcut icon" href="/favicons/favicon.ico" />
<link rel="icon" type="image/x-icon" sizes="16x16" href="/favicons/favicon-16x16.ico" />
<link rel="icon" type="image/x-icon" sizes="32x32" href="/favicons/favicon-32x32.ico" />
<link rel="icon" type="image/x-icon" sizes="48x48" href="/favicons/favicon-48x48.ico" />
<link rel="icon" type="image/x-icon" sizes="96x96" href="/favicons/favicon-96x96.ico" />
<!-- PNG fallbacks for browsers that prefer PNG -->
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32.png" />
<link rel="icon" type="image/png" sizes="48x48" href="/favicons/favicon-48x48.png" />
<link rel="icon" type="image/png" sizes="96x96" href="/favicons/favicon-96x96.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png" />
<link rel="manifest" href="/manifest.json" />
<title>Howker Ridge • Plant</title>
<meta id="meta-description" name="description" content="Detailed view for an alpine/subalpine plant observed along Howker Ridge Trail. Explore photos, facts, and notes for the selected species." />
<link rel="canonical" href="https://nh48.info/pages/plant.html" />
<meta property="og:type" content="article" />
<meta property="og:site_name" content="NH48pics" />
<meta property="og:url" content="https://nh48.info/pages/plant.html" />
<meta id="og-image" property="og:image" content="" />
<meta id="og-image-alt" property="og:image:alt" content="" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@nate_dumps_pics" />
<meta name="twitter:creator" content="@nate_dumps_pics" />
<meta id="twitter-image" name="twitter:image" content="" />
<meta id="twitter-image-alt" name="twitter:image:alt" content="" />
<meta id="og-title" property="og:title" content="Howker Ridge • Plant" />
<meta id="og-description" property="og:description" content="Detailed species view for alpine and subalpine plants observed along the Howker Ridge Trail." />
<meta id="twitter-title" name="twitter:title" content="Howker Ridge • Plant" />
<meta id="twitter-description" name="twitter:description" content="Explore species facts, field notes, and photo credits for alpine plants along Howker Ridge." />
<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Howker Ridge Plant",
    "description": "Detailed species view for alpine and subalpine plants observed along the Howker Ridge Trail.",
    "url": "https://nh48.info/pages/plant.html",
    "isPartOf": {
      "@type": "WebSite",
      "name": "NH48pics",
      "url": "https://nh48.info/"
    },
    "breadcrumb": {
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "https://nh48.info/"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Projects",
          "item": "https://nh48.info/plant-catalog"
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": "Howker Ridge Plant Catalog",
          "item": "https://nh48.info/plant-catalog"
        },
        {
          "@type": "ListItem",
          "position": 4,
          "name": "Plant",
          "item": "https://nh48.info/pages/plant.html"
        }
      ]
    }
  }
</script>
<script id="plant-images-jsonld" type="application/ld+json"></script>
<script>
  (() => {
    if (window.NH48_BUILD_DATE) return;
    try {
      const xhr = new XMLHttpRequest();
      xhr.open('GET', '/build-meta.json', false);
      xhr.send(null);
      if (xhr.status >= 200 && xhr.status < 300) {
        const meta = JSON.parse(xhr.responseText);
        if (meta && meta.buildDate) {
          window.NH48_BUILD_DATE = meta.buildDate;
        }
      }
    } catch (err) {
      // No-op: build date is optional in static builds.
    }
  })();
</script>
<script src="/js/unified-footer.js" defer></script>
<script src="/js/howker-plant-icons.js"></script>

<style>
/*
  The majority of this stylesheet mirrors the catalog page.  It defines a dark/light
  theme palette, layout containers, typography, responsive grids, and pagination UI.
  Even though the details page does not use cards or pagination, these styles are
  retained to preserve overall length and consistency across both pages.
*/
/****************************
 * THEME VARIABLES
 ****************************/
:root{
  --bg:#0a0a0a;
  --panel:#12121a;
  --card:#171a22;
  --ink:#ffffff;
  --muted:#a5b4c3;
  --stroke:#ffffff;
  --accent:#22c55e;
  --gap:10px;
}
body.light{
  --bg:#f8fafc;
  --panel:#ffffff;
  --card:#f7f9fc;
  --ink:#1f2937;
  --muted:#6b7280;
  --stroke:#00000022;
  --accent:#22c55e;
}

/****************************
 * GLOBAL RESETS & BASICS
 ****************************/
*{ box-sizing:border-box; }
html{
  min-width:320px;
  scroll-behavior:smooth;
}
@media (prefers-reduced-motion: reduce){
  html{ scroll-behavior:auto; }
}
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;
  text-rendering:optimizeLegibility;
  overflow:auto;
}

/****************************
 * LAYOUT CONTAINERS
 ****************************/
.wrap{
  max-width:1100px;
  margin:24px auto;
  padding:16px;
}
.panel{
  background:var(--panel);
  border:none;
  border-radius:14px;
  padding:20px 20px 24px;
  box-shadow:0 10px 30px #0004;
  overflow:hidden;
}

/****************************
 * TYPOGRAPHY
 ****************************/
header h1{
  margin:0 0 8px;
  font-size:clamp(20px,3.2vw,28px);
  letter-spacing:.2px;
  line-height:1.2;
}
header p{
  margin:0;
  color:var(--muted);
}
header.plant-hero{
  position:relative;
  padding:36px 24px;
  border-radius:14px;
  background-image:url('https://howker.nh48.info/blueberry-ledge/blueberry-ledge-001.jpg');
  background-size:cover;
  background-position:center 68%;
  color:#f6f7fb;
  overflow:hidden;
}
header.plant-hero::before{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(120deg, rgba(6,9,16,0.7), rgba(6,9,16,0.35));
}
header.plant-hero blockquote{
  position:relative;
  margin:0;
  z-index:1;
  max-width:calc(100% - 220px);
}
header.plant-hero h1{
  color:inherit;
  text-shadow:0 8px 24px rgba(0,0,0,0.55);
}
.title-with-icon{
  display:inline-flex;
  align-items:center;
  gap:10px;
}
.title-icon{
  width:22px;
  height:22px;
  object-fit:contain;
  flex:0 0 auto;
}
.hero-actions{
  position:absolute;
  top:16px;
  right:16px;
  z-index:2;
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:8px;
}
.share-card-menu{
  position:relative;
}
.share-card-btn{
  border:1px solid rgba(255,255,255,0.45);
  color:#ffffff;
  background:rgba(12,16,24,0.72);
  border-radius:999px;
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-weight:700;
  font-size:13px;
  line-height:1;
  padding:10px 14px;
  cursor:pointer;
  transition:background 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
}
.share-card-btn:hover{
  background:rgba(8,12,18,0.88);
  border-color:var(--accent);
  transform:translateY(-1px);
}
.share-card-btn:focus-visible{
  outline:2px solid var(--accent);
  outline-offset:2px;
}
.share-card-btn[disabled]{
  opacity:0.7;
  cursor:wait;
  transform:none;
}
.share-card-dropdown{
  position:absolute;
  top:calc(100% + 8px);
  right:0;
  min-width:250px;
  max-width:min(320px, calc(100vw - 24px));
  max-height:320px;
  overflow:auto;
  padding:8px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(8,12,19,0.94);
  box-shadow:0 20px 44px rgba(0,0,0,0.42);
  backdrop-filter:blur(6px);
}
.share-card-dropdown[hidden]{
  display:none !important;
}
.share-card-option{
  width:100%;
  border:1px solid transparent;
  background:transparent;
  color:#f4f9ff;
  border-radius:8px;
  font-size:13px;
  font-weight:600;
  text-align:left;
  padding:8px 10px;
  cursor:pointer;
}
.share-card-option:hover{
  background:rgba(34,197,94,0.12);
  border-color:rgba(34,197,94,0.28);
}
.share-card-option:focus-visible{
  outline:2px solid var(--accent);
  outline-offset:1px;
}
.share-card-option[disabled]{
  opacity:0.6;
  cursor:wait;
}
.share-card-option.download{
  font-weight:700;
}
.share-card-divider{
  height:1px;
  margin:6px 4px;
  background:rgba(255,255,255,0.14);
}
.share-card-group-title{
  margin:6px 8px 4px;
  font-size:11px;
  font-weight:700;
  color:#95a8c2;
  text-transform:uppercase;
  letter-spacing:0.08em;
}
.share-card-status{
  margin:0;
  min-height:1.2em;
  max-width:280px;
  text-align:right;
  font-size:12px;
  color:#dbe7f3;
  text-shadow:0 2px 8px rgba(0,0,0,0.4);
}
.share-card-status.error{
  color:#fca5a5;
}
header.plant-hero.sticky{
  background-image:none;
  background-color:var(--panel);
  color:var(--ink);
}
header.plant-hero.sticky::before{
  content:none;
}
header.plant-hero.sticky h1{
  text-shadow:none;
}
header.plant-hero.sticky .share-card-btn{
  background:rgba(34,197,94,0.14);
  border-color:rgba(34,197,94,0.5);
  color:var(--ink);
}
header.plant-hero.sticky .share-card-dropdown{
  border-color:rgba(34,197,94,0.28);
  background:rgba(13,18,28,0.96);
}
header.plant-hero.sticky .share-card-option{
  color:var(--ink);
}
header.plant-hero.sticky .share-card-group-title{
  color:var(--muted);
}
header.plant-hero.sticky .share-card-status{
  color:var(--muted);
  text-shadow:none;
}
header.plant-hero.sticky .share-card-status.error{
  color:#dc2626;
}

.page-breadcrumbs{
  margin:6px 0 16px;
  font-size:13px;
  color:var(--muted);
}
.page-breadcrumbs ol{
  list-style:none;
  padding:0;
  margin:0;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.page-breadcrumbs li::after{
  content:"/";
  margin-left:6px;
  color:var(--muted);
}
.page-breadcrumbs li:last-child::after{
  content:"";
}
.page-breadcrumbs a{
  color:inherit;
  text-decoration:none;
}
.page-breadcrumbs a:hover{
  color:var(--accent);
}
.text-guide{
  font-size:0.9rem;
  margin:0 0 1rem;
}

/****************************
 * DETAILS PAGE ELEMENTS
 ****************************/
/* The details view uses a carousel similar to the catalog drawer. */
.media{
  background:var(--card);
  border:1px solid var(--stroke);
  border-radius:12px;
  overflow:hidden;
  margin:16px 0 20px;
  position:relative;
  aspect-ratio:4/3;
  min-height:clamp(240px, 60vw, 520px);
  box-sizing:border-box;
  box-shadow:0 18px 46px rgba(0,0,0,0.35);
  width:100%;
}
@media (min-width:1024px){
  .media{
    aspect-ratio:5/3;
    width:100%;
    max-width:100%;
  }
}
.media-loading{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
  z-index:4;
  background:linear-gradient(to bottom, rgba(10,12,18,0.08), rgba(10,12,18,0.2));
}
.media-loading[hidden]{
  display:none;
}
.loading-spinner{
  border-radius:50%;
  border-style:solid;
  border-color:rgba(34,197,94,0.24);
  border-top-color:var(--accent);
  animation:spin 0.9s linear infinite;
}
.loading-spinner.large{
  width:58px;
  height:58px;
  border-width:6px;
  box-shadow:0 8px 24px rgba(0,0,0,0.35);
}
.loading-spinner.small{
  width:25px;
  height:25px;
  border-width:3px;
}
@keyframes spin{ to{ transform:rotate(360deg); } }
.carousel{
  position:relative;
  width:100%;
  height:100%;
  overflow:hidden;
}
.slide{
  position:absolute;
  inset:0;
  opacity:0;
  transition:opacity .35s ease;
}
.slide.active{
  opacity:1;
}
.slide figure{
  margin:0;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:6px;
  box-sizing:border-box;
  height:100%;
}
.slide figure img{
  max-height:100%;
  width:100%;
  height:100%;
  object-fit:contain;
  object-position:center;
  display:block;
  border-radius:8px;
}
.dots{
  position:absolute;
  bottom:12px;
  left:12px;
  right:12px;
  display:flex;
  gap:10px;
  padding:10px;
  background:rgba(10,10,10,0.55);
  border:1px solid rgba(255,255,255,0.18);
  border-radius:12px;
  overflow-x:auto;
  z-index:2;
}
.dot{
  width:70px;
  height:46px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.35);
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
  background-color:#0f1118;
  cursor:pointer;
  opacity:0.8;
  transition:transform 0.2s ease, opacity 0.2s ease, border-color 0.2s ease;
  flex:0 0 auto;
  padding:0;
  appearance:none;
  position:relative;
  overflow:hidden;
}
.dot-loading{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(to bottom, rgba(6,8,12,0.28), rgba(6,8,12,0.52));
  pointer-events:none;
}
.dot.ready .dot-loading,
.dot-loading.hidden{
  display:none;
}
.dot:focus-visible{
  outline:2px solid var(--accent);
  outline-offset:2px;
}
.dot:hover{ opacity:1; transform:translateY(-2px); }
.dot.active{
  opacity:1;
  border-color:var(--accent);
  box-shadow:0 10px 24px rgba(0,0,0,0.35);
}
.ctrls{
  position:absolute;
  inset:0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  pointer-events:none;
}
.ctrls button{
  pointer-events:auto;
  background:rgba(10,10,10,0.5);
  border:1px solid rgba(255,255,255,0.45);
  color:#ffffff;
  border-radius:50%;
  width:42px;
  height:42px;
  padding:0;
  margin:0 10px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.25rem;
  box-shadow:0 12px 28px rgba(0,0,0,0.35);
  transition:transform 0.2s ease, background 0.2s ease, border-color 0.2s ease;
}
.ctrls button:hover{ background:rgba(10,10,10,0.7); border-color:var(--accent); transform:translateY(-1px); }
.ctrls button:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; }

/* Countdown timer styles ---------------------------------------------- */
.timer{
  position:absolute;
  top:8px;
  right:8px;
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 8px;
  background:rgba(0,0,0,0.35);
  border-radius:12px;
  z-index:3;
}
.timer-visual{
  position:relative;
  width:56px;
  height:56px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.timer svg{
  width:100%;
  height:100%;
  transform:rotate(-90deg);
}
.timer-ring{
  fill:none;
  stroke:var(--accent);
  stroke-width:4;
  stroke-linecap:round;
  transition:stroke-dashoffset 0.1s linear;
}
.timer-text{
  position:absolute;
  color:var(--accent);
  font-size:0.8rem;
  font-weight:600;
  pointer-events:none;
}
.timer-pause{
  background:rgba(255,255,255,0.15);
  color:var(--accent);
  border:1px solid rgba(255,255,255,0.25);
  border-radius:50%;
  width:32px;
  height:32px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  cursor:pointer;
  transition:background 0.2s ease, transform 0.2s ease;
}
.timer-pause:focus-visible{
  outline:2px solid var(--accent);
  outline-offset:2px;
}
.timer-pause:hover{
  background:rgba(255,255,255,0.25);
  transform:scale(1.02);
}
.content{
  padding:14px;
  overflow-wrap:break-word;
  hyphens:auto;
}
.facts{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
@media(max-width:560px){
  .facts{ grid-template-columns:1fr; }
}
.fact{
  background:var(--card);
  border:1px solid var(--stroke);
  border-radius:10px;
  padding:10px;
}
.fact h4{
  display:flex;
  align-items:center;
  gap:6px;
  margin:0 0 6px;
  padding-bottom:6px;
  border-bottom:1px dotted var(--stroke);
  font-size:12px;
  color:var(--accent);
  letter-spacing:.2px;
  text-transform:uppercase;
}
.field-icon{
  width:14px;
  height:14px;
  object-fit:contain;
  flex:0 0 auto;
}
.fact p{
  margin:0;
  font-size:14px;
}
#f-type{
  display:flex;
  align-items:center;
  gap:8px;
}
.type-value-icon{
  width:16px;
  height:16px;
  object-fit:contain;
  flex:0 0 auto;
}
.section{
  margin-top:12px;
}
.section h3{
  margin:0 0 6px;
  font-size:14px;
}
.section-panel{
  background:var(--card);
  border:1px solid var(--stroke);
  border-radius:10px;
  padding:12px;
  margin-bottom:12px;
}
.section-panel h3{
  margin:0 0 8px;
  padding-bottom:6px;
  border-bottom:1px dotted var(--stroke);
  color:var(--accent);
  font-size:12px;
  letter-spacing:.2px;
  text-transform:uppercase;
}
.section-panel p{
  margin:0;
  line-height:1.55;
}
.section[hidden]{
  display:none;
}

/* Chips / tag row under the title */
.chiprow{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin:8px 0 4px;
}
.chip{
  display:inline-block;
  border:none;
  border-radius:0;
  padding:0;
  font-size:11px;
  color:var(--muted);
  white-space:nowrap;
}

/* Back link styling */
.back-link{
  display:inline-block;
  margin-bottom:16px;
  color:var(--accent);
  font-size:14px;
  text-decoration:none;
}
.back-link:hover{
  text-decoration:underline;
}

/* Hide unused grid/pagination in details page by default.  These definitions
   remain for length consistency but won't be used in this file. */
.grid{ display:none; }
.pager-wrap{ display:none; }
.controls{ display:none; }

/****************************
 * RESPONSIVE BREAKPOINTS
 ****************************/
@media (max-width:480px){
  :root{
    --edge:max(10px, env(safe-area-inset-left), env(safe-area-inset-right));
  }
  .wrap{
    padding:0;
    margin:16px auto;
  }
  .panel{
    width:calc(100% - (2 * var(--edge)));
    margin-inline:var(--edge);
    max-width:none;
    border-radius:12px;
    padding:16px 12px 20px;
  }
  header h1{
    font-size:20px;
  }
  .media{
    margin:12px 0 16px;
    padding:6px;
    max-height:min(65vh, 640px);
  }
  header.plant-hero blockquote{
    max-width:100%;
    padding-right:0;
  }
  .hero-actions{
    position:relative;
    top:auto;
    right:auto;
    margin-top:14px;
    align-items:flex-start;
  }
  .share-card-dropdown{
    left:0;
    right:auto;
    max-width:min(320px, calc(100vw - 40px));
  }
  .share-card-status{
    text-align:left;
    max-width:none;
  }
}
@media (max-width:320px){
  :root{
    --edge:max(8px, env(safe-area-inset-left), env(safe-area-inset-right));
  }
  .panel{
    width:calc(100% - (2 * var(--edge)));
    margin-inline:var(--edge);
    border-radius:10px;
  }
  header h1{
    font-size:18px;
  }
}
</style>

</head>
<body data-route="plant-catalog" data-page="plant-detail">
  <div id="nav-placeholder"></div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const navPlaceholder = document.getElementById('nav-placeholder');
      const activeRoute = document.body.dataset.route || document.body.dataset.page;

      if (navPlaceholder) {
        fetch('/pages/nav.html')
          .then(response => response.text())
          .then(html => {
            navPlaceholder.innerHTML = html;
            const links = navPlaceholder.querySelectorAll('.site-nav-links a');
            links.forEach(link => {
              const routes = (link.dataset.routes || link.dataset.route || '')
                .split(',')
                .map(value => value.trim())
                .filter(Boolean);

              if (routes.includes(activeRoute)) {
                link.classList.add('active');
                link.setAttribute('aria-current', 'page');
              }
            });
            if (window.NH48_I18N && window.NH48_I18N.refreshLangPicker) {
              window.NH48_I18N.refreshLangPicker();
            }
          })
          .catch(err => console.error('Failed to load navigation:', err));
      }
    });
  </script>

<div class="wrap panel" id="plant-detail">
  <header class="plant-hero">
    <blockquote>
      <h1 id="detail-title">Howker Ridge • Plant</h1>
    </blockquote>
    <div class="hero-actions">
      <div id="shareCardMenu" class="share-card-menu">
        <button id="shareCardBtn" class="share-card-btn" type="button" aria-label="Share plant card" aria-haspopup="menu" aria-expanded="false">Share Card ▾</button>
        <div id="shareCardDropdown" class="share-card-dropdown" role="menu" hidden></div>
      </div>
      <p id="shareCardStatus" class="share-card-status" role="status" aria-live="polite" aria-atomic="true"></p>
    </div>
  </header>
  <nav class="page-breadcrumbs" aria-label="Breadcrumb">
    <ol>
      <li><a href="/">Home</a></li>
      <li><a href="/plant-catalog">Projects</a></li>
      <li><a href="/plant-catalog">Howker Ridge Plant Catalog</a></li>
      <li><span id="detail-breadcrumb">Plant</span></li>
    </ol>
  </nav>
  <p class="text-guide">Detailed information for an alpine or subalpine species recorded along Howker Ridge Trail. Use the back link to return to the catalog.</p>

  <!-- Details content -->
  <a href="/plant-catalog" class="back-link">← Back to Catalog</a>
  <header>
    <h2 id="d-title"></h2>
    <div class="latin" id="d-latin"></div>
    <div class="chiprow" id="d-tags"></div>
  </header>
  <div class="media">
    <div class="media-loading" id="carouselLoading" aria-hidden="true" hidden>
      <span class="loading-spinner large" aria-hidden="true"></span>
    </div>
    <div id="carousel" class="carousel" aria-roledescription="carousel" aria-label="Photos" tabindex="0"></div>
    <div id="dots" class="dots" aria-hidden="true"></div>
    <div class="ctrls">
      <button type="button" id="prevBtn" aria-label="Previous image">‹</button>
      <button type="button" id="nextBtn" aria-label="Next image">›</button>
    </div>
    <div class="timer" id="carouselTimer" hidden>
      <div class="timer-visual">
        <svg viewBox="0 0 40 40">
          <circle id="timerRing" class="timer-ring" cx="20" cy="20" r="18"></circle>
        </svg>
        <span id="timerText" class="timer-text"></span>
      </div>
      <button id="carouselPauseBtn" type="button" class="timer-pause" aria-label="Pause carousel" aria-pressed="false" title="Pause carousel">❚❚</button>
    </div>
  </div>
  <div class="content" id="drawerContent">
    <div class="section section-panel" id="sec-desc" hidden>
      <h3>Short Description</h3>
      <p id="d-desc"></p>
    </div>
    <div class="facts">
      <div class="fact"><h4><img class="field-icon" data-field-icon="type" src="" alt="" aria-hidden="true">TYPE</h4><p id="f-type">—</p></div>
      <div class="fact"><h4><img class="field-icon" data-field-icon="elevation" src="" alt="" aria-hidden="true">ELEVATION</h4><p id="f-elev">—</p></div>
      <div class="fact"><h4><img class="field-icon" data-field-icon="habitat" src="" alt="" aria-hidden="true">HABITAT</h4><p id="f-habitat">—</p></div>
      <div class="fact"><h4><img class="field-icon" data-field-icon="bloom-season" src="" alt="" aria-hidden="true">BLOOM / SEASON</h4><p id="f-bloom">—</p></div>
      <div class="fact"><h4><img class="field-icon" data-field-icon="leaf-stem" src="" alt="" aria-hidden="true">LEAF &amp; STEM</h4><p id="f-morph">—</p></div>
      <div class="fact"><h4><img class="field-icon" data-field-icon="similar-species" src="" alt="" aria-hidden="true">SIMILAR SPECIES</h4><p id="f-similar">—</p></div>
      <div class="fact"><h4><img class="field-icon" data-field-icon="ecology" src="" alt="" aria-hidden="true">ECOLOGY</h4><p id="f-ecology">—</p></div>
      <div class="fact"><h4><img class="field-icon" data-field-icon="status" src="" alt="" aria-hidden="true">STATUS</h4><p id="f-status">—</p></div>
    </div>

    <div class="section" id="sec-notes" hidden>
      <h3>Field Notes</h3>
      <ul id="d-notes"></ul>
    </div>

    <div class="section" id="sec-credits" hidden>
      <h3>Photo Credits</h3>
      <p id="d-credits"></p>
    </div>
  </div>
</div>

<script>
  /* =============================================================
     HOWKER RIDGE — PLANT DETAILS (standalone page)
     Focused on rendering a single plant identified by the "id" query parameter.
  ============================================================= */

  /* ---------- Data & State ---------- */
  let PLANTS = [];
  // Carousel state
  let carouselTimer = null;
  let timerInterval = null;
  let carouselIdx = 0;
  let carouselImgs = [];
  let carouselSourceUrls = [];
  let carouselSlideLoaded = [];
  let carouselDotLoaders = [];
  let currentDelay = 8000;
  const BASE_DELAY = 8000;
  let isCarouselPaused = false;
  let currentPlant = null;
  let currentPlantSlug = '';
  const SHARE_CARD_WIDTH = 1080;
  const SHARE_CARD_HEIGHT = 1350;
  const PLANT_ICON_API = window.HOWKER_PLANT_ICONS || null;
  const ICON_FALLBACK = '/assets/icons/plant-catalog-icons/plant.png';

  // DOM helpers
  const $ = s => document.querySelector(s);
  const trackAnalytics = (name, params = {}) => {
    if (window.NH48Analytics?.track) {
      window.NH48Analytics.track(name, params);
      return;
    }
    if (window.NH48_INFO_ANALYTICS?.logEvent) {
      window.NH48_INFO_ANALYTICS.logEvent(name, params);
    }
  };
  const carouselEl = $("#carousel");
  const dotsEl = $("#dots");
  const carouselLoading = document.getElementById('carouselLoading');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const detailTitle = document.getElementById('detail-title');
  const detailBreadcrumb = document.getElementById('detail-breadcrumb');
  const detailHero = document.querySelector('.plant-hero');
  const shareCardMenu = document.getElementById('shareCardMenu');
  const shareCardBtn = document.getElementById('shareCardBtn');
  const shareCardDropdown = document.getElementById('shareCardDropdown');
  const shareCardStatus = document.getElementById('shareCardStatus');
  let shareCardAvailable = false;

  const SHARE_CARD_PLATFORMS = [
    {
      name: 'Facebook',
      category: 'major',
      buildUrl: (share) => `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(share.url)}`
    },
    {
      name: 'X',
      category: 'major',
      buildUrl: (share) => `https://twitter.com/intent/tweet?url=${encodeURIComponent(share.url)}&text=${encodeURIComponent(share.text)}`
    },
    {
      name: 'Threads',
      category: 'major',
      buildUrl: (share) => `https://www.threads.net/intent/post?text=${encodeURIComponent(`${share.text} ${share.url}`)}`
    },
    {
      name: 'LinkedIn',
      category: 'major',
      buildUrl: (share) => `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(share.url)}`
    },
    {
      name: 'Bluesky',
      category: 'major',
      buildUrl: (share) => `https://bsky.app/intent/compose?text=${encodeURIComponent(`${share.text} ${share.url}`)}`
    },
    {
      name: 'Reddit',
      category: 'major',
      buildUrl: (share) => `https://www.reddit.com/submit?url=${encodeURIComponent(share.url)}&title=${encodeURIComponent(share.text)}`
    },
    {
      name: 'WhatsApp',
      category: 'major',
      buildUrl: (share) => `https://wa.me/?text=${encodeURIComponent(`${share.text} ${share.url}`)}`
    },
    {
      name: 'Email',
      category: 'major',
      buildUrl: (share) => `mailto:?subject=${encodeURIComponent(share.text)}&body=${encodeURIComponent(share.url)}`
    },
    {
      name: 'Telegram',
      category: 'international',
      buildUrl: (share) => `https://t.me/share/url?url=${encodeURIComponent(share.url)}&text=${encodeURIComponent(share.text)}`
    },
    {
      name: 'Pinterest',
      category: 'international',
      buildUrl: (share) => `https://www.pinterest.com/pin/create/button/?url=${encodeURIComponent(share.url)}&description=${encodeURIComponent(share.text)}`
    }
  ];

  // Placeholders for images
  const LQ_PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#0f1320"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#a5b4c3" font-family="system-ui" font-size="22">image loading…</text></svg>`
  );
  const PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#0f1320"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#a5b4c3" font-family="system-ui" font-size="22">image unavailable</text></svg>`
  );

  const normalizeTextForWeb = (input) => {
    if (!input) return '';
    let s = String(input);
    s = s
      .replace(/â€”/g, '—')
      .replace(/â€“/g, '–')
      .replace(/â€˜|â€™/g, "'")
      .replace(/â€œ|â€�/g, '"')
      .replace(/Â/g, '');
    s = s.replace(/[—–]/g, ' - ');
    return s.replace(/\s+/g, ' ').trim();
  };

  function updateMeta(id, content){
    if (!content) return;
    let el = document.getElementById(id);
    if (!el) {
      el = document.querySelector(`meta[name="${id}"]`) || document.querySelector(`meta[id="${id}"]`);
    }
    if (!el) {
      el = document.querySelector(`meta[property="${id}"]`);
    }
    if (el) {
      el.setAttribute('content', content);
    }
  }

  function resolveSpeciesIconSrc(plant){
    const resolved = PLANT_ICON_API?.resolveSpeciesIcon?.(plant);
    return String(resolved || '').trim() || ICON_FALLBACK;
  }

  function resolveFieldIconSrc(fieldKey){
    const resolved = PLANT_ICON_API?.resolveFieldIcon?.(fieldKey);
    return String(resolved || '').trim() || ICON_FALLBACK;
  }

  function resolveTypeIconSrc(plant){
    const resolved = PLANT_ICON_API?.resolveTypeIcon?.(plant);
    return String(resolved || '').trim() || resolveSpeciesIconSrc(plant);
  }

  function attachIconFallback(iconEl){
    if (!iconEl || iconEl.dataset.iconFallbackBound === '1') return;
    iconEl.dataset.iconFallbackBound = '1';
    iconEl.addEventListener('error', () => {
      if (iconEl.dataset.iconFallbackApplied === '1') return;
      iconEl.dataset.iconFallbackApplied = '1';
      iconEl.src = ICON_FALLBACK;
    });
  }

  function createDecorativeIcon(src, className){
    const icon = document.createElement('img');
    icon.className = className;
    icon.alt = '';
    icon.setAttribute('aria-hidden', 'true');
    icon.src = String(src || '').trim() || ICON_FALLBACK;
    attachIconFallback(icon);
    return icon;
  }

  function setTitleWithPlantIcon(el, text, plant){
    if (!el) return;
    const label = String(text || '').trim();
    el.textContent = '';
    if (!label) return;
    const wrapper = document.createElement('span');
    wrapper.className = 'title-with-icon';
    wrapper.appendChild(createDecorativeIcon(resolveSpeciesIconSrc(plant), 'title-icon'));
    const textNode = document.createElement('span');
    textNode.textContent = label;
    wrapper.appendChild(textNode);
    el.appendChild(wrapper);
  }

  function setTypeFactValue(plant){
    const typeValueEl = document.getElementById('f-type');
    if (!typeValueEl) return;
    const value = String((plant && plant.type) || '—').trim() || '—';
    typeValueEl.textContent = '';
    typeValueEl.appendChild(createDecorativeIcon(resolveTypeIconSrc(plant), 'type-value-icon'));
    typeValueEl.appendChild(document.createTextNode(value));
  }

  function applyFieldIcons(){
    document.querySelectorAll('img[data-field-icon]').forEach((iconEl) => {
      const key = iconEl.getAttribute('data-field-icon') || '';
      iconEl.src = resolveFieldIconSrc(key);
      attachIconFallback(iconEl);
    });
  }

  function stripCloudflareImageTransform(rawUrl){
    if (!rawUrl) return '';
    try {
      const parsed = new URL(rawUrl, window.location.origin);
      const marker = '/cdn-cgi/image/';
      const markerIndex = parsed.pathname.indexOf(marker);
      if (markerIndex === -1) {
        return parsed.toString();
      }
      const tail = parsed.pathname.slice(markerIndex + marker.length);
      const slashIndex = tail.indexOf('/');
      if (slashIndex === -1) {
        return parsed.toString();
      }
      const originPath = tail.slice(slashIndex + 1);
      return `${parsed.origin}/${originPath}`;
    } catch (_) {
      return rawUrl;
    }
  }

  function buildShareImageProxyUrl(rawUrl, { width = 1600, format = 'jpg' } = {}){
    if (!rawUrl) return '';
    const src = stripCloudflareImageTransform(rawUrl);
    const params = new URLSearchParams();
    params.set('src', src);
    params.set('w', String(Math.max(320, Math.min(4096, Number(width) || 1600))));
    params.set('fmt', String(format || 'jpg').toLowerCase());
    return `/api/howker/share-image?${params.toString()}`;
  }

  function sanitizeFilenamePart(value){
    const normalized = String(value || '')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-+|-+$/g, '')
      .slice(0, 80);
    return normalized || 'plant';
  }

  function formatShareTimestamp(date){
    const d = date instanceof Date ? date : new Date();
    const pad = (n) => String(n).padStart(2, '0');
    return [
      d.getFullYear(),
      pad(d.getMonth() + 1),
      pad(d.getDate())
    ].join('') + '-' + [pad(d.getHours()), pad(d.getMinutes())].join('');
  }

  function getPlantDetailUrl(plant = currentPlant){
    const plantId = String((plant && (plant.id || plant.slug)) || currentPlantSlug || '').trim();
    return plantId
      ? `https://nh48.info/plant/${encodeURIComponent(plantId)}`
      : 'https://nh48.info/plant-catalog';
  }

  function buildPlantSharePayload(plant = currentPlant){
    const url = getPlantDetailUrl(plant);
    const plantName = String((plant && plant.common) || 'Howker Ridge Plant').trim();
    const latinName = String((plant && plant.latin) || '').trim();
    const text = latinName
      ? `${plantName} (${latinName}) from the Howker Ridge Plant Catalog`
      : `${plantName} from the Howker Ridge Plant Catalog`;
    return { url, text };
  }

  function setShareCardMenuOpen(isOpen){
    if (!shareCardBtn || !shareCardDropdown) return;
    const open = Boolean(isOpen);
    shareCardBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
    shareCardDropdown.hidden = !open;
  }

  function setShareCardAvailable(isAvailable){
    shareCardAvailable = Boolean(isAvailable);
    if (!shareCardBtn) return;
    if (!shareCardAvailable) {
      setShareCardMenuOpen(false);
    }
    shareCardBtn.disabled = !shareCardAvailable;
  }

  function setShareCardBusy(isBusy){
    if (!shareCardBtn) return;
    const busy = Boolean(isBusy);
    if (busy) {
      setShareCardMenuOpen(false);
    }
    shareCardBtn.disabled = busy || !shareCardAvailable;
    shareCardBtn.setAttribute('aria-busy', isBusy ? 'true' : 'false');
    shareCardBtn.textContent = busy ? 'Rendering...' : 'Share Card ▾';
    if (shareCardDropdown) {
      shareCardDropdown.querySelectorAll('.share-card-option').forEach((option) => {
        option.disabled = busy || !shareCardAvailable;
      });
    }
  }

  function setShareCardStatus(message, isError = false){
    if (!shareCardStatus) return;
    shareCardStatus.textContent = message || '';
    shareCardStatus.classList.toggle('error', Boolean(isError));
  }

  function buildShareCardMenu(){
    if (!shareCardDropdown) return;
    const sectioned = {
      major: SHARE_CARD_PLATFORMS.filter((platform) => platform.category === 'major'),
      international: SHARE_CARD_PLATFORMS.filter((platform) => platform.category !== 'major')
    };
    const buildOption = ({ label, action, network = '' }) => {
      const safeNetwork = String(network || '');
      return `<button type="button" class="share-card-option${action === 'download' ? ' download' : ''}" role="menuitem" data-action="${action}" data-network="${safeNetwork}">${label}</button>`;
    };
    const majorOptions = sectioned.major.map((platform) => buildOption({
      label: `Share on ${platform.name}`,
      action: 'share-network',
      network: platform.name
    })).join('');
    const internationalOptions = sectioned.international.map((platform) => buildOption({
      label: `Share on ${platform.name}`,
      action: 'share-network',
      network: platform.name
    })).join('');
    shareCardDropdown.innerHTML = [
      buildOption({ label: 'Download PNG', action: 'download' }),
      '<div class="share-card-divider" role="separator"></div>',
      '<p class="share-card-group-title">Major networks</p>',
      majorOptions,
      sectioned.international.length
        ? '<p class="share-card-group-title">More platforms</p>'
        : '',
      internationalOptions
    ].join('');
    setShareCardMenuOpen(false);
  }

  function setCarouselMainLoading(isLoading){
    if (!carouselLoading) return;
    carouselLoading.hidden = !Boolean(isLoading);
  }

  function hideDotLoading(index){
    const loader = carouselDotLoaders[index];
    if (loader) {
      loader.classList.add('hidden');
    }
    const dot = dotsEl?.children?.[index];
    if (dot) {
      dot.classList.add('ready');
    }
  }

  function syncActiveSlideLoading(){
    if (!Array.isArray(carouselImgs) || carouselImgs.length === 0) {
      setCarouselMainLoading(false);
      return;
    }
    const safeIndex = Number.isInteger(carouselIdx) && carouselIdx >= 0
      ? carouselIdx % carouselImgs.length
      : 0;
    setCarouselMainLoading(!Boolean(carouselSlideLoaded[safeIndex]));
  }

  function markSlideLoaded(index){
    carouselSlideLoaded[index] = true;
    hideDotLoading(index);
    if (index === carouselIdx) {
      syncActiveSlideLoading();
    }
  }

  function getSelectedCardImageUrl(){
    if (!Array.isArray(carouselSourceUrls) || carouselSourceUrls.length === 0) {
      return '';
    }
    const safeIndex = Number.isInteger(carouselIdx) && carouselIdx >= 0
      ? carouselIdx % carouselSourceUrls.length
      : 0;
    const source = carouselSourceUrls[safeIndex] || carouselSourceUrls[0] || '';
    if (!source || source === PLACEHOLDER || source === LQ_PLACEHOLDER) {
      return '';
    }
    return source;
  }

  function drawRoundedRectPath(ctx, x, y, w, h, r){
    const radius = Math.max(0, Math.min(r, w / 2, h / 2));
    ctx.beginPath();
    ctx.moveTo(x + radius, y);
    ctx.arcTo(x + w, y, x + w, y + h, radius);
    ctx.arcTo(x + w, y + h, x, y + h, radius);
    ctx.arcTo(x, y + h, x, y, radius);
    ctx.arcTo(x, y, x + w, y, radius);
    ctx.closePath();
  }

  function drawCoverImage(ctx, image, x, y, w, h){
    const srcW = image.naturalWidth || image.width;
    const srcH = image.naturalHeight || image.height;
    if (!srcW || !srcH) return;
    const srcAspect = srcW / srcH;
    const targetAspect = w / h;
    let sx = 0;
    let sy = 0;
    let sw = srcW;
    let sh = srcH;
    if (srcAspect > targetAspect) {
      sw = srcH * targetAspect;
      sx = Math.round((srcW - sw) / 2);
    } else if (srcAspect < targetAspect) {
      sh = srcW / targetAspect;
      sy = Math.round((srcH - sh) / 2);
    }
    ctx.drawImage(image, sx, sy, sw, sh, x, y, w, h);
  }

  function measureWrappedText(ctx, text, maxWidth, maxLines = Number.POSITIVE_INFINITY){
    const normalized = String(text || '').replace(/\s+/g, ' ').trim();
    if (!normalized) {
      return { lines: [], totalLines: 0, truncated: false };
    }
    const words = normalized.split(' ');
    const allLines = [];
    let current = words[0];
    for (let i = 1; i < words.length; i += 1) {
      const test = `${current} ${words[i]}`;
      if (ctx.measureText(test).width <= maxWidth) {
        current = test;
      } else {
        allLines.push(current);
        current = words[i];
      }
    }
    if (current) {
      allLines.push(current);
    }

    const maxAllowedLines = Number.isFinite(maxLines) ? Math.max(1, Math.floor(maxLines)) : Number.POSITIVE_INFINITY;
    let lines = allLines.slice();
    let truncated = false;
    if (Number.isFinite(maxAllowedLines) && lines.length > maxAllowedLines) {
      truncated = true;
      lines = lines.slice(0, maxAllowedLines);
      let last = lines[lines.length - 1].replace(/\s+$/, '');
      while (last.length > 1 && ctx.measureText(`${last}...`).width > maxWidth) {
        last = last.slice(0, -1);
      }
      lines[lines.length - 1] = `${last}...`;
    }
    return {
      lines,
      totalLines: allLines.length,
      truncated
    };
  }

  function wrapTextLines(ctx, text, maxWidth, maxLines){
    return measureWrappedText(ctx, text, maxWidth, maxLines).lines;
  }

  function getTextBlockHeight(lineCount, fontSize, lineHeight){
    const count = Math.max(0, Number(lineCount) || 0);
    if (!count) return 0;
    return fontSize + ((count - 1) * lineHeight);
  }

  function getTextBlockHeightWithDescender(ctx, lineCount, fontSize, lineHeight){
    const blockHeight = getTextBlockHeight(lineCount, fontSize, lineHeight);
    if (!blockHeight) return 0;
    const metrics = ctx.measureText('Ag');
    const descender = metrics.actualBoundingBoxDescent || Math.ceil(fontSize * 0.28);
    return blockHeight + descender;
  }

  function drawTextLinesFromTop(ctx, lines, x, topY, fontSize, lineHeight){
    if (!Array.isArray(lines) || !lines.length) {
      return topY;
    }
    const firstBaseline = topY + fontSize;
    lines.forEach((line, index) => {
      ctx.fillText(line, x, firstBaseline + (index * lineHeight));
    });
    return topY + getTextBlockHeight(lines.length, fontSize, lineHeight);
  }

  function measureTagPills(ctx, tags, maxWidth, options = {}){
    const pills = Array.isArray(tags)
      ? tags.map((tag) => String(tag || '').trim().toUpperCase()).filter(Boolean).slice(0, options.maxTags || 8)
      : [];
    const fontSize = options.fontSize || 20;
    const hPad = options.hPad || 14;
    const vPad = options.vPad || 8;
    const gap = options.gap || 8;
    const rowGap = options.rowGap || 8;
    const maxRows = Math.max(1, options.maxRows || 2);
    let glyphAscent = Math.round(fontSize * 0.74);
    let glyphDescent = Math.round(fontSize * 0.26);
    let pillHeight = Math.round(fontSize + (vPad * 1.35));
    const placements = [];
    if (!pills.length) {
      return { placements, rowsUsed: 0, totalHeight: 0, pillHeight, glyphAscent, glyphDescent };
    }

    ctx.save();
    ctx.font = `600 ${fontSize}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
    const metricSample = ctx.measureText('ABCDEFGHIJKLMNOPQRSTUVWXYZ');
    glyphAscent = metricSample.actualBoundingBoxAscent || glyphAscent;
    glyphDescent = metricSample.actualBoundingBoxDescent || glyphDescent;
    pillHeight = Math.ceil((glyphAscent + glyphDescent) + (vPad * 2));
    let cursorX = 0;
    let cursorY = 0;
    let currentRow = 0;
    pills.forEach((label) => {
      const textWidth = ctx.measureText(label).width;
      const pillWidth = Math.round(textWidth + (hPad * 2));
      if (cursorX > 0 && cursorX + pillWidth > maxWidth) {
        currentRow += 1;
        cursorX = 0;
        cursorY += pillHeight + rowGap;
      }
      if (currentRow >= maxRows) return;
      placements.push({
        label,
        x: cursorX,
        y: cursorY,
        row: currentRow,
        w: pillWidth,
        h: pillHeight
      });
      cursorX += pillWidth + gap;
    });
    ctx.restore();

    const rowsUsed = placements.length ? (Math.max(...placements.map((item) => item.row || 0)) + 1) : 0;
    const totalHeight = rowsUsed ? ((rowsUsed * pillHeight) + ((rowsUsed - 1) * rowGap)) : 0;
    return { placements, rowsUsed, totalHeight, pillHeight, glyphAscent, glyphDescent };
  }

  function drawTagPills(ctx, tags, x, y, maxWidth, options = {}){
    const layout = measureTagPills(ctx, tags, maxWidth, options);
    if (!layout.placements.length) {
      return { endY: y, rowsUsed: 0, totalHeight: 0 };
    }
    const fontSize = options.fontSize || 20;
    const hPad = options.hPad || 14;
    const radius = options.radius || 999;
    ctx.save();
    ctx.font = `600 ${fontSize}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
    const defaultAscent = layout.glyphAscent || Math.round(fontSize * 0.74);
    const defaultDescent = layout.glyphDescent || Math.round(fontSize * 0.26);
    layout.placements.forEach((pill) => {
      ctx.fillStyle = 'rgba(34,197,94,0.14)';
      ctx.strokeStyle = 'rgba(34,197,94,0.45)';
      ctx.lineWidth = 2;
      drawRoundedRectPath(ctx, x + pill.x, y + pill.y, pill.w, pill.h, radius);
      ctx.fill();
      ctx.stroke();
      ctx.fillStyle = '#22c55e';
      const textMetrics = ctx.measureText(pill.label);
      const tagAscent = textMetrics.actualBoundingBoxAscent || defaultAscent;
      const tagDescent = textMetrics.actualBoundingBoxDescent || defaultDescent;
      const glyphHeight = tagAscent + tagDescent;
      const baselineY = (y + pill.y) + ((pill.h - glyphHeight) / 2) + tagAscent;
      ctx.fillText(pill.label, x + pill.x + hPad, baselineY);
    });
    ctx.restore();
    return {
      endY: y + layout.totalHeight,
      rowsUsed: layout.rowsUsed,
      totalHeight: layout.totalHeight
    };
  }

  async function loadImageForShareCard(url){
    if (!url) {
      throw new Error('Missing image URL for share card export.');
    }
    const image = new Image();
    image.crossOrigin = 'anonymous';
    image.decoding = 'async';
    return new Promise((resolve, reject) => {
      image.onload = () => resolve(image);
      image.onerror = () => reject(new Error('Unable to load selected photo for export.'));
      image.src = url;
    });
  }

  function renderPlantShareCard(plant, image){
    const canvas = document.createElement('canvas');
    canvas.width = SHARE_CARD_WIDTH;
    canvas.height = SHARE_CARD_HEIGHT;
    const ctx = canvas.getContext('2d');
    if (!ctx) {
      throw new Error('Canvas rendering context is unavailable.');
    }

    const cardBg = '#171a22';
    const ink = '#ffffff';
    const muted = '#a5b4c3';
    const accent = '#22c55e';
    const border = 'rgba(255,255,255,0.86)';
    const metaRowsSource = [
      { label: 'TYPE', value: plant.type || '-' },
      { label: 'HABITAT', value: plant.habitat || '-' },
      { label: 'ELEVATION', value: plant.elevation || '-' },
      { label: 'SEASON', value: plant.bloom || '-' }
    ];
    const overviewText = String(plant.teaser || plant.desc || plant.morph || '').trim() || '-';
    const plantSlug = String((plant && (plant.id || plant.slug)) || '').trim();
    const detailUrl = plantSlug
      ? `https://nh48.info/plant/${encodeURIComponent(plantSlug)}`
      : 'https://nh48.info/plant-catalog';
    const compactUrl = detailUrl.replace(/^https?:\/\//i, '');
    const footerText = `More info & catalog: ${compactUrl}`;

    const style = {
      cardX: 18,
      cardY: 20,
      cardRadius: 28,
      thumbInset: 4,
      thumbRadius: 20,
      thumbHeightRatio: 0.56,
      bodyInsetX: 26,
      bodyTopGap: 34,
      bannerInsetX: 16,
      bannerInsetY: 14,
      bannerHeight: 46,
      bannerRadius: 12,
      bannerFont: 24,
      bannerPadX: 16,
      photoCreditText: '\u00A9 Nathan Sobol',
      photoCreditFont: 24,
      photoCreditInsetX: 18,
      photoCreditInsetY: 14,
      titleFont: 54,
      titleLineHeight: 58,
      titleMaxLines: 2,
      titleToLatinGap: 4,
      latinFont: 37,
      latinLineHeight: 42,
      latinMaxLines: 1,
      latinToDividerGap: 14,
      dividerInset: 20,
      dividerToMetaGap: 20,
      metaLabelFont: 20,
      metaLabelColWidth: 152,
      metaValueFont: 36,
      metaLineHeight: 38,
      metaRowMinHeight: 50,
      metaRowBottomPad: 8,
      metaRowGap: 8,
      rowDividerGap: 6,
      sectionGap: 14,
      tagLabelFont: 20,
      tagLabelToPillsGap: 10,
      tagFontSize: 19,
      tagHPad: 14,
      tagVPad: 8,
      tagGap: 8,
      tagRowGap: 8,
      tagMaxRows: 2,
      overviewLabelFont: 20,
      overviewLabelToTextGap: 14,
      overviewFont: 33,
      overviewLineHeight: 35,
      overviewBottomBuffer: 8,
      footerGap: 6,
      footerFont: 16,
      footerLineHeight: 22,
      footerMaxLines: 1,
      footerBottomInset: 14,
      footerBottomBuffer: 2,
      minMetaLineHeight: 34,
      minMetaValueFont: 32,
      minSectionGap: 10,
      minMetaRowGap: 6,
      minRowDividerGap: 4,
      minBodyTopGap: 24,
      minThumbHeightRatio: 0.5,
      minLatinToDividerGap: 10,
      minDividerToMetaGap: 14
    };

    const computeLayout = () => {
      const cardX = style.cardX;
      const cardY = style.cardY;
      const cardW = canvas.width - (cardX * 2);
      const cardH = canvas.height - (cardY * 2);
      const thumbX = cardX + style.thumbInset;
      const thumbY = cardY + style.thumbInset;
      const thumbW = cardW - (style.thumbInset * 2);
      const thumbH = Math.round(thumbW * style.thumbHeightRatio);
      const left = cardX + style.bodyInsetX;
      const right = cardX + cardW - style.bodyInsetX;
      const bodyW = right - left;

      let y = thumbY + thumbH + style.bodyTopGap;

      ctx.font = `700 ${style.titleFont}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
      const titleMeasure = measureWrappedText(ctx, plant.common || 'Plant', bodyW, style.titleMaxLines);
      const titleTop = y;
      y += getTextBlockHeight(Math.max(1, titleMeasure.lines.length), style.titleFont, style.titleLineHeight);
      y += style.titleToLatinGap;

      ctx.font = `italic 500 ${style.latinFont}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
      const latinMeasure = measureWrappedText(ctx, plant.latin || '', bodyW, style.latinMaxLines);
      const latinTop = y;
      y += getTextBlockHeight(Math.max(1, latinMeasure.lines.length), style.latinFont, style.latinLineHeight);

      const dividerOneY = y + style.latinToDividerGap;
      y = dividerOneY + style.dividerToMetaGap;

      const labelX = left;
      const valueX = left + style.metaLabelColWidth;
      const valueW = Math.max(220, right - valueX);
      const metaRows = [];
      metaRowsSource.forEach((row, index) => {
        ctx.font = `700 ${style.metaValueFont}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
        const valueMeasure = measureWrappedText(ctx, row.value, valueW, 2);
        const valueHeight = getTextBlockHeightWithDescender(
          ctx,
          Math.max(1, valueMeasure.lines.length),
          style.metaValueFont,
          style.metaLineHeight
        );
        const rowHeight = Math.max(style.metaRowMinHeight, valueHeight + style.metaRowBottomPad);
        const rowTop = y;
        const rowBottom = rowTop + rowHeight;
        const isLast = index === (metaRowsSource.length - 1);
        const separatorY = isLast ? null : rowBottom + style.rowDividerGap;
        metaRows.push({
          label: row.label,
          topY: rowTop,
          rowBottom,
          separatorY,
          valueMeasure
        });
        y = isLast ? rowBottom : separatorY + style.metaRowGap;
      });

      y += style.sectionGap;
      const tagsLabelTop = y;
      const tagsPillsTop = tagsLabelTop + style.tagLabelFont + style.tagLabelToPillsGap;
      const tagsPillsX = left + style.metaLabelColWidth - 12;
      const tagsPillsWidth = Math.max(220, right - tagsPillsX);
      const tagLayout = measureTagPills(ctx, plant.tags || [], tagsPillsWidth, {
        fontSize: style.tagFontSize,
        hPad: style.tagHPad,
        vPad: style.tagVPad,
        gap: style.tagGap,
        rowGap: style.tagRowGap,
        maxRows: style.tagMaxRows,
        maxTags: 8
      });
      const tagsBottom = Math.max(tagsLabelTop + style.tagLabelFont, tagsPillsTop + tagLayout.totalHeight);

      y = tagsBottom + style.sectionGap;
      const dividerTwoY = y;
      y = dividerTwoY + style.sectionGap;

      const overviewLabelTop = y;
      const overviewTextTop = overviewLabelTop + style.overviewLabelFont + style.overviewLabelToTextGap;
      const footerBottomLimit = cardY + cardH - style.footerBottomInset;
      ctx.font = `600 ${style.footerFont}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
      const footerMeasure = measureWrappedText(ctx, footerText, bodyW - 6, style.footerMaxLines);
      const footerMetrics = ctx.measureText('Ag');
      const footerDescender = footerMetrics.actualBoundingBoxDescent || Math.ceil(style.footerFont * 0.28);
      const footerHeight = getTextBlockHeightWithDescender(
        ctx,
        Math.max(1, footerMeasure.lines.length),
        style.footerFont,
        style.footerLineHeight
      ) + Math.ceil(footerDescender * 0.15);
      const reservedForFooter = style.footerGap + footerHeight + style.footerBottomBuffer;
      const overviewBottomLimit = footerBottomLimit - reservedForFooter;
      const availableOverviewHeight = Math.max(0, overviewBottomLimit - overviewTextTop);
      ctx.font = `600 ${style.overviewFont}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
      const fullOverviewMeasure = measureWrappedText(ctx, overviewText, bodyW - 6, Number.POSITIVE_INFINITY);
      let overviewTargetLines = 2;
      const threeLineHeight = getTextBlockHeightWithDescender(ctx, 3, style.overviewFont, style.overviewLineHeight);
      if (fullOverviewMeasure.totalLines > 2 && availableOverviewHeight >= (threeLineHeight + style.overviewBottomBuffer)) {
        overviewTargetLines = 3;
      }
      const overviewMeasure = measureWrappedText(ctx, overviewText, bodyW - 6, overviewTargetLines);
      const overviewHeight = getTextBlockHeightWithDescender(
        ctx,
        Math.max(1, overviewMeasure.lines.length),
        style.overviewFont,
        style.overviewLineHeight
      );
      const overviewBottom = overviewTextTop + overviewHeight;
      const footerTop = Math.max(
        overviewBottom + style.footerGap,
        footerBottomLimit - footerHeight
      );
      const footerBottom = footerTop + footerHeight;

      return {
        cardX,
        cardY,
        cardW,
        cardH,
        thumbX,
        thumbY,
        thumbW,
        thumbH,
        left,
        right,
        labelX,
        valueX,
        titleTop,
        titleMeasure,
        latinTop,
        latinMeasure,
        dividerOneY,
        dividerTwoY,
        metaRows,
        tagsLabelTop,
        tagsPillsTop,
        tagsPillsX,
        tagsPillsWidth,
        overviewLabelTop,
        overviewTextTop,
        overviewMeasure,
        footerTop,
        footerMeasure,
        overviewBottom,
        footerBottom,
        fits: footerBottom <= (footerBottomLimit - 0.5)
      };
    };

    let layout = computeLayout();
    for (let pass = 0; pass < 24 && !layout.fits; pass += 1) {
      let adjusted = false;
      if (style.bodyTopGap > style.minBodyTopGap) {
        style.bodyTopGap -= 2;
        adjusted = true;
      } else if (style.thumbHeightRatio > style.minThumbHeightRatio) {
        style.thumbHeightRatio = Math.max(style.minThumbHeightRatio, style.thumbHeightRatio - 0.01);
        adjusted = true;
      } else if (style.latinToDividerGap > style.minLatinToDividerGap) {
        style.latinToDividerGap -= 1;
        adjusted = true;
      } else if (style.dividerToMetaGap > style.minDividerToMetaGap) {
        style.dividerToMetaGap -= 1;
        adjusted = true;
      } else if (style.metaLineHeight > style.minMetaLineHeight) {
        style.metaLineHeight -= 1;
        adjusted = true;
      } else if (style.metaValueFont > style.minMetaValueFont) {
        style.metaValueFont -= 1;
        adjusted = true;
      } else {
        if (style.rowDividerGap > style.minRowDividerGap) {
          style.rowDividerGap -= 1;
          adjusted = true;
        }
        if (style.metaRowGap > style.minMetaRowGap) {
          style.metaRowGap -= 1;
          adjusted = true;
        }
        if (style.sectionGap > style.minSectionGap) {
          style.sectionGap -= 1;
          adjusted = true;
        }
      }
      if (!adjusted) break;
      layout = computeLayout();
    }

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = cardBg;
    ctx.strokeStyle = border;
    ctx.lineWidth = 3;
    drawRoundedRectPath(ctx, layout.cardX, layout.cardY, layout.cardW, layout.cardH, style.cardRadius);
    ctx.fill();
    ctx.stroke();

    ctx.save();
    drawRoundedRectPath(ctx, layout.thumbX, layout.thumbY, layout.thumbW, layout.thumbH, style.thumbRadius);
    ctx.clip();
    drawCoverImage(ctx, image, layout.thumbX, layout.thumbY, layout.thumbW, layout.thumbH);
    const bannerX = layout.thumbX + style.bannerInsetX;
    const bannerY = layout.thumbY + style.bannerInsetY;
    const bannerW = layout.thumbW - (style.bannerInsetX * 2);
    const bannerH = style.bannerHeight;
    const bannerGradient = ctx.createLinearGradient(bannerX, bannerY, bannerX + bannerW, bannerY + bannerH);
    bannerGradient.addColorStop(0, 'rgba(4,10,20,0.88)');
    bannerGradient.addColorStop(0.55, 'rgba(17,30,49,0.78)');
    bannerGradient.addColorStop(1, 'rgba(34,197,94,0.45)');
    ctx.fillStyle = bannerGradient;
    ctx.strokeStyle = 'rgba(190,255,224,0.24)';
    ctx.lineWidth = 1.5;
    drawRoundedRectPath(ctx, bannerX, bannerY, bannerW, bannerH, style.bannerRadius);
    ctx.fill();
    ctx.stroke();
    ctx.fillStyle = '#ecfff5';
    ctx.font = `700 ${style.bannerFont}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
    const bannerLine = measureWrappedText(
      ctx,
      'Howker Ridge Plant Catalog',
      bannerW - (style.bannerPadX * 2),
      1
    ).lines[0] || 'Howker Ridge Plant Catalog';
    const bannerMetrics = ctx.measureText(bannerLine || 'Ag');
    const bannerAscent = bannerMetrics.actualBoundingBoxAscent || Math.round(style.bannerFont * 0.74);
    const bannerDescent = bannerMetrics.actualBoundingBoxDescent || Math.round(style.bannerFont * 0.26);
    const bannerBaselineY = bannerY + ((bannerH + bannerAscent - bannerDescent) / 2);
    ctx.fillText(bannerLine, bannerX + style.bannerPadX, bannerBaselineY);
    ctx.font = `700 ${style.photoCreditFont}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
    ctx.textAlign = 'right';
    ctx.textBaseline = 'alphabetic';
    const creditX = layout.thumbX + layout.thumbW - style.photoCreditInsetX;
    const creditY = layout.thumbY + layout.thumbH - style.photoCreditInsetY;
    ctx.fillStyle = 'rgba(2,7,13,0.78)';
    ctx.fillText(style.photoCreditText, creditX + 2, creditY + 2);
    ctx.fillStyle = 'rgba(34,197,94,0.96)';
    ctx.fillText(style.photoCreditText, creditX, creditY);
    ctx.restore();

    const drawDivider = (yPos) => {
      ctx.strokeStyle = 'rgba(255,255,255,0.20)';
      ctx.lineWidth = 2;
      ctx.setLineDash([6, 8]);
      ctx.beginPath();
      ctx.moveTo(layout.cardX + style.dividerInset, yPos);
      ctx.lineTo(layout.cardX + layout.cardW - style.dividerInset, yPos);
      ctx.stroke();
      ctx.setLineDash([]);
    };

    ctx.fillStyle = ink;
    ctx.font = `700 ${style.titleFont}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
    drawTextLinesFromTop(ctx, layout.titleMeasure.lines, layout.left, layout.titleTop, style.titleFont, style.titleLineHeight);

    ctx.fillStyle = muted;
    ctx.font = `italic 500 ${style.latinFont}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
    drawTextLinesFromTop(ctx, layout.latinMeasure.lines, layout.left, layout.latinTop, style.latinFont, style.latinLineHeight);

    drawDivider(layout.dividerOneY);

    layout.metaRows.forEach((row) => {
      ctx.fillStyle = accent;
      ctx.font = `600 ${style.metaLabelFont}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
      ctx.fillText(row.label, layout.labelX, row.topY + style.metaValueFont);

      ctx.fillStyle = ink;
      ctx.font = `700 ${style.metaValueFont}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
      drawTextLinesFromTop(ctx, row.valueMeasure.lines, layout.valueX, row.topY, style.metaValueFont, style.metaLineHeight);

      if (row.separatorY !== null) {
        ctx.strokeStyle = 'rgba(255,255,255,0.16)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(layout.left, row.separatorY);
        ctx.lineTo(layout.right, row.separatorY);
        ctx.stroke();
      }
    });

    ctx.fillStyle = accent;
    ctx.font = `600 ${style.tagLabelFont}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
    ctx.fillText('TAGS', layout.left, layout.tagsLabelTop + style.tagLabelFont);
    drawTagPills(ctx, plant.tags || [], layout.tagsPillsX, layout.tagsPillsTop, layout.tagsPillsWidth, {
      fontSize: style.tagFontSize,
      hPad: style.tagHPad,
      vPad: style.tagVPad,
      gap: style.tagGap,
      rowGap: style.tagRowGap,
      maxRows: style.tagMaxRows,
      maxTags: 8
    });

    drawDivider(layout.dividerTwoY);

    ctx.fillStyle = accent;
    ctx.font = `600 ${style.overviewLabelFont}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
    ctx.fillText('OVERVIEW', layout.left, layout.overviewLabelTop + style.overviewLabelFont);

    ctx.fillStyle = ink;
    ctx.font = `600 ${style.overviewFont}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
    drawTextLinesFromTop(
      ctx,
      layout.overviewMeasure.lines,
      layout.left,
      layout.overviewTextTop,
      style.overviewFont,
      style.overviewLineHeight
    );

    ctx.fillStyle = accent;
    ctx.font = `600 ${style.footerFont}px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif`;
    drawTextLinesFromTop(
      ctx,
      layout.footerMeasure.lines,
      layout.left,
      layout.footerTop,
      style.footerFont,
      style.footerLineHeight
    );

    return canvas;
  }

  function downloadBlob(blob, filename){
    const objectUrl = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = objectUrl;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    link.remove();
    URL.revokeObjectURL(objectUrl);
  }

  async function renderShareCardForExport(){
    if (!currentPlant) {
      throw new Error('Plant data is not ready yet.');
    }
    const selectedSource = getSelectedCardImageUrl();
    if (!selectedSource) {
      throw new Error('No usable image is available for this plant.');
    }
    const imageIndex = Number.isInteger(carouselIdx) ? carouselIdx : 0;
    const proxyUrl = buildShareImageProxyUrl(selectedSource, { width: 1800, format: 'jpg' });
    const image = await loadImageForShareCard(proxyUrl);
    const cardCanvas = renderPlantShareCard(currentPlant, image);
    const blob = await new Promise((resolve) => cardCanvas.toBlob(resolve, 'image/png'));
    if (!blob) {
      throw new Error('Unable to encode PNG output.');
    }
    const timestamp = formatShareTimestamp(new Date());
    const filename = `${sanitizeFilenamePart(currentPlantSlug || currentPlant.id || currentPlant.common)}-threads-card-${timestamp}.png`;
    const sharePayload = buildPlantSharePayload(currentPlant);
    return { blob, filename, imageIndex, cardCanvas, sharePayload };
  }

  async function handleDownloadCardClick(){
    if (!currentPlant) {
      setShareCardStatus('Plant data is not ready yet.', true);
      return;
    }
    const imageIndex = Number.isInteger(carouselIdx) ? carouselIdx : 0;
    trackAnalytics('plant_detail_card_download_attempt', {
      plant_id: currentPlant.id || '',
      image_index: imageIndex
    });

    setShareCardBusy(true);
    setShareCardStatus('Rendering share card...', false);
    try {
      const { blob, filename, cardCanvas } = await renderShareCardForExport();
      downloadBlob(blob, filename);
      setShareCardStatus(`Downloaded ${filename}`, false);
      trackAnalytics('plant_detail_card_download_success', {
        plant_id: currentPlant.id || '',
        image_index: imageIndex,
        format: 'png',
        width: cardCanvas.width,
        height: cardCanvas.height
      });
    } catch (error) {
      console.error('Plant share-card download failed', error);
      setShareCardStatus(error?.message || 'Card download failed.', true);
      trackAnalytics('plant_detail_card_download_error', {
        plant_id: (currentPlant && currentPlant.id) || '',
        image_index: imageIndex,
        reason: error?.message || 'unknown'
      });
    } finally {
      setShareCardBusy(false);
    }
  }

  async function handleShareNetworkClick(networkName){
    const platform = SHARE_CARD_PLATFORMS.find((candidate) => candidate.name === networkName);
    if (!platform) {
      setShareCardStatus('Unsupported share platform selected.', true);
      return;
    }
    if (!currentPlant) {
      setShareCardStatus('Plant data is not ready yet.', true);
      return;
    }
    const imageIndex = Number.isInteger(carouselIdx) ? carouselIdx : 0;
    trackAnalytics('plant_detail_card_share_attempt', {
      plant_id: currentPlant.id || '',
      image_index: imageIndex,
      network: String(platform.name || '').toLowerCase()
    });

    let popup = null;
    try {
      popup = window.open('about:blank', '_blank', 'noopener,noreferrer');
    } catch (_) {
      popup = null;
    }

    setShareCardBusy(true);
    setShareCardStatus(`Preparing ${platform.name} share...`, false);
    try {
      const { blob, filename, sharePayload } = await renderShareCardForExport();
      downloadBlob(blob, filename);
      const shareUrl = platform.buildUrl(sharePayload);
      if (popup) {
        popup.location.replace(shareUrl);
      } else {
        window.open(shareUrl, '_blank', 'noopener,noreferrer');
      }
      setShareCardStatus(`Downloaded ${filename}. ${platform.name} composer opened; attach the PNG.`, false);
      trackAnalytics('plant_detail_card_share_success', {
        plant_id: currentPlant.id || '',
        image_index: imageIndex,
        network: String(platform.name || '').toLowerCase()
      });
    } catch (error) {
      if (popup && !popup.closed) {
        popup.close();
      }
      console.error('Plant share-card social share failed', error);
      setShareCardStatus(error?.message || 'Social share failed.', true);
      trackAnalytics('plant_detail_card_share_error', {
        plant_id: (currentPlant && currentPlant.id) || '',
        image_index: imageIndex,
        network: String(platform.name || '').toLowerCase(),
        reason: error?.message || 'unknown'
      });
    } finally {
      setShareCardBusy(false);
    }
  }

  async function handleShareCardMenuAction(action, networkName = ''){
    const normalizedAction = String(action || '').trim();
    const normalizedNetwork = String(networkName || '').trim();
    setShareCardMenuOpen(false);
    if (normalizedAction === 'download') {
      await handleDownloadCardClick();
      return;
    }
    if (normalizedAction === 'share-network' && normalizedNetwork) {
      await handleShareNetworkClick(normalizedNetwork);
      return;
    }
    setShareCardStatus('Unknown share action selected.', true);
  }

  /* ---------- Data source: static JSON from GitHub Pages ---------- */
  async function fetchPlants() {
    const res = await fetch(
      '/data/howker-plants',
      { mode: 'cors' }
    );
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    return res.json();
  }

  /* ---------- Carousel and Details Rendering ---------- */
  function buildCarousel(images, p){
    carouselEl.innerHTML = '';
    dotsEl.innerHTML = '';
    carouselImgs = [];
    carouselDotLoaders = [];
    if (!images || !images.length){ images = [PLACEHOLDER]; }
    carouselSourceUrls = images.map((src) => String(src || '').trim() || PLACEHOLDER);
    carouselSlideLoaded = new Array(carouselSourceUrls.length).fill(false);
    const startingIndex = images.length > 1 ? 1 : 0;
    carouselIdx = startingIndex;
    setCarouselMainLoading(true);
    const timerEl = document.getElementById('carouselTimer');
    carouselSourceUrls.forEach((src, i)=>{
      const slide = document.createElement('div');
      slide.className = 'slide' + (i===startingIndex ? ' active' : '');
      const figure = document.createElement('figure');
      const img = document.createElement('img');
      const altBase = (p && p.common) ? p.common : 'Plant';
      const descSnippet = (p && (p.morph || p.teaser || p.desc) || '').trim();
      const altDetail = descSnippet ? ` – ${descSnippet.slice(0, 100)}` : '';
      img.alt = `${altBase}${altDetail} (image ${i+1} of ${images.length})`;
      img.title = (p && (p.desc || p.teaser || p.morph) || '').trim().slice(0, 160);
      img.dataset.desc = (p && p.desc) || '';
      img.dataset.credits = (p && p.credits) || '';
      img.dataset.realSrc = src;
      img.loading = 'lazy';
      img.decoding = 'async';
      img.addEventListener('load', () => {
        if (img.dataset.waitingReal === '1') {
          img.dataset.waitingReal = '0';
          markSlideLoaded(i);
        }
      });
      img.addEventListener('error', () => {
        if (img.dataset.waitingReal === '1') {
          img.dataset.waitingReal = '0';
          markSlideLoaded(i);
          const currentSrc = String(img.currentSrc || img.src || '');
          if (currentSrc !== PLACEHOLDER) {
            img.src = PLACEHOLDER;
          }
        }
      });
      if (i===startingIndex){
        img.dataset.waitingReal = '1';
        img.src = src;
      } else {
        img.setAttribute('data-src', src);
        img.src = LQ_PLACEHOLDER;
      }
      figure.appendChild(img);
      slide.appendChild(figure);
      const caption = document.createElement('p');
      caption.className = 'sr-only';
      caption.textContent = (p && (p.desc || p.teaser) || '').trim();
      slide.appendChild(caption);
      carouselEl.appendChild(slide);
      carouselImgs.push(img);
      const dot = document.createElement('button');
      dot.type = 'button';
      dot.className = 'dot' + (i===startingIndex ? ' active' : '');
      dot.style.backgroundImage = `url('${src}')`;
      dot.setAttribute('aria-label', `View photo ${i + 1}`);
      dot.title = dot.getAttribute('aria-label');
      dot.addEventListener('click', ()=>goTo(i, true));
      const dotLoading = document.createElement('span');
      dotLoading.className = 'dot-loading';
      const dotSpinner = document.createElement('span');
      dotSpinner.className = 'loading-spinner small';
      dotSpinner.setAttribute('aria-hidden', 'true');
      dotLoading.appendChild(dotSpinner);
      dot.appendChild(dotLoading);
      carouselDotLoaders.push(dotLoading);
      dotsEl.appendChild(dot);
      const dotProbe = new Image();
      dotProbe.decoding = 'async';
      dotProbe.onload = () => hideDotLoading(i);
      dotProbe.onerror = () => hideDotLoading(i);
      dotProbe.src = src;
    });
    const media = document.querySelector('.media');
    prevBtn.onclick = () => prev(true);
    nextBtn.onclick = () => next(true);
    media.onmouseenter = stopCarousel;
    media.onmouseleave = startCarousel;
    media.onfocusin = stopCarousel;
    media.onfocusout = startCarousel;
    if (timerEl){
      timerEl.hidden = images.length <= 1;
    }
    syncActiveSlideLoading();
    startCarousel();
  }
  function updateSlides(){
    const slides = Array.from(document.querySelectorAll('.slide'));
    const dots = Array.from(document.querySelectorAll('.dot'));
    slides.forEach((s, i)=> s.classList.toggle('active', i===carouselIdx));
    dots.forEach((d, i)=> d.classList.toggle('active', i===carouselIdx));
    syncActiveSlideLoading();
  }
  function ensureImgLoaded(i){
    const img = carouselImgs[i]; if (!img) return;
    const real = img.getAttribute('data-src');
    if (real){
      img.dataset.waitingReal = '1';
      img.src = real;
      img.removeAttribute('data-src');
      syncActiveSlideLoading();
      return;
    }
    if (!carouselSlideLoaded[i] && img.complete && img.naturalWidth > 0) {
      markSlideLoaded(i);
    }
    syncActiveSlideLoading();
  }
  function next(manual=false){
    carouselIdx = (carouselIdx + 1) % carouselImgs.length;
    ensureImgLoaded(carouselIdx);
    updateSlides();
    if (manual){
      trackAnalytics('plant_detail_carousel_nav', {
        action: 'next',
        index: carouselIdx
      });
      restartCarousel();
    }
  }
  function prev(manual=false){
    carouselIdx = (carouselIdx - 1 + carouselImgs.length) % carouselImgs.length;
    ensureImgLoaded(carouselIdx);
    updateSlides();
    if (manual){
      trackAnalytics('plant_detail_carousel_nav', {
        action: 'prev',
        index: carouselIdx
      });
      restartCarousel();
    }
  }
  function goTo(i, manual=false){
    carouselIdx = i % carouselImgs.length;
    ensureImgLoaded(carouselIdx);
    updateSlides();
    if (manual){
      trackAnalytics('plant_detail_carousel_nav', {
        action: 'dot',
        index: carouselIdx
      });
      restartCarousel();
    }
  }
  function startCarousel(){
    stopCarousel();
    if (carouselImgs.length <= 1){
      updatePauseButton(false);
      return;
    }
    if (isCarouselPaused){
      updatePauseButton(true);
      return;
    }
    currentDelay = BASE_DELAY + Math.floor(Math.random()*2000);
    startTimer(currentDelay);
    carouselTimer = setInterval(() => {
      next(false);
      startTimer(currentDelay);
    }, currentDelay);
    updatePauseButton(false);
  }
  function stopCarousel(){
    if (carouselTimer){
      clearInterval(carouselTimer);
      carouselTimer=null;
    }
    if (timerInterval){
      clearInterval(timerInterval);
      timerInterval = null;
    }
  }

  function updatePauseButton(paused=isCarouselPaused){
    const btn = document.getElementById('carouselPauseBtn');
    if (!btn) return;
    btn.textContent = paused ? '▶' : '❚❚';
    btn.setAttribute('aria-pressed', paused);
    btn.setAttribute('aria-label', paused ? 'Resume carousel' : 'Pause carousel');
    btn.title = paused ? 'Resume carousel' : 'Pause carousel';
  }

  function pauseCarousel(){
    if (isCarouselPaused) return;
    isCarouselPaused = true;
    stopCarousel();
    updatePauseButton(true);
  }

  function resumeCarousel(){
    if (!isCarouselPaused) return;
    isCarouselPaused = false;
    startCarousel();
    updatePauseButton(false);
  }

  function restartCarousel(){
    if (isCarouselPaused) return;
    startCarousel();
  }

  function toggleCarouselPause(){
    if (isCarouselPaused){
      resumeCarousel();
    } else {
      pauseCarousel();
    }
  }

  const pauseBtn = document.getElementById('carouselPauseBtn');
  if (pauseBtn){
    pauseBtn.addEventListener('click', toggleCarouselPause);
    updatePauseButton(false);
  }
  if (shareCardBtn && shareCardDropdown){
    buildShareCardMenu();
    shareCardBtn.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      if (!shareCardAvailable || shareCardBtn.disabled) return;
      const isOpen = shareCardBtn.getAttribute('aria-expanded') === 'true';
      setShareCardMenuOpen(!isOpen);
    });
    shareCardDropdown.addEventListener('click', async (event) => {
      const option = event.target.closest('.share-card-option');
      if (!option || option.disabled) return;
      event.preventDefault();
      await handleShareCardMenuAction(option.dataset.action, option.dataset.network);
    });
    document.addEventListener('click', (event) => {
      if (!shareCardMenu || !shareCardMenu.contains(event.target)) {
        setShareCardMenuOpen(false);
      }
    });
    setShareCardAvailable(false);
    setShareCardBusy(false);
  }
  applyFieldIcons();

  function startTimer(duration){
    const ring = document.getElementById('timerRing');
    const textEl = document.getElementById('timerText');
    if (!ring || !textEl) return;

    const radius = 18;
    const circumference = 2 * Math.PI * radius;
    ring.style.strokeDasharray = circumference;
    ring.style.strokeDashoffset = 0;

    const start = Date.now();
    const end = start + duration;

    if (timerInterval) clearInterval(timerInterval);

    timerInterval = setInterval(() => {
      const now = Date.now();
      const remaining = Math.max(end - now, 0);
      const percent = remaining / duration;
      const offset = circumference * (1 - percent);
      ring.style.strokeDashoffset = offset;
      const secs = Math.ceil(remaining / 1000);
      textEl.textContent = secs;
      if (remaining <= 0){
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }, 100);

    textEl.textContent = Math.ceil(duration / 1000);
  }

  /* ---------- Populate details ---------- */
  function populatePlant(p){
    currentPlant = p || null;
    currentPlantSlug = String((p && p.id) || '').trim();
    const detailName = p.common || 'Plant';
    const titleText = `${detailName} • Howker Ridge Plant Catalog`;
    const headerText = `Howker Ridge • ${detailName}`;
    const descText = `Details for ${p.common || 'a plant'}${p.latin ? ` (${p.latin})` : ''} observed along the Howker Ridge Trail in the White Mountains of New Hampshire.`;
    document.title = titleText;
    updateMeta('meta-description', descText);
    updateMeta('og-title', titleText);
    updateMeta('og-description', descText);
    updateMeta('twitter-title', titleText);
    updateMeta('twitter-description', descText);
    if (detailTitle){
      setTitleWithPlantIcon(detailTitle, headerText, p);
    }
    if (detailBreadcrumb){
      detailBreadcrumb.textContent = detailName;
    }

    setTitleWithPlantIcon(document.getElementById('d-title'), p.common || '', p);
    document.getElementById('d-latin').textContent = p.latin || '';
    document.getElementById('d-tags').innerHTML = `
      ${p.type ? `<span class="chip">${p.type}</span>` : ''}
      ${p.habitat ? `<span class="chip">${p.habitat}</span>` : ''}
      ${(p.tags||[]).map(t=>`<span class="chip">${t}</span>`).join("")}
    `;
    setTypeFactValue(p);
    document.getElementById('f-elev').textContent    = p.elevation || "—";
    document.getElementById('f-habitat').textContent = p.habitat   || "—";
    document.getElementById('f-bloom').textContent   = p.bloom     || "—";
    document.getElementById('f-morph').textContent   = p.morph     || "—";
    document.getElementById('f-similar').textContent = p.similar   || "—";
    document.getElementById('f-ecology').textContent = p.ecology   || "—";
    document.getElementById('f-status').textContent  = p.status    || "—";
    applyFieldIcons();

    const desc = (p.desc || p.teaser || "").trim();
    document.getElementById('d-desc').textContent = desc;
    if (desc) document.getElementById('sec-desc').removeAttribute('hidden');

    const notes = [p.fieldNotes1, p.fieldNotes2, p.fieldNotes3, p.fieldNotes4].filter(Boolean);
    document.getElementById('d-notes').innerHTML = notes.map(n=>`<li>${n}</li>`).join("");
    if (notes.length > 0) document.getElementById('sec-notes').removeAttribute('hidden');

    const credits = (p.credits || "").trim();
    document.getElementById('d-credits').textContent = credits;
    if (credits) document.getElementById('sec-credits').removeAttribute('hidden');

    const imgs = Array.isArray(p.imgs) && p.imgs.length ? p.imgs : (p.img ? [p.img] : []);
    buildCarousel(imgs, p);
    setShareCardAvailable(true);
    setShareCardStatus('');
    setShareCardBusy(false);

    const heroCandidate = [imgs[1], imgs[0]].find(src => typeof src === 'string' && src.trim().length > 0);
    if (detailHero && heroCandidate){
      detailHero.style.backgroundImage = `url("${heroCandidate}")`;
    }

    const firstImage = Array.isArray(p.imgs) && p.imgs.length ? p.imgs[0] : (p.img || '');
    const caption = normalizeTextForWeb(`${p.common || ''} - ${p.teaser || p.desc || p.morph || ''}`.trim());
    if (firstImage){
      updateMeta('og-image', firstImage);
      updateMeta('twitter-image', firstImage);
    }
    if (caption){
      updateMeta('og-image-alt', caption);
      updateMeta('twitter-image-alt', caption);
    }

    const imagesList = imgs.map(src => ({
      '@type': 'ImageObject',
      'url': src,
      'caption': normalizeTextForWeb(p.desc || p.teaser || p.morph || ''),
      'license': 'https://creativecommons.org/licenses/by/4.0/'
    }));
    const jsonLd = {
      '@context': 'https://schema.org',
      '@type': 'WebPage',
      'name': document.title,
      'image': imagesList
    };
    const jsonLdEl = document.getElementById('plant-images-jsonld');
    if (jsonLdEl) {
      jsonLdEl.textContent = JSON.stringify(jsonLd);
    }
  }

  /* ---------- Init for details page ---------- */
  (async function initDetails(){
    // parse id from query string or path (/plant/{id})
    const params = new URLSearchParams(window.location.search);
    const pathMatch = window.location.pathname.match(/\/plant\/([^/]+)\/?$/);
    const plantId = params.get('id') || (pathMatch ? decodeURIComponent(pathMatch[1]) : null);
    if (!plantId){
      // No id provided
      currentPlant = null;
      currentPlantSlug = '';
      document.getElementById('d-title').textContent = 'Plant not specified';
      document.title = 'Plant not specified • Howker Ridge Plant Catalog';
      if (detailTitle){
        detailTitle.textContent = 'Howker Ridge • Plant not specified';
      }
      if (detailBreadcrumb){
        detailBreadcrumb.textContent = 'Plant not specified';
      }
      setShareCardAvailable(false);
      setShareCardStatus('Card sharing is unavailable for this page.', true);
      return;
    }
    try{
      const items = await fetchPlants();
      PLANTS = items;
      const p = PLANTS.find(item => String(item.id) === String(plantId));
      if (p){
        populatePlant(p);
      } else {
        currentPlant = null;
        currentPlantSlug = '';
        document.getElementById('d-title').textContent = 'Plant not found';
        document.title = 'Plant not found • Howker Ridge Plant Catalog';
        if (detailTitle){
          detailTitle.textContent = 'Howker Ridge • Plant not found';
        }
        if (detailBreadcrumb){
          detailBreadcrumb.textContent = 'Plant not found';
        }
        setShareCardAvailable(false);
        setShareCardStatus('Card sharing is unavailable for this plant.', true);
      }
    }catch(err){
      console.error(err);
      currentPlant = null;
      currentPlantSlug = '';
      document.getElementById('d-title').textContent = 'Error loading plant';
      document.title = 'Error loading plant • Howker Ridge Plant Catalog';
      if (detailTitle){
        detailTitle.textContent = 'Howker Ridge • Error loading plant';
      }
      if (detailBreadcrumb){
        detailBreadcrumb.textContent = 'Error loading plant';
      }
      setShareCardAvailable(false);
      setShareCardStatus('Card sharing is unavailable right now.', true);
    }
  })();

  // Keyboard shortcuts for carousel navigation
  window.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') {
      setShareCardMenuOpen(false);
    }
    if (e.target && (/input|select|textarea/i).test(e.target.tagName)) return;
    if (e.key === 'ArrowRight') { next(true); }
    if (e.key === 'ArrowLeft')  { prev(true); }
  });
</script>
<div id="footer-placeholder"></div>
</body>
</html>
