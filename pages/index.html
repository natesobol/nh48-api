<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Howker Ridge ‚Ä¢ Trail Plant Catalog</title>
<meta name="description" content="Interactive alpine plant catalog for Howker Ridge (Mount Madison, NH). Browse quick facts, habitats, elevation ranges, and seasonal notes. Click a plant for details." />

<style>

/****************************
 * THEME VARIABLES
 ****************************/
:root{
  /* Dark theme palette
     - bg: background color of the page
     - panel/card: surfaces for panels and cards
     - ink: primary text color
     - muted: secondary text color
     - stroke: border color (forced pure white here)
     - accent: highlight color used for active states
     - gap: base spacing unit for components */
  --bg:#0a0a0a;
  --panel:#12121a;
  --card:#171a22;
  --ink:#ffffff;
  --muted:#a5b4c3;
  --stroke:#ffffff;
  --accent:#22c55e;
  --gap:10px;
}
/* Light theme overrides applied when body has class "light" */
body.light{
  --bg:#f8fafc;
  --panel:#ffffff;
  --card:#f7f9fc;
  --ink:#1f2937;
  --muted:#6b7280;
  --stroke:#00000022;
  --accent:#22c55e;
}

/****************************
 * GLOBAL RESETS & BASICS
 ****************************/
*{ box-sizing:border-box; }
html{
  min-width:320px;
  scroll-behavior:smooth;
}
@media (prefers-reduced-motion: reduce){
  html{ scroll-behavior:auto; }
}
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;
  text-rendering:optimizeLegibility;
  overflow:auto; /* allow the page to scroll, avoid nested page-level scrolls */
}

/****************************
 * LAYOUT CONTAINERS
 ****************************/
/* Wrapper to constrain content width and provide horizontal padding */
.wrap{
  max-width:1100px;
  margin:0 auto;
  padding:12px;
}
/* Main panel surface with white border and slight shadow */
.panel{
  background:var(--panel);
  border:2px solid #ffffff;
  border-radius:10px;
  padding:16px;
  box-shadow:0 10px 30px #0004;
  overflow:hidden;
}

/****************************
 * TYPOGRAPHY
 ****************************/
header h1{
  margin:0 0 8px;
  font-size:clamp(20px,3.2vw,28px);
  letter-spacing:.2px;
  line-height:1.2;
}
header p{
  margin:0;
  color:var(--muted);
}

/****************************
 * FILTER CONTROLS
 ****************************/
/* Controls layout: grid of inputs/selects */
.controls{
  display:grid;
  gap:10px;
  margin:14px 0;
}
@media(min-width:860px){
  .controls{ grid-template-columns:1.2fr .8fr .8fr .6fr; }
}
.ctrl{
  display:flex;
  align-items:center;
}
.ctrl input,
.ctrl select{
  width:100%;
  height:42px;
  border:1px solid var(--stroke);
  border-radius:12px;
  background:var(--card);
  color:var(--ink);
  padding:0 14px;
  outline:none;
  min-width:0;
}
.ctrl input::placeholder{
  color:var(--muted);
}

/****************************
 * SETTINGS PANEL
 ****************************/
/* Outer settings container with subtle shadow */
.settings{
  background:var(--panel);
  border:1px solid var(--stroke);
  border-radius:12px;
  padding:18px;
  box-shadow:0 4px 12px #0003;
  margin-bottom:16px;
  max-width:100%;
}
/* Settings logo/title line */
.settings-logo{
  font-size:18px;
  font-weight:bold;
  margin-bottom:12px;
  color:var(--accent);
  display:flex;
  align-items:center;
  gap:8px;
}
.settings-icon{
  font-size:20px;
}
/* Each row containing a checkbox and label */
.setting-row{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:10px;
  font-size:14px;
  color:var(--muted);
}
.setting-row input{
  width:18px;
  height:18px;
  cursor:pointer;
}
/* Desktop layout: align settings horizontally with spacing */
@media (min-width: 760px){
  .settings{
    display:flex;
    align-items:center;
    justify-content:flex-start;
    flex-wrap:wrap;
    gap:22px 26px;
  }
  .settings-logo{
    margin-bottom:0;
    margin-right:18px;
    padding-right:18px;
    border-right:1px solid var(--stroke);
  }
  .setting-row{
    margin-top:0;
    flex:0 0 auto;
  }
}

/****************************
 * GRID OF CARDS
 ****************************/
/* Base grid for plant cards */
.grid{
  display:grid;
  gap:12px;
  min-height:160px;
}
@media(min-width:760px){
  .grid{ grid-template-columns:repeat(3,1fr); }
}
/* Individual plant card */
.card{
  background:var(--card);
  border:1px solid var(--stroke);
  border-radius:12px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-height:220px;
  cursor:pointer;
  transition:transform .12s ease, box-shadow .12s ease;
  position:relative; /* anchor for arrow icon */
}
.card:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 20px #0005;
}
/* Thumbnail area retains 5:3 aspect ratio and uses dashed separator */
.thumb{
  aspect-ratio:5/3;
  height:auto;
  overflow:hidden;
  border-bottom:1px dashed var(--stroke);
}
.thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}
/* Card body content */
.card .body{
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:6px;
  overflow-wrap:break-word;
  hyphens:auto;
}
.card h3{
  margin:0;
  font-size:16px;
  line-height:1.2;
}
.card .latin{
  color:var(--muted);
  font-style:italic;
  font-size:13px;
}
.chiprow{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:4px;
}
.chip{
  display:inline-block;
  border:1px solid var(--stroke);
  border-radius:9999px;
  padding:6px 10px;
  font-size:11.5px;
  line-height:1.25;
  color:var(--muted);
  max-width:100%;
  word-break:break-word;
  white-space:normal;
}
/* Arrow indicator pinned bottom right of card */
.card .more{
  position:absolute;
  bottom:var(--gap);
  right:var(--gap);
  font-size:16px;
  color:var(--accent);
  pointer-events:none;
}

/****************************
 * VIEW MODE OVERRIDES
 ****************************/
/* List view: cards become horizontal rows */
body.list-view .grid{
  display:flex;
  flex-direction:column;
}
body.list-view .card{
  flex-direction:row;
  min-height:80px;
}
body.list-view .thumb{
  width:120px;
  height:80px;
  border-right:1px dashed var(--stroke);
  border-bottom:none;
}
body.list-view .body{
  flex:1;
}
body.list-view .chiprow{
  margin-top:4px;
}
/* Compact mode reduces padding and chip sizes */
body.compact .card .body{
  padding:8px;
}
body.compact .chip{
  padding:4px 8px;
  font-size:11px;
}
body.compact .card{
  min-height:200px;
}
/* Apply to the whole page so no horizontal scroll is possible */
html, body {
  overflow-x: hidden;
}

/* Drawer defaults: no margin and 100% translation so it doesn‚Äôt add width */
.drawer {
  margin: 0;
  width: 100%;               /* full viewport width */
  height: 100dvh;            /* full viewport height */
  transform: translateX(100%); /* completely off-screen when closed */
}

/* When the drawer opens, translate back to origin */
.drawer.open {
  transform: translateX(0);
}

/* Optional: for small screens, you can collapse the border/margins further */
@media (max-width: 480px) {
  .drawer {
    border-radius: 0;
    border-left: none;
  }
}

/****************************
 * STICKY HEADER SUPPORT
 ****************************/
header.sticky{
  position:sticky;
  top:0;
  z-index:20;
  background:var(--panel);
  padding-top:10px;
  padding-bottom:10px;
}

/****************************
 * FOOTER & MESSAGES
 ****************************/
.footer{
  margin-top:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  color:var(--muted);
  font-size:12px;
  gap:8px;
  flex-wrap:wrap;
}
.empty,
.error,
.loading{
  color:var(--muted);
  text-align:center;
  padding:24px;
  border:1px dashed var(--stroke);
  border-radius:10px;
}

/****************************
 * PREVENT HORIZONTAL SCROLL
 ****************************/
html,
body,
#howker-plants{
  overflow-x:hidden;
}

/****************************
 * PAGINATION UI (cleaned)
 ****************************/
/* The pager consists of two columns: left for stats, right for page controls.  
   A CSS grid is used for robust centering of the page controls while keeping
   stats text aligned left. Adjust gap and margins to maintain rhythm. */
.pager-wrap{
  display:grid;
  grid-template-columns:auto 1fr;
  align-items:center;
  gap:10px;
  margin:16px 0;
  padding:6px 0;
}
.pager-left{
  justify-self:start;
}
.pager-stats{
  color:var(--muted);
  font-size:12px;
  white-space:nowrap;
}
.pager-right{
  justify-self:center;
}
.page-list{
  display:flex;
  gap:6px;
  flex-wrap:nowrap;
  justify-content:center;
}
/* Base page button styling */
.page-btn{
  background:var(--card);
  border:1px solid var(--stroke);
  border-radius:10px;
  min-width:34px;
  height:34px;
  display:grid;
  place-items:center;
  cursor:pointer;
  color:var(--ink);
}
.page-btn[aria-current="page"]{
  border-color:var(--accent);
  outline:2px solid #22c55e55;
  color:#ffffff;
}

/* Hide the main catalog when details pane is open */
body.details-open #howker-plants {
  display: none;
}

/* Drawer hidden by default */
.drawer {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  margin: 0;
  border-left: none;
  border-radius: 0;
  z-index: 1000;           /* ensures it overlays everything */
  transform: translateX(0);/* no slide animation on mobile */
}

/* Show the drawer when it's both .open and the body has .details-open */
body.details-open .drawer.open {
  display: flex;
}

/****************************
 * RESPONSIVE BREAKPOINTS
 ****************************/
@media (max-width:480px){
  :root{
    --edge:max(10px, env(safe-area-inset-left), env(safe-area-inset-right));
  }
  .wrap{
    padding:0;
  }
  .panel{
    width:calc(100% - (2 * var(--edge)));
    margin-inline:var(--edge);
    max-width:none;
    border-width:2px;
    border-radius:10px;
  }
  .grid{
    grid-template-columns:1fr;
    justify-items:center;
  }
  .card{
    width:min(100%, 360px);
  }
  .ctrl input,
  .ctrl select{
    height:44px;
    padding:0 16px;
    border-radius:14px;
  }
  .chip{
    font-size:11px;
    padding:6px 11px;
  }
  /* Pagination on mobile: reduce button sizes and spacing */
  .pager-wrap{
    margin:14px 0;
    padding:4px 0;
  }
  .pager-stats{
    font-size:11px;
  }
  .page-list{
    gap:4px;
  }
  .page-btn{
    min-width:26px;
    height:26px;
    font-size:12px;
    border-radius:8px;
  }
  /* Buttons in controls (not page) shrink on mobile */
  .pager button,
  .pager-select{
    height:30px;
    min-width:30px;
    padding:6px 8px;
    border-radius:8px;
  }
}

@media (max-width:320px){
  :root{
    --edge:max(8px, env(safe-area-inset-left), env(safe-area-inset-right));
  }
  .panel{
    width:calc(100% - (2 * var(--edge)));
    margin-inline:var(--edge);
    border-width:2px;
    border-radius:10px;
  }
  .ctrl input,
  .ctrl select{
    height:42px;
  }
  header h1{
    font-size:20px;
  }
  .card{
    width:100%;
  }
  .chip{
    font-size:10.5px;
    padding:6px 10px;
  }
}

</style>

</head>
<body>
<!-- data-site-origin ensures Editor/Preview loads entries -->
<div class="wrap panel" id="howker-plants" data-site-origin="https://www.nh48pics.com">
  <header>
    <blockquote>
      <h1>Howker Ridge ‚Ä¢ Sub &amp; Alpine Plant Catalog</h1>
    </blockquote>
    <blockquote>
      <p>Browse alpine/subalpine species and communities observed along Howker Ridge Trail. Click a card for detailed information. Disclosure Information compiled w/ AI. Purely for exploration &amp; may not be completely accurate. This log should be refined &amp; updated over time as I continue to work safely as the Trail Adopter.</p>
    </blockquote>
  </header>
  <!-- Settings panel -->
<aside class="settings" id="settings-panel">
  <div class="settings-logo">
    <span class="settings-icon">‚öôÔ∏è</span>
    Settings
  </div>
  <div class="setting-row">
    <input type="checkbox" id="theme-toggle" checked>
    <label for="theme-toggle">üåô Dark theme</label>
  </div>
  <div class="setting-row">
    <input type="checkbox" id="view-toggle">
    <label for="view-toggle">üìã List view</label>
  </div>
  <div class="setting-row">
    <input type="checkbox" id="rotate-toggle" checked>
    <label for="rotate-toggle">üîÑ Rotate images</label>
  </div>
  <div class="setting-row">
    <input type="checkbox" id="compact-toggle">
    <label for="compact-toggle">üìè Compact view</label>
  </div>
  <div class="setting-row">
    <input type="checkbox" id="sticky-toggle">
    <label for="sticky-toggle">üìå Sticky header</label>
  </div>
</aside>


  <div class="controls">
    <label class="ctrl"><input id="q" placeholder="Name, latin, tag, habitat‚Ä¶"></label>
    <label class="ctrl">
      <select id="type">
        <option value="">All types</option>
        <option>Shrub</option><option>Wildflower</option><option>Moss</option>
        <option>Lichen</option><option>Forest</option><option>Community</option><option>Fungus</option>
      </select>
    </label>
    <label class="ctrl">
      <select id="habitat">
        <option value="">Any habitat</option>
        <option>Alpine heath</option><option>Krumholz</option><option>Talus/boulder</option>
        <option>Spruce‚Äìfir forest</option><option>Moist ravine</option>
      </select>
    </label>
    <label class="ctrl">
      <select id="bloom">
        <option value="">Any season</option>
        <option>Late spring</option><option>Summer</option><option>Non-flowering</option>
      </select>
    </label>
  </div>

  <!-- Pagination header (Top) -->
  <div class="pager-wrap">
    <div class="pager-left">
      <div class="pager-stats" id="pager-stats-top">Showing ‚Äî</div>
    </div>
    <div class="pager-right">
      <div class="page-list" id="page-list-top" aria-label="Pagination"></div>
    </div>
  </div>

  <div id="grid" class="grid" aria-live="polite">
    <div class="loading" id="loading">Loading plant catalog‚Ä¶</div>
  </div>

  <!-- Pagination footer (Bottom) -->
  <div class="pager-wrap">
    <div class="pager-left">
      <div class="pager-stats" id="pager-stats-bot">Showing ‚Äî</div>
    </div>
    <div class="pager-right">
      <div class="page-list" id="page-list-bot" aria-label="Pagination"></div>
    </div>
  </div>

  <div class="footer">
    <span>Unofficial &amp; volunteer ‚Ä¢ Howker Ridge Trail Sub &amp; Alpine Plant Catalog</span>
    <span>¬© <span id="year"></span> Nathan Sobol ‚Ä¢ NH48pics</span>
  </div>
</div>

<script>
  /* =============================================================
     HOWKER RIDGE ‚Äî APP CORE (single scroll + pagination @ 20)
     Implements 5-step plan:
       1) Pagination (20 / page) + page owns scrolling
       2) Dynamic viewport units (100dvh) for drawer
       3) overscroll-behavior containment on internal scroller
       4) Robust body-lock utility (disabled by default)
       5) Safer iframe auto-resize for Wix (postMessage)
     Also includes: pure-white borders & one-line mobile pager
     ============================================================= */

  /* ---------- Data & State ---------- */
  let PLANTS = [];
  let CURRENT = [];           // filtered list
  let PAGE = 1;               // 1-based
  const DEFAULT_PAGE_SIZE = 20;  // Step #1: fixed 20 to hold height steady
  let PAGE_SIZE = DEFAULT_PAGE_SIZE; // could be made user-selectable later
  let TOTAL_PAGES = 1;

  // Mapping: page => [start,end) indices
  const pageBounds = (page, size, total) => {
    const p = Math.max(1, Math.min(page, Math.max(1, Math.ceil(total / size) || 1)));
    const start = (p - 1) * size;
    const end = Math.min(start + size, total);
    return { p, start, end };
  };

  // Carousel state
  let carouselTimer = null;   // setInterval handle
  let carouselIdx = 0;        // active index
  let carouselImgs = [];      // img elements
  let carouselDelay = 4000;   // default ~4s (3‚Äì5s jitter)

  // Rotation control for cards
  let rotateInterval = null;

  // DOM helpers
  const $ = s => document.querySelector(s);
  const grid = $("#grid");
  // Removed reference to drawer on the catalog page. We will redirect instead.
  const qEl=$("#q"), typeEl=$("#type"), habEl=$("#habitat"), bloomEl=$("#bloom");
  const drawerContent = null; // no drawer on this page
  const themeToggle = document.getElementById('theme-toggle');
  const viewToggle  = document.getElementById('view-toggle');
  const rotateToggle = document.getElementById('rotate-toggle');
  const compactToggle = document.getElementById('compact-toggle');
  const stickyToggle = document.getElementById('sticky-toggle');
  const pageListTop = document.getElementById('page-list-top');
  const pageListBot = document.getElementById('page-list-bot');
  const statsTop = document.getElementById('pager-stats-top');
  const statsBot = document.getElementById('pager-stats-bot');
  document.getElementById("year").textContent = new Date().getFullYear();

  // Placeholders for images
  const LQ_PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#0f1320"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#a5b4c3" font-family="system-ui" font-size="22">image loading‚Ä¶</text></svg>`
  );
  const PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#0f1320"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#a5b4c3" font-family="system-ui" font-size="22">image unavailable</text></svg>`
  );

  /* ---------- Editor/Preview safe site-origin resolution ---------- */
  const SITE_ORIGIN = (() => {
    const attr = document.getElementById('howker-plants')?.dataset?.siteOrigin;
    if (attr) return attr;
    const canon = document.querySelector('link[rel="canonical"]')?.href;
    if (canon) { try { return new URL(canon).origin; } catch(e){} }
    if (document.referrer) {
      try {
        const o = new URL(document.referrer).origin;
        if (/nh48pics\.com$/i.test(new URL(o).hostname)) return o;
      } catch(e){}
    }
    return 'https://www.nh48pics.com';
  })();

  async function fetchJSON(url){
    const res = await fetch(url, { mode:'cors', credentials:'omit', headers:{ 'Accept':'application/json' } });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  async function fetchPlants() {
  const url = 'https://natesobol.github.io/howker-ridge-plant-catalog/plants.json';
  const res = await fetch(url, { mode: 'cors' });
  return res.json();
}


  /* ---------- Step #5: Safer auto-resize for Wix iframe ---------- */
  (function(){
    if (window.__hrtSizerInstalled) return; window.__hrtSizerInstalled = true;
    const MIN_DELAY_MS = 200;  // throttle
    const EPSILON = 2;
    const TARGET_ORIGIN = '*';
    let lastH = 0, tId = 0, ro = null;
    const root = document.querySelector('#howker-plants') || document.body;
    function measure(){
      const d = document;
      return Math.ceil(Math.max(
        d.documentElement.scrollHeight,
        d.body.scrollHeight,
        d.documentElement.offsetHeight,
        d.body.offsetHeight,
        d.documentElement.clientHeight
      ));
    }
    function doPost(){
      if (document.visibilityState === 'hidden') return;
      const h = measure();
      if (Math.abs(h - lastH) <= EPSILON) return;
      lastH = h;
      window.parent.postMessage({ type:'resize', height:h }, TARGET_ORIGIN);
    }
    function schedule(){ if (tId) return; tId = setTimeout(() => { tId = 0; doPost(); }, MIN_DELAY_MS); }
    window.schedule = schedule;
    window.addEventListener('load', () => { doPost(); setTimeout(doPost, 300); setTimeout(doPost, 1000); }, { once:true });
    window.addEventListener('resize', schedule, { passive:true });
    document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') schedule(); });
    try { ro = new ResizeObserver(() => schedule()); ro.observe(root); } catch(e){}
    window.addEventListener('beforeunload', () => { if (ro) ro.disconnect(); });
    const css = document.createElement('style'); css.textContent = 'html,body{background:transparent;margin:0;padding:0}'; document.head.appendChild(css);
  })();

  /* ---------- Lazy image loading via IntersectionObserver ---------- */
  let imgObserver;            // IntersectionObserver for image src swap
  function setupImgObserver(){
    if (imgObserver) imgObserver.disconnect();
    const opts = { rootMargin: '200px 0px', threshold: 0.01 };
    imgObserver = new IntersectionObserver((entries)=>{
      entries.forEach(entry=>{
        if (entry.isIntersecting){
          const img = entry.target; const real = img.getAttribute('data-src');
          if (real){ img.src = real; img.removeAttribute('data-src'); }
          imgObserver.unobserve(img);
        }
      });
    }, opts);
  }

  /* ---------- Card templating (uses data-src for lazy images) ---------- */
  function cardHTML(p){
    const src = (Array.isArray(p.imgs) && p.imgs.length ? p.imgs[0] : (p.img || PLACEHOLDER));
    return `
      <div class="thumb">
        <img src="${LQ_PLACEHOLDER}" data-src="${src}"
             alt="${p.common} thumbnail" loading="lazy" decoding="async" fetchpriority="low"
             referrerpolicy="no-referrer" crossorigin="anonymous"
             onerror="this.onerror=null;this.src='${PLACEHOLDER}'">
      </div>
      <div class="body">
        <h3>${p.common}</h3>
        <div class="latin">${p.latin || ''}</div>
        <div class="chiprow">
          ${p.type ? `<span class="chip">${p.type}</span>` : ''}
          ${p.habitat ? `<span class="chip">${p.habitat}</span>` : ''}
          ${(p.tags||[]).slice(0,3).map(t=>`<span class=\"chip\">#${t}</span>`).join("")}
        </div>
        ${p.teaser ? `<p style="margin:6px 0 0;color:var(--muted);font-size:13px">${p.teaser}</p>` : ''}
        <div class="more">‚Ä∫</div>
      </div>`;
  }

  /* ---------- RENDER (Pagination instead of infinite scroll) ---------- */
  function resetGrid(){ grid.innerHTML = ""; }

  function renderPage(){
    const total = CURRENT.length;
    const { p, start, end } = pageBounds(PAGE, PAGE_SIZE, total);
    PAGE = p; // clamp

    resetGrid();

    if (!total){
      grid.innerHTML = `<div class="empty">No plants match your filters.</div>`;
      updatePager(0, 0, 0);
      schedule();
      return;
    }

    const slice = CURRENT.slice(start, end);
    slice.forEach(p=>{
      const el = document.createElement("article");
      el.className = "card";
      el.innerHTML = cardHTML(p);
      // dataset for rotating card images
      if (p.imgs && p.imgs.length > 1) {
        el.dataset.imgs = p.imgs.join('|');
        el.dataset.idx = '0';
      }
      el.dataset.pid = p.id;
      const img = el.querySelector('img');
      if (img) {
        imgObserver && imgObserver.observe(img);
        img.addEventListener('load', schedule, {once:true});
      }
      // Instead of opening a drawer, redirect to details page
     el.addEventListener("click", () => {
  const id = p.id;
  // Force navigation in the top frame rather than staying in the Wix embed
  window.open(
    `https://natesobol.github.io/howker-ridge-plant-catalog/plant.html?id=${encodeURIComponent(id)}`,
    "_top"
  );
});


      grid.appendChild(el);
    });

    updatePager(total, start + 1, end);

    // keep the host page in charge of scrolling: scroll to the list top
    const wrapTop = document.getElementById('howker-plants').offsetTop;
    try { window.scrollTo({ top: wrapTop, behavior: 'smooth' }); } catch(_) { window.scrollTo(0, wrapTop); }

    schedule();
  }

  /* ---------- Pagination UI ---------- */
  function updatePager(total, from, to){
    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE) || 1);
    TOTAL_PAGES = totalPages;

    const label = total ? `Showing ${from}‚Äì${to} of ${total}` : 'No results';
    statsTop.textContent = label; statsBot.textContent = label;

    const buildButtons = (where) => {
      const host = where === 'top' ? pageListTop : pageListBot;
      host.innerHTML = '';

      const mkBtn = (txt, disabled, onClick, aria) => {
        const b = document.createElement('button');
        b.className = 'page-btn'; b.textContent = txt; b.disabled = !!disabled; if (aria) b.setAttribute('aria-label', aria);
        b.addEventListener('click', onClick);
        return b;
      };

      // First / Prev
      host.appendChild(mkBtn('¬´', PAGE===1, ()=>gotoPage(1), 'First page'));
      host.appendChild(mkBtn('‚Äπ', PAGE===1, ()=>gotoPage(PAGE-1), 'Previous page'));

      // Page window ‚Äî show up to 7 numbers centered on current
      const windowSize = 7;
      let start = Math.max(1, PAGE - Math.floor(windowSize/2));
      let end = Math.min(totalPages, start + windowSize - 1);
      start = Math.max(1, Math.min(start, Math.max(1, end - windowSize + 1)));
      for (let i=start; i<=end; i++){
        const b = mkBtn(String(i), false, ()=>gotoPage(i));
        if (i===PAGE) b.setAttribute('aria-current','page');
        host.appendChild(b);
      }

      // Next / Last
      host.appendChild(mkBtn('‚Ä∫', PAGE===totalPages, ()=>gotoPage(PAGE+1), 'Next page'));
      host.appendChild(mkBtn('¬ª', PAGE===totalPages, ()=>gotoPage(totalPages), 'Last page'));
    };

    buildButtons('top');
    buildButtons('bot');
  }

  function gotoPage(p){ PAGE = Math.max(1, Math.min(p, TOTAL_PAGES)); renderPage(); }

  /* ---------- Filtering ---------- */
  function filter(){
    const q = (qEl.value||"").toLowerCase();
    const t = typeEl.value, h = habEl.value, b = bloomEl.value;
    CURRENT = PLANTS.filter(p=>{
      const hay = [p.common,p.latin,p.type,p.habitat,(p.tags||[]).join(" "),p.teaser,p.desc].join(" ").toLowerCase();
      const okQ = !q || hay.includes(q);
      const okT = !t || p.type===t;
      const okH = !h || p.habitat===h;
      const okB = !b || p.bloom===b;
      return okQ && okT && okH && okB;
    });
    PAGE = 1; // reset to first page after filter
    renderPage();
  }

  function setHidden(id, hidden){ const el = document.getElementById(id); if (!el) return; hidden ? el.setAttribute('hidden','') : el.removeAttribute('hidden'); }

  /* ---------- Card image rotation ---------- */
  function rotateCardImages(){
    const cards = document.querySelectorAll('#grid .card[data-imgs]');
    cards.forEach(card => {
      const imgs = card.dataset.imgs.split('|');
      let idx = parseInt(card.dataset.idx || '0', 10);
      idx = (idx + 1) % imgs.length;
      const imgEl = card.querySelector('.thumb img');
      if (imgEl) {
        imgEl.src = imgs[idx];
        imgEl.removeAttribute('data-src');
      }
      card.dataset.idx = idx;
    });
  }

  /* ---------- Step #4: Robust body scroll lock utility (off by default) ---------- */
  const BodyLock = (()=>{
    let locked = false, y = 0;
    function lock(){
      if (locked) return; locked = true;
      y = window.scrollY || window.pageYOffset || 0;
      Object.assign(document.body.style, { position:'fixed', top:`-${y}px`, width:'100%' });
    }
    function unlock(){
      if (!locked) return; locked = false;
      const restoreY = y; y = 0;
      Object.assign(document.body.style, { position:'', top:'', width:'' });
      window.scrollTo(0, restoreY);
    }
    return { lock, unlock };
  })();
  // NOTE: We keep body unlocked to avoid competing scrolls. If you ever need to lock during a modal:
  // const USE_BODY_LOCK = false; if (USE_BODY_LOCK) BodyLock.lock(); else BodyLock.unlock();

  /* ---------- Init ---------- */
  (async function init(){
    setupImgObserver();
    try{
      const items = await fetchPlants();
      PLANTS = items;
      CURRENT = PLANTS.slice();
      PAGE = 1; TOTAL_PAGES = Math.max(1, Math.ceil(CURRENT.length / PAGE_SIZE));
      renderPage();
      // start rotating card images only if rotateToggle checked
      if (rotateToggle.checked) { rotateInterval = setInterval(rotateCardImages, 5000); }
    }catch(err){
      console.error(err);
      grid.innerHTML = `<div class="error">Couldn‚Äôt load the catalog (network ${err.message}).</div>`;
      schedule();
    }

    // Settings handlers
    themeToggle.addEventListener('change', () => {
      if (themeToggle.checked) { document.body.classList.remove('light'); }
      else { document.body.classList.add('light'); }
    });
    viewToggle.addEventListener('change', () => {
      document.body.classList.toggle('list-view', viewToggle.checked); schedule();
    });
    rotateToggle.addEventListener('change', () => {
      if (rotateToggle.checked) {
        if (!rotateInterval) rotateInterval = setInterval(rotateCardImages, 5000);
      } else {
        if (rotateInterval) { clearInterval(rotateInterval); rotateInterval = null; }
      }
    });
    compactToggle.addEventListener('change', () => {
      document.body.classList.toggle('compact', compactToggle.checked); schedule();
    });
    stickyToggle.addEventListener('change', () => {
      const headerEl = document.querySelector('header');
      headerEl.classList.toggle('sticky', stickyToggle.checked);
    });
  })();

  /* ---------- schedule() proxy used by sizer ---------- */
  function schedule(){ try { if (typeof window.schedule === 'function') window.schedule(); } catch(e){} }

  /* ---------- Keyboard shortcuts for pagination ---------- */
  window.addEventListener('keydown', (e)=>{
    if (e.target && (/input|select|textarea/i).test(e.target.tagName)) return;
    if (e.key === 'ArrowRight') { gotoPage(PAGE + 1); }
    if (e.key === 'ArrowLeft')  { gotoPage(PAGE - 1); }
  });
</script>
</body>
</html>
