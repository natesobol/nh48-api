<!doctype html> 
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="NH48 API – peak-level details, routes, terrain notes and photography for New Hampshire’s 4000-footers.">
    <meta name="keywords" content="NH48 API, New Hampshire 4000 footers, peak details, mountain routes, White Mountains data, hiking API, peak metadata, mountain photos">
    <meta name="robots" content="index,follow">
    <link rel="canonical" href="https://nh48.info/pages/nh48_peak.html">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://nh48.info/pages/nh48_peak.html">
    <meta property="og:title" content="NH48 API – Peak details, routes &amp; photos">
    <meta property="og:description" content="Detailed information for each NH48 peak including elevation, prominence, difficulty, exposure, trail types, routes, terrain description and photo metadata.">
    <meta property="og:image" content="https://cdn.jsdelivr.net/gh/natesobol/nh48-api@main/nh48-preview.png">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://nh48.info/pages/nh48_peak.html">
    <meta name="twitter:title" content="NH48 API – Peak details, routes &amp; photos">
    <meta name="twitter:description" content="Detailed information for each NH48 peak including elevation, prominence, difficulty, exposure, trail types, routes, terrain description and photo metadata.">
    <meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/natesobol/nh48-api@main/nh48-preview.png">
    
    <title>NH48 API – Peak details, routes &amp; photos</title>
    <link rel="icon" type="image/png" href="../nh48API_logo.png">
    <!--
      Standalone details view for a single NH48 peak with robust error handling.
      This version adds:
        • A photo carousel with a circular countdown timer.
        • A “Current Photo Metadata” panel that updates per slide.
        • A “General Peak Info” panel with dotted-line rows.
        • Side-by-side layout of metadata + general info on larger screens.
    -->
    <style>
      :root{
        --bg:#0a0a0a;
        --panel:#12121a;
        --card:#171a22;
        --ink:#ffffff;
        --muted:#a5b4c3;
        --stroke:#ffffff33;
        --accent:#22c55e;
      }
      body{
        margin:0;
        background:var(--bg);
        color:var(--ink);
        font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        -webkit-font-smoothing:antialiased;
        text-rendering:optimizeLegibility;
      }

      /* Navigation Menu - using shared nav from nav.html */
      .top-nav{
        background:var(--panel);
        border-bottom:1px solid var(--stroke);
        padding:12px 0;
        margin-bottom:16px;
      }
      .nav-container{
        max-width:1100px;
        margin:0 auto;
        padding:0 16px;
        display:flex;
        justify-content:space-between;
        align-items:center;
      }
      .nav-brand{
        display:flex;
        align-items:center;
        text-decoration:none;
      }
      .nav-brand img{
        height:40px;
        width:auto;
      }
      .nav-links{
        display:flex;
        gap:24px;
        align-items:center;
      }
      .nav-links a{
        color:var(--ink);
        text-decoration:none;
        font-size:0.95rem;
        transition:color 0.2s ease;
        white-space:nowrap;
      }
      .nav-links a:hover{
        color:var(--accent);
      }
      .nav-toggle{
        display:none;
        background:none;
        border:none;
        color:var(--ink);
        font-size:1.5rem;
        cursor:pointer;
        padding:4px;
      }
      @media(max-width:640px){
        .top-nav{ padding:10px 0; margin-bottom:12px; }
        .nav-container{ padding:0 12px; flex-wrap:wrap; }
        .nav-toggle{ display:block; }
        .nav-links{
          display:none;
          width:100%;
          flex-direction:column;
          gap:12px;
          margin-top:12px;
          padding-top:12px;
          border-top:1px solid var(--stroke);
          align-items:flex-start;
        }
        .nav-links.active{
          display:flex;
        }
        .nav-brand img{ height:32px; }
      }
      .wrap{
        max-width:900px;
        margin:0 auto;
        padding:16px;
      }
      @media(max-width:640px){
        .wrap{ padding:12px; }
      }
      a.back{
        color:var(--accent);
        text-decoration:none;
        display:inline-block;
        margin-bottom:12px;
        font-size:0.95rem;
      }
      h1{
        margin:0 0 16px;
        font-size:clamp(22px,4vw,30px);
        line-height:1.2;
      }
      @media(max-width:640px){
        h1{ margin:0 0 12px; font-size:clamp(18px,5vw,24px); }
      }

      /* MEDIA / CAROUSEL ---------------------------------------------------- */
      .media{
        background:var(--card);
        border:1px solid var(--stroke);
        border-radius:12px;
        overflow:hidden;
        margin-bottom:16px;
        position:relative;
        aspect-ratio:5/3;
      }
      .carousel{
        position:relative;
        width:100%;
        height:100%;
        overflow:hidden;
      }
      .slide{
        position:absolute;
        inset:0;
        opacity:0;
        transition:opacity .35s ease;
      }
      .slide.active{ opacity:1; }
      .slide img{
        width:100%;
        height:100%;
        object-fit:cover;
        display:block;
      }
      .dots{
        position:absolute;
        bottom:8px;
        left:50%;
        transform:translateX(-50%);
        display:flex;
        gap:6px;
        z-index:2;
      }
      .dot{
        width:8px;
        height:8px;
        border-radius:50%;
        border:1px solid #ffffff;
        background:#ffffff22;
        cursor:pointer;
      }
      .dot.active{
        background:#ffffff;
      }
      .ctrls{
        position:absolute;
        inset:0;
        display:flex;
        justify-content:space-between;
        align-items:center;
        pointer-events:none;
      }
      .ctrls button{
        background:#00000055;
        border:1px solid #ffffff;
        color:#ffffff;
        border-radius:8px;
        padding:6px 10px;
        margin:0 8px;
        cursor:pointer;
        pointer-events:auto;
      }

      /* Countdown timer styles ---------------------------------------------- */
      .timer{
        position:absolute;
        top:8px;
        right:8px;
        width:56px;
        height:56px;
        display:flex;
        align-items:center;
        justify-content:center;
        z-index:3;
      }
      .timer svg{
        width:100%;
        height:100%;
        transform:rotate(-90deg);
      }
      .timer-ring{
        fill:none;
        stroke:var(--accent);
        stroke-width:4;
        stroke-linecap:round;
        transition:stroke-dashoffset 0.1s linear;
      }
      .timer-text{
        position:absolute;
        color:var(--accent);
        font-size:0.8rem;
        font-weight:600;
        pointer-events:none;
      }

      /* SHARED PANEL + ROW STYLE -------------------------------------------- */
      .meta-info-row{
        display:grid;
        grid-template-columns:1fr 1fr;
        gap:12px;
        margin-bottom:16px;
      }
      @media(max-width:800px){
        .meta-info-row{
          grid-template-columns:1fr;
        }
      }
      .metadata-panel{
        background:var(--panel);
        border:1px solid var(--stroke);
        border-radius:10px;
        padding:12px;
        font-size:0.9rem;
        word-wrap:break-word;
        white-space:normal;
      }
      .metadata-header{
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:6px;
        gap:8px;
      }
      .metadata-title{
        font-weight:600;
        color:var(--accent);
        font-size:0.85rem;
        text-transform:uppercase;
        letter-spacing:0.5px;
      }
      .meta-toggle{
        background:transparent;
        border:none;
        color:var(--muted);
        font-size:0.8rem;
        cursor:pointer;
        padding:0;
      }
      .metadata-primary,
      .metadata-extra{
        width:100%;
      }
      .metadata-extra{
        display:none;
        margin-top:4px;
      }
      .metadata-extra.open{
        display:block;
      }
      .metadata-row{
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap:12px;
        padding:6px 0;
        border-bottom:1px dotted var(--stroke);
      }
      .metadata-row:last-child{
        border-bottom:none;
      }
      .metadata-label{
        font-weight:600;
        color:var(--muted);
        font-size:0.8rem;
        text-transform:uppercase;
        letter-spacing:0.3px;
        max-width:45%;
      }
      .metadata-value{
        color:var(--ink);
        font-size:0.9rem;
        text-align:right;
        flex:1 1 auto;
        word-break:break-word;
      }

      .section-title{
        margin:20px 0 12px 0;
        font-size:0.95rem;
        font-weight:600;
        color:var(--accent);
        text-transform:uppercase;
        letter-spacing:0.5px;
      }
      @media(max-width:640px){
        .section-title{ margin:16px 0 10px 0; font-size:0.85rem; }
      }
      .info-grid{
        display:grid;
        gap:10px;
        grid-template-columns:1fr;
        margin-bottom:16px;
      }
      .info-panel{
        background:var(--panel);
        border:1px solid var(--stroke);
        border-radius:10px;
        padding:12px;
        font-size:0.9rem;
      }
      @media(max-width:640px){
        .info-panel{ padding:10px; font-size:0.85rem; }
      }
      .info-label{
        font-weight:600;
        color:var(--accent);
        font-size:0.85rem;
        margin-bottom:6px;
        text-transform:uppercase;
        letter-spacing:0.5px;
      }
      @media(max-width:640px){
        .info-label{ font-size:0.8rem; margin-bottom:4px; }
      }
      .info-value{
        color:var(--ink);
        font-size:0.9rem;
        word-wrap:break-word;
        white-space:normal;
      }
    </style>
  </head>
  <body>
    <div id="nav-placeholder"></div>
    <script>
      // Load shared navigation
      fetch('nav.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('nav-placeholder').innerHTML = html;
        })
        .catch(err => console.error('Failed to load navigation:', err));
    </script>
    <div class="wrap">
      <a href="nh48_catalog.html" class="back"> ← Back to catalog</a>
      <h1 id="peakTitle">Loading…</h1>

      <!-- MEDIA / CAROUSEL ---------------------------------------------------->
      <div class="media" id="media" hidden>
        <div class="carousel" id="carousel"></div>
        <div class="dots" id="dots"></div>
        <div class="ctrls">
          <button id="prevBtn" aria-label="Previous image">‹</button>
          <button id="nextBtn" aria-label="Next image">›</button>
        </div>
        <!-- Countdown timer overlay -->
        <div class="timer" id="carouselTimer" hidden>
          <svg viewBox="0 0 40 40">
            <circle id="timerRing" class="timer-ring" cx="20" cy="20" r="18"></circle>
          </svg>
          <span id="timerText" class="timer-text"></span>
        </div>
      </div>

      <!-- METADATA + GENERAL INFO SIDE BY SIDE -------------------------------->
      <div class="meta-info-row">
        <div id="photoMetadataPanel" class="metadata-panel" hidden></div>
        <div id="generalInfoPanel" class="metadata-panel" hidden></div>
      </div>

      <!-- OTHER SECTIONS ------------------------------------------------------>
      <div class="section-title">Hiking Routes</div>
      <div class="info-grid" id="routesGrid" hidden></div>

      <div class="section-title">Trail &amp; Terrain</div>
      <div class="info-grid" id="terrainGrid" hidden></div>

      <div class="section-title">Conditions &amp; Access</div>
      <div class="info-grid" id="conditionsGrid" hidden></div>
    </div>

    <script>
      /* API endpoints */
      const API_URLS = [
        'https://cdn.jsdelivr.net/gh/natesobol/nh48-api@main/data/nh48.json',
        'https://raw.githubusercontent.com/natesobol/nh48-api/main/data/nh48.json'
      ];

      /* Fallback image */
      const PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#172032"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="22">no image</text></svg>`
      );

      const BASE_CANONICAL = 'https://nh48.info/pages/nh48_peak.html';

      function setMeta(name, content){
        let el = document.querySelector(`meta[name="${name}"]`);
        if(!el){
          el = document.createElement('meta');
          el.setAttribute('name', name);
          document.head.appendChild(el);
        }
        el.setAttribute('content', content);
      }

      function setMetaProperty(prop, content){
        let el = document.querySelector(`meta[property="${prop}"]`);
        if(!el){
          el = document.createElement('meta');
          el.setAttribute('property', prop);
          document.head.appendChild(el);
        }
        el.setAttribute('content', content);
      }

      function setCanonical(url){
        let link = document.querySelector('link[rel="canonical"]');
        if(!link){
          link = document.createElement('link');
          link.setAttribute('rel', 'canonical');
          document.head.appendChild(link);
        }
        link.setAttribute('href', url);
      }

      function parseCoordinates(coordStr){
        if(!coordStr) return null;
        const cleaned = coordStr.split(':')[0].trim();
        const [lat, lon] = cleaned.split(',').map(v => parseFloat(v));
        if(Number.isFinite(lat) && Number.isFinite(lon)){
          return { lat, lon };
        }
        return null;
      }

      function buildPhotoAltText(name, meta, index, total){
        const parts = [name];
        if(meta && typeof meta === 'object'){
          if(meta.caption) parts.push(meta.caption);
          if(meta.season) parts.push(meta.season);
          if(meta.timeOfDay) parts.push(meta.timeOfDay);
          if(meta.orientation) parts.push(`${meta.orientation} orientation`);
        }
        parts.push(`image ${index+1} of ${total}`);
        return parts.filter(Boolean).join(' — ');
      }

      function buildPlaceSchema(p, name, canonicalUrl, photoObjects){
        const coords = parseCoordinates(p['Coordinates']);
        const schema = {
          '@context': 'https://schema.org',
          '@type': 'Place',
          'name': name,
          'description': `Detailed information for ${name}, including elevation, prominence, difficulty, exposure, trail types, routes and photography from the NH48 API.`,
          'url': canonicalUrl,
          'creator': {
            '@type': 'Person',
            'name': 'Nathan Sobol',
            'url': 'https://www.nh48pics.com/'
          }
        };

        if(coords){
          schema.geo = { '@type': 'GeoCoordinates', latitude: coords.lat, longitude: coords.lon };
        }
        if(p['Elevation (ft)']){
          schema.elevation = {
            '@type': 'QuantitativeValue',
            'value': p['Elevation (ft)'],
            'unitText': 'ft'
          };
        }
        if(Array.isArray(photoObjects) && photoObjects.length > 0){
          schema.photo = photoObjects;
          schema.image = photoObjects.map(ph => ph.url).filter(Boolean);
        }

        let ld = document.getElementById('peakSchema');
        if(!ld){
          ld = document.createElement('script');
          ld.type = 'application/ld+json';
          ld.id = 'peakSchema';
          document.head.appendChild(ld);
        }
        ld.textContent = JSON.stringify(schema);
      }

      function cleanJSON(raw){
        let cleaned = raw.replace(/:contentReference\[.*?\]\{index=\d+\}/g, '');
        cleaned = cleaned.replace(/\/\*\s*Lines?\s+\d+[\d\-,\s]*omitted\s*\*\//g, '');
        return cleaned;
      }

      async function fetchPeaks(){
        for(let i=0; i<API_URLS.length; i++){
          const url = API_URLS[i];
          try{
            const res = await fetch(url, { mode:'cors' });
            if(!res.ok){
              console.log(`Attempt ${i+1}: Status ${res.status} ${res.statusText}`);
              continue;
            }
            const text = await res.text();
            const cleaned = cleanJSON(text);
            let data;
            try{
              data = JSON.parse(cleaned);
            }catch(err){
              console.error(`JSON parse error: ${err.message}`);
              continue;
            }
            console.log(`Loaded peak data from ${url}`);
            return data;
          }catch(err){
            console.error(`Fetch error: ${err.message || err}`);
          }
        }
        throw new Error('All API endpoints failed');
      }

      function getSlug(){
        const params = new URLSearchParams(window.location.search);
        return params.get('slug');
      }

      /* CAROUSEL + TIMER STATE ----------------------------------------------- */
      let carouselImgs = [];
      let carouselIdx = 0;
      let carouselTimer = null;
      let timerInterval = null;
      let photoMetaData = [];
      let currentDelay = 8000;
      const BASE_DELAY = 8000; // doubled from 4s

      /* METADATA PANEL -------------------------------------------------------- */
      function makeRow(label, value){
        const row = document.createElement('div');
        row.className = 'metadata-row';

        const lab = document.createElement('div');
        lab.className = 'metadata-label';
        lab.textContent = label;

        const val = document.createElement('div');
        val.className = 'metadata-value';
        val.textContent = value;

        row.appendChild(lab);
        row.appendChild(val);
        return row;
      }

      function humanLabelFromKey(key){
        const map = {
          season: 'Season',
          timeOfDay: 'Time of Day',
          orientation: 'Orientation',
          captureDate: 'Capture Date',
          cameraMaker: 'Camera Maker',
          cameraModel: 'Camera Model',
          camera: 'Camera',
          lens: 'Lens',
          fStop: 'F Stop',
          shutterSpeed: 'Shutter Speed',
          iso: 'ISO',
          exposureBias: 'Exposure Bias',
          focalLength: 'Focal Length',
          flashMode: 'Flash Mode',
          meteringMode: 'Metering Mode',
          maxAperture: 'Max Aperture',
          author: 'Author',
          dimensions: 'Dimensions',
          fileSize: 'File Size',
          fileCreateDate: 'File Create Date',
          fileModifiedDate: 'File Modified Date',
          rating: 'Rating'
        };
        if(map[key]) return map[key];
        return key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
      }

      // Always-visible keys
      const PRIMARY_META_KEYS = [
        'season',
        'timeOfDay',
        'orientation',
        'captureDate',
        'focalLength',
        'author'
      ];
      const SKIP_META_KEYS = new Set(['photoId','filename','url','isPrimary','tags']);

      function updateMetadata(i){
        const panel = document.getElementById('photoMetadataPanel');
        panel.innerHTML = '';

        const header = document.createElement('div');
        header.className = 'metadata-header';

        const title = document.createElement('div');
        title.className = 'metadata-title';
        title.textContent = 'Current Photo Metadata';

        header.appendChild(title);
        panel.appendChild(header);

        const primaryWrap = document.createElement('div');
        primaryWrap.className = 'metadata-primary';
        panel.appendChild(primaryWrap);

        const extraWrap = document.createElement('div');
        extraWrap.className = 'metadata-extra';
        panel.appendChild(extraWrap);

        const meta = (photoMetaData && photoMetaData[i]) || null;

        if(!meta || typeof meta !== 'object'){
          primaryWrap.appendChild(makeRow('Metadata', 'Not available'));
          panel.hidden = false;
          return;
        }

        // Fill primary entries in specified order
        let hasPrimary = false;
        PRIMARY_META_KEYS.forEach(key => {
          const val = meta[key];
          if(val !== undefined && val !== null && String(val).trim() !== ''){
            primaryWrap.appendChild(makeRow(humanLabelFromKey(key), String(val)));
            hasPrimary = true;
          }
        });

        // Collect all other entries
        const extras = [];
        for(const [key, value] of Object.entries(meta)){
          if(SKIP_META_KEYS.has(key)) continue;
          if(PRIMARY_META_KEYS.includes(key)) continue;
          if(value === undefined || value === null || String(value).trim() === '') continue;
          extras.push([key, value]);
        }
        extras.sort((a,b) => a[0].localeCompare(b[0]));

        let hasExtra = false;
        extras.forEach(([key,val]) => {
          extraWrap.appendChild(makeRow(humanLabelFromKey(key), String(val)));
          hasExtra = true;
        });

        if(!hasPrimary && !hasExtra){
          primaryWrap.appendChild(makeRow('Metadata', 'Not available'));
        }

        if(hasExtra){
          const toggleBtn = document.createElement('button');
          toggleBtn.type = 'button';
          toggleBtn.className = 'meta-toggle';
          toggleBtn.textContent = 'More details ▾';
          header.appendChild(toggleBtn);

          toggleBtn.addEventListener('click', () => {
            const open = extraWrap.classList.toggle('open');
            toggleBtn.textContent = open ? 'Less details ▴' : 'More details ▾';
          });
        }

        panel.hidden = false;
      }

      /* GENERAL PEAK INFO PANEL ---------------------------------------------- */
      function buildGeneralInfo(p){
        const panel = document.getElementById('generalInfoPanel');
        panel.innerHTML = '';

        const header = document.createElement('div');
        header.className = 'metadata-header';

        const title = document.createElement('div');
        title.className = 'metadata-title';
        title.textContent = 'General Peak Info';

        header.appendChild(title);
        panel.appendChild(header);

        const body = document.createElement('div');
        body.className = 'metadata-primary';
        panel.appendChild(body);

        const elev = p['Elevation (ft)'];
        const prom = p['Prominence (ft)'];

        body.appendChild(makeRow('Elevation', elev ? `${elev}'` : '—'));
        body.appendChild(makeRow('Prominence', prom ? `${prom}'` : '—'));
        body.appendChild(makeRow('Range', p['Range / Subrange'] || '—'));
        body.appendChild(makeRow('Trail Type', p['Trail Type'] || '—'));
        body.appendChild(makeRow('Difficulty', p['Difficulty'] || '—'));
        body.appendChild(makeRow('Exposure', p['Exposure Level'] || p['Weather Exposure Rating'] || '—'));

        panel.hidden = false;
      }

      /* CAROUSEL ------------------------------------------------------------- */
      function buildCarousel(images, meta, altBase){
        const carouselEl = document.getElementById('carousel');
        const dotsEl = document.getElementById('dots');
        carouselEl.innerHTML = '';
        dotsEl.innerHTML = '';

        carouselImgs = [];
        carouselIdx = 0;
        photoMetaData = meta || [];

        if(!images || images.length === 0){
          images = [PLACEHOLDER];
          photoMetaData = [{}];
        }

        images.forEach((src, i) => {
          const slide = document.createElement('div');
          slide.className = 'slide' + (i === 0 ? ' active' : '');

          const img = document.createElement('img');
          img.alt = buildPhotoAltText(altBase, meta[i], i, images.length);

          if(i === 0){
            img.src = src;
          }else{
            img.loading = 'lazy';
            img.decoding = 'async';
            img.setAttribute('data-src', src);
            img.src = PLACEHOLDER;
          }

          img.onerror = () => { img.onerror = null; img.src = PLACEHOLDER; };

          slide.appendChild(img);
          carouselEl.appendChild(slide);
          carouselImgs.push(img);

          const dot = document.createElement('div');
          dot.className = 'dot' + (i === 0 ? ' active' : '');
          dot.addEventListener('click', () => goTo(i, true));
          dotsEl.appendChild(dot);
        });

        document.getElementById('media').hidden = false;
        document.getElementById('carouselTimer').hidden = false;

        // Controls
        document.getElementById('prevBtn').onclick = () => prev(true);
        document.getElementById('nextBtn').onclick = () => next(true);

        // Initialise
        updateMetadata(0);
        setupCarouselLazyLoading();
        startCarousel();
      }

      function updateSlides(){
        const slides = Array.from(document.querySelectorAll('.slide'));
        const dots = Array.from(document.querySelectorAll('.dot'));
        slides.forEach((s,i) => s.classList.toggle('active', i === carouselIdx));
        dots.forEach((d,i) => d.classList.toggle('active', i === carouselIdx));
        updateMetadata(carouselIdx);
      }

      function ensureImgLoaded(i){
        const img = carouselImgs[i];
        if(!img) return;
        const real = img.getAttribute('data-src');
        if(real){
          img.src = real;
          img.removeAttribute('data-src');
        }
      }

      function next(manual=false){
        carouselIdx = (carouselIdx + 1) % carouselImgs.length;
        ensureImgLoaded(carouselIdx);
        updateSlides();
        if(manual){ startCarousel(); }
      }

      function prev(manual=false){
        carouselIdx = (carouselIdx - 1 + carouselImgs.length) % carouselImgs.length;
        ensureImgLoaded(carouselIdx);
        updateSlides();
        if(manual){ startCarousel(); }
      }

      function goTo(i, manual=false){
        carouselIdx = i % carouselImgs.length;
        ensureImgLoaded(carouselIdx);
        updateSlides();
        if(manual){ startCarousel(); }
      }

      function startCarousel(){
        stopCarousel();
        currentDelay = BASE_DELAY + Math.floor(Math.random()*2000);
        // start the visual timer immediately
        startTimer(currentDelay);
        // and reset both slide + timer on each automatic flip
        carouselTimer = setInterval(() => {
          next(false);
          startTimer(currentDelay);
        }, currentDelay);
      }

      function stopCarousel(){
        if(carouselTimer){
          clearInterval(carouselTimer);
          carouselTimer = null;
        }
        if(timerInterval){
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      function setupCarouselLazyLoading(){
        if (!('IntersectionObserver' in window)){
          carouselImgs.forEach(img => {
            const src = img.getAttribute('data-src');
            if(src){ img.src = src; img.removeAttribute('data-src'); }
          });
          return;
        }
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if(entry.isIntersecting){
              const img = entry.target;
              const src = img.getAttribute('data-src');
              if(src){ img.src = src; img.removeAttribute('data-src'); }
              observer.unobserve(img);
            }
          });
        }, { rootMargin:'100px' });
        carouselImgs.forEach(img => {
          if(img.getAttribute('data-src')) observer.observe(img);
        });
      }

      /* COUNTDOWN TIMER ------------------------------------------------------ */
      function startTimer(duration){
        const ring = document.getElementById('timerRing');
        const textEl = document.getElementById('timerText');
        if(!ring || !textEl) return;

        const radius = 18;
        const circumference = 2 * Math.PI * radius;
        ring.style.strokeDasharray = circumference;
        ring.style.strokeDashoffset = 0;

        const start = Date.now();
        const end = start + duration;

        if(timerInterval) clearInterval(timerInterval);

        timerInterval = setInterval(() => {
          const now = Date.now();
          const remaining = Math.max(end - now, 0);
          const percent = remaining / duration;
          const offset = circumference * (1 - percent);
          ring.style.strokeDashoffset = offset;
          const secs = Math.ceil(remaining / 1000);
          textEl.textContent = secs;
          if(remaining <= 0){
            clearInterval(timerInterval);
            timerInterval = null;
          }
        }, 100);

        textEl.textContent = Math.ceil(duration / 1000);
      }

      /* INIT ----------------------------------------------------------------- */
      async function init(){
        const slug = getSlug();
        const peakTitle = document.getElementById('peakTitle');
        
        if (!peakTitle) {
          console.error('Peak title element not found');
          return;
        }
        
        if(!slug){
          peakTitle.textContent = 'Peak not specified';
          return;
        }

        try{
          const data = await fetchPeaks();
          const p = data && data[slug];

          if(!p){
            peakTitle.textContent = 'Peak not found';
            return;
          }

          const name = p.peakName || p['Peak Name'] || slug;
          peakTitle.textContent = name;

          const canonicalUrl = slug ? `${BASE_CANONICAL}?slug=${encodeURIComponent(slug)}` : BASE_CANONICAL;
          const description = `Detailed information for ${name}, including elevation, prominence, difficulty, exposure, trail types, routes, terrain description and photo metadata.`;

          document.title = `NH48 API – ${name} details, routes & photos`;
          setCanonical(canonicalUrl);
          setMeta('description', description);
          setMeta('keywords', `NH48 API, ${name} peak details, New Hampshire 4000 footers, White Mountains routes, hiking data, peak metadata, mountain photos`);
          setMetaProperty('og:title', `NH48 API – ${name} details, routes & photos`);
          setMetaProperty('og:description', description);
          setMetaProperty('og:url', canonicalUrl);

          // Build general info panel
          buildGeneralInfo(p);

          // Routes
          const routes = p['Standard Routes'] || [];
          if(routes.length > 0){
            const routesGrid = document.getElementById('routesGrid');
            routes.forEach(r => {
              const div = document.createElement('div');
              div.className = 'info-panel';
              const dist  = r['Distance (mi)'] || '—';
              const gain  = r['Elevation Gain (ft)'] || '—';
              const diff  = r['Difficulty'] || '—';
              div.innerHTML = `
                <div class="info-label">${r['Route Name']}</div>
                <div class="info-value">
                  <strong>Distance:</strong> ${dist} mi • 
                  <strong>Gain:</strong> ${gain}' • 
                  <strong>Difficulty:</strong> ${diff}
                </div>`;
              routesGrid.appendChild(div);
            });
            routesGrid.hidden = false;
          }

          // Terrain & view
          const terrainItems = [
            { label:'Terrain', value:p['Terrain Character'] },
            { label:'Scramble', value:p['Scramble Sections'] },
            { label:'View', value:p['View Type'] }
          ].filter(x => x.value);

          if(terrainItems.length > 0){
            const terrainGrid = document.getElementById('terrainGrid');
            terrainItems.forEach(item => {
              const div = document.createElement('div');
              div.className = 'info-panel';
              div.innerHTML = `
                <div class="info-label">${item.label}</div>
                <div class="info-value">${item.value}</div>`;
              terrainGrid.appendChild(div);
            });
            terrainGrid.hidden = false;
          }

          // Conditions & access
          const conditionItems = [
            { label:'Best Seasons', value:p['Best Seasons to Hike'] },
            { label:'Water Availability', value:p['Water Availability'] },
            { label:'Cell Reception', value:p['Cell Reception Quality'] },
            { label:'Weather Exposure', value:p['Weather Exposure Rating'] },
            { label:'Emergency Bailout', value:p['Emergency Bailout Options'] },
            { label:'Dog Friendly', value:p['Dog Friendly'] },
            { label:'Nearby Features', value:p['Nearby Notable Features'] }
          ].filter(x => x.value);

          if(conditionItems.length > 0){
            const conditionsGrid = document.getElementById('conditionsGrid');
            conditionItems.forEach(item => {
              const div = document.createElement('div');
              div.className = 'info-panel';
              div.innerHTML = `
                <div class="info-label">${item.label}</div>
                <div class="info-value">${item.value}</div>`;
              conditionsGrid.appendChild(div);
            });
            conditionsGrid.hidden = false;
          }

          // Photos + per-photo metadata
          let imgs = [];
          let meta = [];
          if(Array.isArray(p.photos) && p.photos.length > 0){
            p.photos.forEach(item => {
              if(typeof item === 'string'){
                imgs.push(item);
                meta.push({ url: item });
              }else if(item && item.url){
                imgs.push(item.url);
                meta.push(item);
              }
            });
          }
          if(imgs.length === 0){
            imgs = [PLACEHOLDER];
            meta = [{}];
          }

          const primaryImage = imgs[0] || 'https://cdn.jsdelivr.net/gh/natesobol/nh48-api@main/nh48API_logo.png';
          setMetaProperty('og:image', primaryImage);

          const photoObjects = meta.map((m, idx) => {
            const obj = {
              '@type': 'ImageObject',
              url: imgs[idx] || m.url,
              contentUrl: imgs[idx] || m.url,
              name: `${name} photo ${idx + 1}`,
              caption: m.caption || undefined,
              creator: m.author ? { '@type': 'Person', name: m.author } : undefined,
              dateCreated: m.captureDate || m.fileCreateDate || undefined
            };
            const exifData = {
              camera: m.cameraModel || m.cameraMaker || m.camera || undefined,
              lens: m.lens || undefined,
              exposureTime: m.shutterSpeed || undefined,
              aperture: m.fStop || undefined,
              iso: m.iso || undefined
            };
            Object.keys(exifData).forEach(key => {
              if(exifData[key] === undefined){
                delete exifData[key];
              }
            });
            if(Object.keys(exifData).length > 0){
              obj.exifData = exifData;
            }
            if(idx === 0){
              obj.representativeOfPage = true;
            }
            Object.keys(obj).forEach(key => {
              if(obj[key] === undefined || obj[key] === null){
                delete obj[key];
              }
            });
            if(obj.exifData && Object.values(obj.exifData).every(v => v === undefined)){
              delete obj.exifData;
            }
            return obj;
          });

          buildPlaceSchema(p, name, canonicalUrl, photoObjects);

          buildCarousel(imgs, meta, name);

        }catch(err){
          console.error('Error loading peak data:', err);
          const peakTitle = document.getElementById('peakTitle');
          if (peakTitle) {
            peakTitle.textContent = 'Error loading peak';
          }
        }
      }

      window.addEventListener('load', init);
    </script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
      import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCUSHYxwXVGEDNzMeIwSFmDaYeXSqRK4A",
        authDomain: "nh48-info.firebaseapp.com",
        projectId: "nh48-info",
        storageBucket: "nh48-info.firebasestorage.app",
        messagingSenderId: "732743288228",
        appId: "1:732743288228:web:d82d62cae0c3999ee5ad31",
        measurementId: "G-Q9F2W8YB7D"
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);

      // Expose globally for app scripts
      window.NH48_INFO_ANALYTICS = {
        analytics,
        logEvent
      };

      // Base page-load event
      logEvent(analytics, "page_loaded", {
        site: "nh48-info",
        page: location.pathname
      });
    </script>
  </body>
</html>
