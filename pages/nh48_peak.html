<!doctype html> 
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Detailed information about New Hampshire 4000-foot peaks including routes, terrain, conditions, and photos.">
    <title>NH48 Peak Details - New Hampshire 4000-Footers</title>
    <link rel="icon" type="image/png" href="../nh48API_logo.png">
    <link rel="stylesheet" href="../css/nh48_peak.css">
    <!--
      Standalone details view for a single NH48 peak with robust error handling.
      This version adds:
        • A photo carousel with a circular countdown timer.
        • A "Current Photo Metadata" panel that updates per slide.
        • A "General Peak Info" panel with dotted-line rows.
        • Side-by-side layout of metadata + general info on larger screens.
    -->
  </head>
  <body>
    <nav class="top-nav">
      <div class="nav-container">
        <a href="nh48_catalog.html" class="nav-brand"><img src="../nh48API_logo.png" alt="NH48 Logo"></a>
        <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">☰</button>
        <div class="nav-links" id="navLinks">
          <a href="nh48_catalog.html">Catalog</a>
          <a href="nh48_peak.html">Peak Details</a>
          <a href="trails_app.html">WMNF Trails</a>
          <a href="https://nh48pics.com" target="_blank" rel="noopener">NH48 Pics</a>
          <a href="https://nh48.app" target="_blank" rel="noopener">Peak Bagger</a>
        </div>
      </div>
    </nav>
    <div class="wrap">
      <a href="nh48_catalog.html" class="back"> ← Back to catalog</a>
      <h1 id="peakTitle">Loading…</h1>

      <!-- MEDIA / CAROUSEL ---------------------------------------------------->
      <div class="media" id="media" hidden>
        <div class="carousel" id="carousel"></div>
        <div class="dots" id="dots"></div>
        <div class="ctrls">
          <button id="prevBtn" aria-label="Previous image">‹</button>
          <button id="nextBtn" aria-label="Next image">›</button>
        </div>
        <!-- Countdown timer overlay -->
        <div class="timer" id="carouselTimer" hidden>
          <svg viewBox="0 0 40 40">
            <circle id="timerRing" class="timer-ring" cx="20" cy="20" r="18"></circle>
          </svg>
          <span id="timerText" class="timer-text"></span>
        </div>
      </div>

      <!-- GRID FOR PHOTO METADATA + GENERAL PEAK INFO ----------------------->
      <div class="grid2">
        <div id="photoMetadataPanel" class="metadata-panel" hidden></div>
        <div id="generalInfoPanel" class="metadata-panel" hidden></div>
      </div>

      <!-- OTHER SECTIONS ------------------------------------------------------>
      <div class="section-title">Hiking Routes</div>
      <div class="info-section" id="routesSection" hidden></div>

      <div class="section-title">Terrain & Conditions</div>
      <div class="info-section" id="terrainSection" hidden></div>

      <div class="section-title">Trail Conditions</div>
      <div class="info-section" id="conditionsSection" hidden></div>
    </div>

    <script>
      /* API endpoints */
      const API_URLS = [
        'https://cdn.jsdelivr.net/gh/natesobol/nh48-api@main/data/nh48.json',
        'https://raw.githubusercontent.com/natesobol/nh48-api/main/data/nh48.json'
      ];

      /* Fallback image */
      const PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#172032"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#64748b" font-family="system-ui" font-size="22">no image</text></svg>`
      );

      function cleanJSON(raw){
        let cleaned = raw.replace(/:contentReference\[.*?\]\{index=\d+\}/g, '');
        cleaned = cleaned.replace(/\/\*\s*Lines?\s+\d+[\d\-,\s]*omitted\s*\*\//g, '');
        return cleaned;
      }

      async function fetchPeaks(){
        for(let i=0; i<API_URLS.length; i++){
          const url = API_URLS[i];
          try{
            const res = await fetch(url, { mode:'cors' });
            if(!res.ok){
              console.log(`Attempt ${i+1}: Status ${res.status} ${res.statusText}`);
              continue;
            }
            const text = await res.text();
            const cleaned = cleanJSON(text);
            let data;
            try{
              data = JSON.parse(cleaned);
            }catch(err){
              console.error(`JSON parse error: ${err.message}`);
              continue;
            }
            console.log(`Loaded peak data from ${url}`);
            return data;
          }catch(err){
            console.error(`Fetch error: ${err.message || err}`);
          }
        }
        throw new Error('All API endpoints failed');
      }

      /* Render the photo carousel */
      function getSlug(){
        const params = new URLSearchParams(window.location.search);
        return params.get('slug');
      }

      /* CAROUSEL + TIMER STATE ----------------------------------------------- */
      let carouselImgs = [];
      let carouselIdx = 0;
      let carouselTimer = null;
      let timerInterval = null;
      let photoMetaData = [];
      let currentDelay = 8000;
      const BASE_DELAY = 8000; // doubled from 4s

      /* METADATA PANEL -------------------------------------------------------- */
      function makeRow(label, value){
        const row = document.createElement('div');
        row.className = 'metadata-row';

        const lab = document.createElement('div');
        lab.className = 'metadata-label';
        lab.textContent = label;

        const val = document.createElement('div');
        val.className = 'metadata-value';
        val.textContent = value || '—';

        row.appendChild(lab);
        row.appendChild(val);
        return row;
      }

      function updatePhotoMetadata(idx){
        if(idx < 0 || idx >= photoMetaData.length) return;

        const meta = photoMetaData[idx];
        const panel = document.getElementById('photoMetadataPanel');
        if(!panel) return;

        panel.innerHTML = '';

        const title = document.createElement('h3');
        title.className = 'metadata-title';
        title.textContent = 'Current Photo Metadata';
        panel.appendChild(title);

        const keys = Object.keys(meta).filter(k => k !== 'url');
        if(keys.length === 0){
          const empty = document.createElement('div');
          empty.className = 'metadata-empty';
          empty.textContent = 'No metadata available';
          panel.appendChild(empty);
        } else {
          keys.forEach(key => {
            const label = humanLabelFromKey(key);
            panel.appendChild(makeRow(label, meta[key]));
          });
        }
      }

      function humanLabelFromKey(key){
        const map = {
          season: 'Season',
          timeOfDay: 'Time of Day',
          orientation: 'Orientation',
          captureDate: 'Capture Date',
          focalLength: 'Focal Length',
          author: 'Author',
          aperture: 'Aperture',
          shutterSpeed: 'Shutter Speed',
          iso: 'ISO',
          camera: 'Camera',
          lens: 'Lens',
          description: 'Description',
          location: 'Location',
          weather: 'Weather',
          temperature: 'Temperature',
          keywords: 'Keywords',
          fileSize: 'File Size',
          dimensions: 'Dimensions',
          fileModifiedDate: 'File Modified Date',
          rating: 'Rating'
        };
        if(map[key]) return map[key];
        return key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
      }

      // Always-visible keys
      const PRIMARY_META_KEYS = [
        'season',
        'timeOfDay',
        'orientation',
        'captureDate',
        'focalLength',
        'author'
      ];
      const SKIP_META_KEYS = new Set(['photoId','filename','url','isPrimary','tags']);

      function updateMetadata(i){
        const panel = document.getElementById('photoMetadataPanel');
        panel.innerHTML = '';

        const header = document.createElement('div');
        header.className = 'metadata-header';

        const title = document.createElement('div');
        title.className = 'metadata-title';
        title.textContent = 'Current Photo Metadata';

        header.appendChild(title);
        panel.appendChild(header);

        const primaryWrap = document.createElement('div');
        primaryWrap.className = 'metadata-primary';
        panel.appendChild(primaryWrap);

        const extraWrap = document.createElement('div');
        extraWrap.className = 'metadata-extra';
        panel.appendChild(extraWrap);

        const meta = (photoMetaData && photoMetaData[i]) || null;

        if(!meta || typeof meta !== 'object'){
          primaryWrap.appendChild(makeRow('Metadata', 'Not available'));
          panel.hidden = false;
          return;
        }

        // Fill primary entries in specified order
        let hasPrimary = false;
        PRIMARY_META_KEYS.forEach(key => {
          const val = meta[key];
          if(val !== undefined && val !== null && String(val).trim() !== ''){
            primaryWrap.appendChild(makeRow(humanLabelFromKey(key), String(val)));
            hasPrimary = true;
          }
        });

        // Collect all other entries
        const extras = [];
        for(const [key, value] of Object.entries(meta)){
          if(SKIP_META_KEYS.has(key)) continue;
          if(PRIMARY_META_KEYS.includes(key)) continue;
          if(value === undefined || value === null || String(value).trim() === '') continue;
          extras.push([key, value]);
        }
        extras.sort((a,b) => a[0].localeCompare(b[0]));

        if(extras.length > 0){
          const toggleBtn = document.createElement('button');
          toggleBtn.type = 'button';
          toggleBtn.className = 'meta-toggle';
          toggleBtn.textContent = 'More details ▾';
          header.appendChild(toggleBtn);

          toggleBtn.addEventListener('click', () => {
            const open = extraWrap.classList.toggle('open');
            toggleBtn.textContent = open ? 'Less details ▴' : 'More details ▾';
          });
        }

        panel.hidden = false;
      }

      /* GENERAL PEAK INFO PANEL ---------------------------------------------- */
      function buildGeneralInfo(p){
        const panel = document.getElementById('generalInfoPanel');
        panel.innerHTML = '';

        const header = document.createElement('div');
        header.className = 'metadata-header';

        const title = document.createElement('div');
        title.className = 'metadata-title';
        title.textContent = 'General Peak Info';

        header.appendChild(title);
        panel.appendChild(header);

        const body = document.createElement('div');
        body.className = 'metadata-primary';
        panel.appendChild(body);

        const elev = p['Elevation (ft)'];
        const prom = p['Prominence (ft)'];

        body.appendChild(makeRow('Elevation', elev ? `${elev}'` : '—'));
        body.appendChild(makeRow('Prominence', prom ? `${prom}'` : '—'));
        body.appendChild(makeRow('Range', p['Range / Subrange'] || '—'));
        body.appendChild(makeRow('Trail Type', p['Trail Type'] || '—'));
        body.appendChild(makeRow('Difficulty', p['Difficulty'] || '—'));
        body.appendChild(makeRow('Exposure', p['Exposure Level'] || p['Weather Exposure Rating'] || '—'));

        panel.hidden = false;
      }

      /* CAROUSEL RENDERING --------------------------------------------------- */
      function buildCarousel(images, meta, altBase){
        const carouselEl = document.getElementById('carousel');
        const dotsEl = document.getElementById('dots');
        carouselEl.innerHTML = '';
        dotsEl.innerHTML = '';

        carouselImgs = [];
        carouselIdx = 0;
        photoMetaData = meta || [];

        if(!images || images.length === 0){
          images = [PLACEHOLDER];
          photoMetaData = [{}];
        }

        images.forEach((src, i) => {
          const slide = document.createElement('div');
          slide.className = 'slide' + (i === 0 ? ' active' : '');

          const img = document.createElement('img');
          img.alt = `${altBase} image ${i+1} of ${images.length}`;
          img.src = src;

          slide.appendChild(img);
          carouselEl.appendChild(slide);
          carouselImgs.push(src);

          const dot = document.createElement('button');
          dot.className = 'dot' + (i === 0 ? ' active' : '');
          dot.setAttribute('aria-label', `Slide ${i+1}`);
          dot.addEventListener('click', () => goToSlide(i));
          dotsEl.appendChild(dot);
        });

        if(images.length > 1){
          startAutoplay();
        }

        updateMetadata(0);
      }

      function goToSlide(index){
        if(index < 0 || index >= carouselImgs.length) return;
        carouselIdx = index;
        const slides = Array.from(document.querySelectorAll('.slide'));
        const dots = Array.from(document.querySelectorAll('.dot'));
        slides.forEach((s,i) => s.classList.toggle('active', i === carouselIdx));
        dots.forEach((d,i) => d.classList.toggle('active', i === carouselIdx));
        updateMetadata(index);
        startAutoplay();
      }

      function startAutoplay(){
        if(carouselTimer) clearInterval(carouselTimer);
        if(carouselImgs.length <= 1) return;
        currentDelay = BASE_DELAY;
        carouselTimer = setInterval(() => {
          carouselIdx = (carouselIdx + 1) % carouselImgs.length;
          goToSlide(carouselIdx);
        }, currentDelay);
      }

      function stopAutoplay(){
        if(carouselTimer){
          clearInterval(carouselTimer);
          carouselTimer = null;
        }
      }

      /* RENDER INFO SECTIONS ------------------------------------------------- */
      function renderInfoGrid(gridId, items, mapFn){
        const grid = document.getElementById(gridId);
        if(!grid) return;
        grid.innerHTML = '';
        if(!items || items.length === 0){
          grid.innerHTML = '<div class="info-empty">No data available</div>';
          grid.hidden = false;
          return;
        }
        items.forEach(item => {
          const block = document.createElement('div');
          block.className = 'info-block';
          const content = mapFn(item);
          if(content) block.innerHTML = content;
          grid.appendChild(block);
        });
        grid.hidden = false;
      }

      function startTimer(duration){
        if(timerInterval) clearInterval(timerInterval);

        const ring = document.getElementById('timerRing');
        const textEl = document.getElementById('timerText');
        if(!ring || !textEl) return;

        const radius = 18;
        const circumference = 2 * Math.PI * radius;
        ring.style.strokeDasharray = `${circumference} ${circumference}`;
        ring.style.strokeDashoffset = 0;

        let remaining = duration;
        timerInterval = setInterval(() => {
          remaining -= 100;
          const percent = remaining / duration;
          const offset = circumference * (1 - percent);
          ring.style.strokeDashoffset = offset;
          const secs = Math.ceil(remaining / 1000);
          textEl.textContent = secs;
          if(remaining <= 0){
            clearInterval(timerInterval);
            timerInterval = null;
          }
        }, 100);

        textEl.textContent = Math.ceil(duration / 1000);
      }

      /* INIT ----------------------------------------------------------------- */
      async function init(){
        const slug = getSlug();
        if(!slug){
          document.getElementById('peakTitle').textContent = 'Peak not specified';
          return;
        }

        try{
          const data = await fetchPeaks();
          const p = data && data[slug];

          if(!p){
            document.getElementById('peakTitle').textContent = 'Peak not found';
            return;
          }

          const name = p.peakName || p['Peak Name'] || slug;
          document.getElementById('peakTitle').textContent = name;

          // Build general info panel
          buildGeneralInfo(p);

          // Build carousel
          const photos = p.photos || [];
          const images = photos.map(ph => {
            if(typeof ph === 'string') return ph;
            return ph.url || PLACEHOLDER;
          });
          const photoMeta = photos.map(ph => {
            if(typeof ph === 'object' && ph !== null) return ph;
            return {};
          });
          buildCarousel(images, photoMeta, name);

          // Render info sections
          if(p['Standard Routes']){
            renderInfoGrid('routesGrid', p['Standard Routes'], route => {
              return `<div class="info-label">${route.name || 'Route'}</div><div>${route.description || ''}</div>`;
            });
          }
          if(p.terrain){
            renderInfoGrid('terrainGrid', [p.terrain], t => `<div>${t}</div>`);
          }
          if(p.conditions){
            renderInfoGrid('conditionsGrid', [p.conditions], c => `<div>${c}</div>`);
          }

        }catch(err){
          console.error(err);
          document.getElementById('peakTitle').textContent = 'Error loading peak data';
        }
      }

      window.addEventListener('load', init);

      // Mobile navigation toggle
      document.getElementById('navToggle').addEventListener('click', () => {
        document.getElementById('navLinks').classList.toggle('active');
      });
    </script>
  </body>
</html>
