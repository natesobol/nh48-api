<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
    <link rel="icon" href="https://nh48.info/favicon.png" sizes="48x48" type="image/png">
    <link rel="icon" href="https://nh48.info/icon-192.png" sizes="192x192" type="image/png">
    <link rel="apple-touch-icon" href="https://nh48.info/apple-touch-icon.png">
    <link rel="icon" href="https://nh48.info/favicon.ico" sizes="any" type="image/x-icon">
    <link rel="manifest" href="/manifest.json">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Howker Ridge Plant Log Map ‚Äì NH48.info</title>
<meta name="description" content="Interactive map to explore and record alpine plant observations along the Howker Ridge Trail." />
<meta name="keywords" content="Howker Ridge Trail plant log, plant log map, alpine plant observations, Mount Madison, New Hampshire, White Mountains, plant logs, interactive map, plant sightings map" />
<link rel="canonical" href="https://nh48.info/projects/plant-map" />
<meta property="og:type" content="website" />
<meta property="og:title" content="Howker Ridge Plant Log Map ‚Äì NH48.info" />
<meta property="og:description" content="Interactive map to explore and record alpine plant observations along the Howker Ridge Trail." />
<meta property="og:url" content="https://nh48.info/projects/plant-map" />
<meta property="og:image" content="https://photos.nh48.info/cdn-cgi/image/format=jpg,quality=85,width=1200/mount-madison/mount-madison__003.jpg" />
<meta property="og:image:alt" content="Mount Madison ridge view with alpine terrain and distant peaks" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Howker Ridge Plant Log Map ‚Äì NH48.info" />
<meta name="twitter:description" content="Interactive map to explore and record alpine plant observations along the Howker Ridge Trail." />
<meta name="twitter:image" content="https://photos.nh48.info/cdn-cgi/image/format=jpg,quality=85,width=1200/mount-madison/mount-madison__003.jpg" />
<meta name="twitter:image:alt" content="Mount Madison ridge view with alpine terrain and distant peaks" />
<script>
  (() => {
    if (window.NH48_BUILD_DATE) return;
    try {
      const xhr = new XMLHttpRequest();
      xhr.open('GET', '/build-meta.json', false);
      xhr.send(null);
      if (xhr.status >= 200 && xhr.status < 300) {
        const meta = JSON.parse(xhr.responseText);
        if (meta && meta.buildDate) {
          window.NH48_BUILD_DATE = meta.buildDate;
        }
      }
    } catch (err) {
      // No-op: build date is optional in static builds.
    }
  })();
</script>
<script src="/js/unified-footer.js" defer></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha384-sHL9NAb7lN7rfvG5lfHpm643Xkcjzp4jFvuavGOndn6pjVqS6ny56CAt3nsEVT4H" crossorigin="" />
<style>
:root{
  --bg:#0a0a0a;
  --panel:#12121a;
  --card:#171a22;
  --ink:#ffffff;
  --muted:#a5b4c3;
  --stroke:#ffffff;
  --accent:#22c55e;
  --accent-2:#38bdf8;
  --gap:16px;
}
body.light{
  --bg:#f8fafc;
  --panel:#ffffff;
  --card:#f7f9fc;
  --ink:#1f2937;
  --muted:#6b7280;
  --stroke:#00000022;
  --accent:#22c55e;
  --accent-2:#0ea5e9;
}
*{ box-sizing:border-box; }
html{ min-width:320px; scroll-behavior:smooth; }
@media (prefers-reduced-motion: reduce){
  html{ scroll-behavior:auto; }
}
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;
  text-rendering:optimizeLegibility;
}
.wrap{
  max-width:1200px;
  margin:0 auto;
  padding:12px;
}
.panel{
  background:var(--panel);
  border:none;
  border-radius:10px;
  margin-top:1.5rem;
  padding:20px;
  box-shadow:0 10px 30px #0004;
}
header h1{
  margin:0 0 8px;
  font-size:clamp(24px,3vw,34px);
  letter-spacing:.2px;
}
header p{
  margin:0;
  color:var(--muted);
}
.page-breadcrumbs{
  margin:10px 0 18px;
  font-size:13px;
  color:var(--muted);
}
.page-breadcrumbs ol{
  list-style:none;
  padding:0;
  margin:0;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.page-breadcrumbs li::after{
  content:"/";
  margin-left:6px;
  color:var(--muted);
}
.page-breadcrumbs li:last-child::after{
  content:"";
}
.page-breadcrumbs a{
  color:inherit;
  text-decoration:none;
}
.page-breadcrumbs a:hover{
  color:var(--accent);
}
.breadcrumb{
  margin:10px 0 18px;
  font-size:13px;
  color:var(--muted);
}
.breadcrumb a{
  color:inherit;
  text-decoration:none;
}
.breadcrumb a:hover{
  color:var(--accent);
}
.text-guide{
  font-size:0.9rem;
  margin:0 0 1rem;
}
.text-green{ color:#388e3c; }
.text-yellow{ color:#fbc02d; }
.text-red{ color:#d32f2f; }
.section{
  margin-top:28px;
}
.section h2{
  margin:0 0 10px;
  font-size:clamp(18px,2vw,24px);
}
.section p{
  margin:0 0 12px;
  color:var(--muted);
  line-height:1.6;
}
.card{
  background:var(--card);
  border:1px solid var(--stroke);
  border-radius:12px;
  padding:16px;
}
.map-wrap{
  position:relative;
  border-radius:10px;
  overflow:hidden;
  border:1px solid var(--stroke);
}
#map{
  height:80vh;
  width:100%;
}
.map-controls{
  position:absolute;
  left:16px;
  top:16px;
  z-index:1000;
  display:flex;
  flex-direction:column;
  gap:8px;
  background:var(--panel);
  border:1px solid var(--stroke);
  border-radius:12px;
  padding:10px;
  box-shadow:0 10px 25px #0005;
}
.map-controls h3{
  margin:0;
  font-size:14px;
}
.map-controls button{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  padding:6px 10px;
  border-radius:8px;
  border:1px solid var(--stroke);
  background:var(--card);
  color:var(--ink);
  cursor:pointer;
  font-size:13px;
}
.map-controls button:hover{
  border-color:var(--accent);
}
.map-controls .trail-nav{
  display:flex;
  gap:8px;
}
.plant-marker,
.trail-marker{
  display:flex;
  align-items:center;
  justify-content:center;
  width:28px;
  height:28px;
  border-radius:50%;
  background:var(--panel);
  border:1px solid var(--stroke);
  font-size:16px;
  box-shadow:0 6px 16px #0004;
}
.plant-log-list{
  margin-top:16px;
  border-top:1px solid var(--stroke);
  padding-top:16px;
}
.plant-log-list__header{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
}
.plant-log-list__header h3{
  margin:0;
  font-size:18px;
}
.plant-log-list__header input{
  flex:1;
  min-width:200px;
  padding:8px 12px;
  border-radius:8px;
  border:1px solid var(--stroke);
  background:var(--card);
  color:var(--ink);
}
.plant-log-list__items{
  list-style:none;
  margin:0;
  padding:0;
  display:grid;
  gap:10px;
  max-height:260px;
  overflow:auto;
}
.plant-log-list__item{
  padding:10px 12px;
  border-radius:10px;
  border:1px solid var(--stroke);
  background:var(--panel);
  display:flex;
  flex-direction:column;
  gap:4px;
}
.plant-log-list__item button{
  align-self:flex-start;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--stroke);
  background:transparent;
  color:var(--ink);
  cursor:pointer;
  font-size:12px;
}
#reportForm{
  position:absolute;
  top:16px;
  right:16px;
  z-index:1000;
  background:var(--panel);
  border:1px solid var(--stroke);
  border-radius:12px;
  padding:16px;
  width:min(320px, 90vw);
  box-shadow:0 10px 25px #0005;
  display:none;
}
#reportForm label{
  display:block;
  margin-bottom:10px;
  font-size:14px;
  color:var(--muted);
}
#reportForm select,
#reportForm input,
#reportForm textarea{
  width:100%;
  margin-top:6px;
  padding:8px 10px;
  border-radius:8px;
  border:1px solid var(--stroke);
  background:var(--card);
  color:var(--ink);
  font-size:14px;
}
#reportForm textarea{
  min-height:80px;
  resize:vertical;
}
.form-actions{
  display:flex;
  gap:10px;
  margin-top:10px;
}
.form-actions button{
  flex:1;
  padding:8px 12px;
  border-radius:8px;
  border:1px solid var(--stroke);
  background:var(--accent);
  color:#0a0a0a;
  font-weight:600;
  cursor:pointer;
}
.form-actions button[type="button"]{
  background:transparent;
  color:var(--ink);
}
.small{
  font-size:13px;
  color:var(--muted);
}
.status-message{
  margin-top:12px;
}
@media (max-width: 700px){
  .panel{ padding:16px; }
  #map{ height:60vh; }
  #reportForm{
    position:static;
    width:100%;
    margin-top:12px;
  }
  .map-controls{
    position:static;
    margin:12px;
  }
}
</style>
<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "WebPage",
        "name": "Howker Ridge Plant Log Map",
        "description": "Interactive map to explore and record alpine plant observations along the Howker Ridge Trail.",
        "url": "https://nh48.info/projects/plant-map",
        "breadcrumb": {
          "@id": "https://nh48.info/projects/plant-map#breadcrumb"
        },
        "about": {
          "@id": "https://nh48.info/projects/plant-map#place"
        }
      },
      {
        "@type": "BreadcrumbList",
        "@id": "https://nh48.info/projects/plant-map#breadcrumb",
        "itemListElement": [
          {
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "https://nh48.info/"
          },
          {
            "@type": "ListItem",
            "position": 2,
            "name": "Plant Catalog",
            "item": "https://nh48.info/plant-catalog"
          },
          {
            "@type": "ListItem",
            "position": 3,
            "name": "Plant Log Map",
            "item": "https://nh48.info/projects/plant-map"
          }
        ]
      },
      {
        "@type": "Place",
        "@id": "https://nh48.info/projects/plant-map#place",
        "name": "Howker Ridge Trail",
        "description": "Steep ridge trail on Mount Madison in the White Mountains of New Hampshire.",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Randolph",
          "addressRegion": "NH",
          "addressCountry": "US"
        },
        "geo": {
          "@type": "GeoCoordinates",
          "latitude": 44.334951,
          "longitude": -71.266614
        }
      }
    ]
  }
</script>
</head>
<body data-route="plant-catalog" data-page="plant-map">
  <div id="nav-placeholder"></div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const navPlaceholder = document.getElementById('nav-placeholder');
      const activeRoute = document.body.dataset.route || document.body.dataset.page;

      if (navPlaceholder) {
        fetch('/pages/nav.html')
          .then(response => response.text())
          .then(html => {
            navPlaceholder.innerHTML = html;
            const links = navPlaceholder.querySelectorAll('.site-nav-links a');
            links.forEach(link => {
              const routes = (link.dataset.routes || link.dataset.route || '')
                .split(',')
                .map(value => value.trim())
                .filter(Boolean);

              if (routes.includes(activeRoute)) {
                link.classList.add('active');
                link.setAttribute('aria-current', 'page');
              }
            });
            if (window.NH48_I18N && window.NH48_I18N.refreshLangPicker) {
              window.NH48_I18N.refreshLangPicker();
            }
          })
          .catch(err => console.error('Failed to load navigation:', err));
      }
    });
  </script>

  <div class="wrap panel">
    <header>
      <h1>Howker Ridge Plant Log Map</h1>
      <p>Explore existing plant observations and add your own logs along the Howker Ridge Trail.</p>
    </header>

    <nav class="breadcrumb" aria-label="Breadcrumb">
      <a href="/">Home</a> &gt;
      <a href="/plant-catalog" data-route="plant-catalog">Howker Ridge Plant Catalog</a> &gt;
      <span>Plant Log Map</span>
    </nav>

    <section class="section card">
      <h2>Plant Log</h2>
      <p>Click the map to record a plant observation near the trail. Reports are reviewed before appearing on the map.</p>
      <div class="map-wrap">
        <div id="map" aria-label="Plant log map"></div>
        <div class="map-controls" aria-label="Trail controls">
          <h3>Trail panning</h3>
          <button type="button" id="trailZoomBtn">Zoom to trail</button>
          <div class="trail-nav">
            <button type="button" id="trailUpBtn" aria-label="Follow trail up">‚¨ÜÔ∏è Up trail</button>
            <button type="button" id="trailDownBtn" aria-label="Follow trail down">‚¨áÔ∏è Down trail</button>
          </div>
        </div>
        <form id="reportForm">
          <label>Plant species:
            <select id="speciesSelect" required>
              <option value="">Select a species</option>
            </select>
          </label>
          <label>Latitude:
            <input type="number" id="latInput" step="0.000001" required />
          </label>
          <label>Longitude:
            <input type="number" id="lngInput" step="0.000001" required />
          </label>
          <label>Elevation (ft, optional):
            <input type="number" id="elevInput" step="1" />
          </label>
          <label>Notes (optional):
            <textarea id="notesInput" maxlength="2000"></textarea>
          </label>
          <div class="form-actions">
            <button type="submit">Submit Log</button>
            <button type="button" id="cancelBtn">Cancel</button>
          </div>
          <p id="formMessage" class="small"></p>
        </form>
      </div>
      <div class="plant-log-list" aria-live="polite">
        <div class="plant-log-list__header">
          <h3>Plant entries</h3>
          <input type="search" id="plantSearch" placeholder="Search plant entries" aria-label="Search plant entries" />
        </div>
        <ul class="plant-log-list__items" id="plantList"></ul>
        <p class="small" id="plantListEmpty">No plant entries to show yet.</p>
      </div>
      <p id="statusMessage" class="small status-message" role="status"></p>
    </section>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha384-cxOPjt7s7Iz04uaHJceBmS+qpjv2JkIHNVcuOrM+YHwZOmJGBXI00mdUXEq65HTH" crossorigin=""></script>
  <script>
    const trackAnalytics = (name, params = {}) => {
      if (window.NH48Analytics?.track) {
        window.NH48Analytics.track(name, params);
        return;
      }
      if (window.NH48_INFO_ANALYTICS?.logEvent) {
        window.NH48_INFO_ANALYTICS.logEvent(name, params);
      }
    };

    const map = L.map('map', { zoomControl: false }).setView([44.336, -71.266], 14);
    const reportLayer = L.layerGroup().addTo(map);
    const speciesSelect = document.getElementById('speciesSelect');
    const reportForm = document.getElementById('reportForm');
    const latInput = document.getElementById('latInput');
    const lngInput = document.getElementById('lngInput');
    const elevInput = document.getElementById('elevInput');
    const notesInput = document.getElementById('notesInput');
    const formMessage = document.getElementById('formMessage');
    const statusMessage = document.getElementById('statusMessage');
    const cancelBtn = document.getElementById('cancelBtn');
    const trailZoomBtn = document.getElementById('trailZoomBtn');
    const trailUpBtn = document.getElementById('trailUpBtn');
    const trailDownBtn = document.getElementById('trailDownBtn');
    const plantSearch = document.getElementById('plantSearch');
    const plantList = document.getElementById('plantList');
    const plantListEmpty = document.getElementById('plantListEmpty');
    const speciesBySlug = new Map();
    let trailSegments = [];
    let trailRoute = [];
    let trailBounds = null;
    let trailIndex = 0;
    let reportCache = [];
    const trailFocusZoom = 15;

    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    });
    const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data: &copy; OpenStreetMap contributors, SRTM | Map style: &copy; OpenTopoMap'
    });
    const esriTopoLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri'
    });
    const esriSatelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri'
    });

    topoLayer.addTo(map);
    L.control.layers({
      'OpenTopoMap': topoLayer,
      'Esri Topo': esriTopoLayer,
      'OpenStreetMap': osmLayer,
      'Satellite': esriSatelliteLayer
    }, null, { position: 'topright' }).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    function distanceToSegment(point, start, end) {
      const x = point.lng;
      const y = point.lat;
      const x1 = start.lng;
      const y1 = start.lat;
      const x2 = end.lng;
      const y2 = end.lat;
      const dx = x2 - x1;
      const dy = y2 - y1;
      if (dx === 0 && dy === 0) {
        return Math.hypot(x - x1, y - y1);
      }
      const t = ((x - x1) * dx + (y - y1) * dy) / (dx * dx + dy * dy);
      const clamped = Math.max(0, Math.min(1, t));
      const projX = x1 + clamped * dx;
      const projY = y1 + clamped * dy;
      return Math.hypot(x - projX, y - projY);
    }

    function minDistanceToTrail(point) {
      let minDistance = Infinity;
      trailSegments.forEach(segment => {
        for (let i = 0; i < segment.length - 1; i += 1) {
          const dist = distanceToSegment(point, segment[i], segment[i + 1]);
          if (dist < minDistance) {
            minDistance = dist;
          }
        }
      });
      return minDistance;
    }

    function setFormMessage(message, isError = false) {
      formMessage.textContent = message;
      formMessage.style.color = isError ? '#f87171' : '';
    }

    function resetForm() {
      reportForm.reset();
      setFormMessage('');
    }

    function closeForm() {
      reportForm.style.display = 'none';
      resetForm();
    }

    function openForm(latlng) {
      latInput.value = latlng.lat.toFixed(6);
      lngInput.value = latlng.lng.toFixed(6);
      reportForm.style.display = 'block';
      statusMessage.textContent = '';
      setFormMessage('');
    }

    cancelBtn.addEventListener('click', () => {
      closeForm();
    });

    function getWaypointEmoji(props) {
      const name = (props.name || '').toLowerCase();
      const category = (props.category || '').toLowerCase();
      if (category.includes('waterfall') || name.includes('falls')) return 'üíß';
      if (category.includes('river') || category.includes('water') || name.includes('river')) return 'üåä';
      if (category.includes('view') || name.includes('view')) return 'üî≠';
      if (category.includes('summit') || name.includes('summit')) return '‚õ∞Ô∏è';
      if (category.includes('camp') || name.includes('camp')) return 'üèïÔ∏è';
      return 'üìç';
    }

    function addTrailLayers(data) {
      L.geoJSON(data, {
        style: feature => {
          if (feature.geometry.type === 'LineString') {
            return { color: '#38bdf8', weight: 4, opacity: 0.9 };
          }
          return {};
        },
        pointToLayer: (feature, latlng) => {
          const emoji = getWaypointEmoji(feature.properties || {});
          return L.marker(latlng, {
            icon: L.divIcon({
              className: 'trail-marker',
              html: emoji,
              iconSize: [28, 28],
              iconAnchor: [14, 14]
            })
          });
        },
        onEachFeature: (feature, layer) => {
          if (feature.geometry.type === 'Point') {
            const props = feature.properties || {};
            const details = [
              `<strong>${props.name || 'Waypoint'}</strong>`,
              props.category ? `<span>${props.category}</span>` : '',
              props.elevation_ft ? `<span>${props.elevation_ft} ft</span>` : '',
              props.description ? `<em>${props.description}</em>` : ''
            ].filter(Boolean).join('<br />');
            layer.bindPopup(details);
          }
        }
      }).addTo(map);

      trailSegments = data.features
        .filter(feature => ['LineString', 'MultiLineString'].includes(feature.geometry.type))
        .flatMap(feature => {
          if (feature.geometry.type === 'LineString') {
            return [feature.geometry.coordinates.map(([lng, lat]) => L.latLng(lat, lng))];
          }
          return feature.geometry.coordinates.map(line => line.map(([lng, lat]) => L.latLng(lat, lng)));
        });

      trailRoute = trailSegments.reduce((longest, segment) => (
        segment.length > longest.length ? segment : longest
      ), []);
      trailIndex = Math.floor(trailRoute.length / 2);
    }

    function loadTrail() {
      fetch('/data/howker-ridge.geojson', {
        mode: 'cors',
        headers: { 'Accept': 'application/json' }
      })
        .then(resp => resp.ok ? resp.json() : Promise.reject(resp))
        .then(data => {
          addTrailLayers(data);
          trailBounds = L.geoJSON(data).getBounds();
          map.fitBounds(trailBounds, { padding: [20, 20], maxZoom: 15 });
        })
        .catch(err => {
          console.error('Failed to load trail data', err);
        });
    }

    function loadSpecies() {
      fetch('/data/howker-plants', {
        mode: 'cors',
        headers: { 'Accept': 'application/json' }
      })
        .then(resp => resp.ok ? resp.json() : Promise.reject(resp))
        .then(data => {
          data.forEach(plant => {
            speciesBySlug.set(plant.id, plant);
            const option = document.createElement('option');
            option.value = plant.id;
            option.textContent = plant.common;
            speciesSelect.appendChild(option);
          });
        })
        .catch(err => {
          console.error('Failed to load plant list', err);
          setFormMessage('Unable to load plant list right now.', true);
        });
    }

    function renderReports(reports) {
      reportLayer.clearLayers();
      reports.forEach(report => {
        const plant = speciesBySlug.get(report.plantSlug);
        const plantName = plant ? plant.common : report.plantSlug;
        const notes = report.notes ? `<p>${report.notes}</p>` : '';
        const observed = report.observedAt ? new Date(report.observedAt).toLocaleString() : 'Unknown date';
        const popup = `
          <strong>${plantName}</strong><br />
          <span>${observed}</span>
          ${notes}
        `;
        L.marker([report.lat, report.lng], {
          icon: L.divIcon({
            className: 'plant-marker',
            html: 'üåø',
            iconSize: [28, 28],
            iconAnchor: [14, 14]
          })
        }).bindPopup(popup).addTo(reportLayer);
      });
    }

    function renderPlantList(reports) {
      const query = plantSearch.value.trim().toLowerCase();
      plantList.innerHTML = '';
      const filtered = reports.filter(report => {
        const plant = speciesBySlug.get(report.plantSlug);
        const name = (plant ? plant.common : report.plantSlug || '').toLowerCase();
        const notes = (report.notes || '').toLowerCase();
        return !query || name.includes(query) || notes.includes(query);
      });
      if (!filtered.length) {
        plantListEmpty.style.display = 'block';
        return;
      }
      plantListEmpty.style.display = 'none';
      filtered.forEach(report => {
        const plant = speciesBySlug.get(report.plantSlug);
        const plantName = plant ? plant.common : report.plantSlug;
        const observed = report.observedAt ? new Date(report.observedAt).toLocaleString() : 'Unknown date';
        const listItem = document.createElement('li');
        listItem.className = 'plant-log-list__item';
        listItem.innerHTML = `
          <strong>üåø ${plantName}</strong>
          <span class="small">${observed}</span>
          ${report.notes ? `<span class="small">${report.notes}</span>` : ''}
        `;
        const focusBtn = document.createElement('button');
        focusBtn.type = 'button';
        focusBtn.textContent = 'Focus on map';
        focusBtn.addEventListener('click', () => {
          map.setView([report.lat, report.lng], trailFocusZoom, { animate: true });
        });
        listItem.appendChild(focusBtn);
        plantList.appendChild(listItem);
      });
    }

    function loadReports() {
      const bounds = trailBounds || map.getBounds();
      const southWest = bounds.getSouthWest();
      const northEast = bounds.getNorthEast();
      const bbox = `${southWest.lng},${southWest.lat},${northEast.lng},${northEast.lat}`;
      fetch(`/api/howker/plant-reports?bbox=${bbox}`, {
        mode: 'cors',
        headers: { 'Accept': 'application/json' }
      })
        .then(resp => resp.ok ? resp.json() : Promise.reject(resp))
        .then(data => {
          const reports = data.reports || [];
          reportCache = reports;
          renderReports(reports);
          renderPlantList(reports);
        })
        .catch(err => {
          console.error('Failed to load plant reports', err);
        });
    }

    function updateTrailIndex(nextIndex) {
      if (!trailRoute.length) {
        return;
      }
      const maxIndex = trailRoute.length - 1;
      trailIndex = Math.max(0, Math.min(maxIndex, nextIndex));
      map.setView(trailRoute[trailIndex], trailFocusZoom, { animate: true });
    }

    trailZoomBtn.addEventListener('click', () => {
      if (trailBounds) {
        map.fitBounds(trailBounds, { padding: [30, 30], maxZoom: trailFocusZoom });
      }
      trailIndex = Math.floor(trailRoute.length / 2);
    });

    trailUpBtn.addEventListener('click', () => {
      updateTrailIndex(trailIndex + 10);
    });

    trailDownBtn.addEventListener('click', () => {
      updateTrailIndex(trailIndex - 10);
    });

    plantSearch.addEventListener('input', () => {
      renderPlantList(reportCache);
    });

    map.on('moveend', () => {
      loadReports();
    });

    map.on('click', event => {
      if (!trailSegments.length) {
        return;
      }
      const distance = minDistanceToTrail(event.latlng);
      if (distance > 0.001) {
        alert('Please record observations within roughly 100 meters of the Howker Ridge Trail.');
        return;
      }
      openForm(event.latlng);
    });

    reportForm.addEventListener('submit', event => {
      event.preventDefault();
      setFormMessage('');

      const plantSlug = speciesSelect.value;
      const lat = Number.parseFloat(latInput.value);
      const lng = Number.parseFloat(lngInput.value);
      const elevValue = elevInput.value ? Number.parseFloat(elevInput.value) : null;
      trackAnalytics('plant_report_submit_attempt', {
        has_species: Boolean(plantSlug),
        has_coordinates: Number.isFinite(lat) && Number.isFinite(lng)
      });

      if (!plantSlug) {
        setFormMessage('Please choose a plant species.', true);
        return;
      }

      if (!Number.isFinite(lat) || !Number.isFinite(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
        setFormMessage('Please enter valid latitude and longitude values.', true);
        return;
      }

      const payload = {
        plantSlug,
        lat,
        lng,
        elevationM: elevValue ? Math.round(elevValue * 0.3048) : null,
        notes: notesInput.value || null,
        observedAt: new Date().toISOString()
      };

      fetch('/api/howker/plant-reports', {
        method: 'POST',
        mode: 'cors',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(payload)
      })
        .then(resp => resp.ok ? resp.json() : Promise.reject(resp))
        .then(() => {
          closeForm();
          statusMessage.textContent = 'Log recorded! Reports appear after review and approval.';
          trackAnalytics('plant_report_submit_success', {
            plant_slug: plantSlug
          });
          loadReports();
        })
        .catch(err => {
          console.error('Failed to submit report', err);
          trackAnalytics('plant_report_submit_error', {
            plant_slug: plantSlug,
            error_type: Number.isFinite(err?.status) ? String(err.status) : 'submit_failed'
          });
          setFormMessage('Unable to submit right now. Please try again later.', true);
        });
    });

    loadTrail();
    loadSpecies();
    loadReports();
  </script>
</body>
</html>
